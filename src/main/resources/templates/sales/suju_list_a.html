<html layout:decorate="~{layout_page}">
<head>
    <style>
        #matListTb input, #matListTb textarea {
            width: 100px;
            height: 40px;
        }

    </style>
</head>
<th:block layout:fragment="content">

    <div class="layout-contents">
        <div class="page-title-wrap">
            <div class="left">
                <h2>수주 및 계획량 등록</h2>
                <a title="북마크" class="bookmark toggle">
                    내 메뉴
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
                <li>영업 관리</li>
                <li>수주 및 계획량 등록</li>
            </ul>
        </div>

        <section class="section">
            <div class="section-top">
                <div class="search-wrap">
                    <dl>
                        <dt>
                            <label for="cboDateKind">
                                검색 구분<span class="eq"></span>
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <select id="cboDateKind" name="cboDateKind">
                                    <option value="sales">수주일</option>
                                    <option value="delivery">납기일</option>
                                </select>
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            조회기간<span class="eq">*</span>
                        </dt>
                        <dd>
                            <ul class="date-box">
                                <li>
                                    <input type="date" id="srchStartDt" name="srchStartDt">
                                    <label for="srchStartDt" class="hide">시작일</label>
                                </li>
                                <li>
                                    <input type="date" id="srchEndDt" name="srchEndDt">
                                    <label for="srchEndDt" class="hide">종료일</label>
                                </li>
                            </ul>
                        </dd>
                    </dl>

                    <dl>
                        <dt>&nbsp;</dt>
                        <dd>
                            <li>
                                <a class="btn btn-delete" title="검색" id="btnSearch">
                                    <!--                                        class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                                    <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                    검색
                                </a>
                            </li>
                        </dd>
                    </dl>
                </div>
                <div class="button-wrap">
                    <ul>
                        <li>
                            <a class="btn btn-excell" title="등록" id="btnAddNew">
                                <img src="/images/icon/ico-plus.svg" alt="등록 아이콘">
                                등록
                            </a>
                        </li>
                        <li>
                            <a class="btn btn-delete" title="삭제" id="btnDelete">
                                <img src="/images/icon/ico-delete.svg" alt="삭제 아이콘">
                                삭제
                            </a>
                        </li>
                        <li>
                            <a class="btn btn-edit" title="수정" id="btnEdit">
                                <img src="/images/icon/ico-edit.svg" alt="수정 아이콘">
                                수정
                            </a>
                        </li>
                        <!--<li>
                            <a class="btn" title="엑셀 업로드" id="btnShowUpload">
                                엑셀 업로드
                            </a>
                        </li>
                        <li>
                            <a class="btn" title="양식 다운로드" id="btnDownloadTemplate">
                                양식 다운로드
                            </a>
                        </li>-->
                    </ul>
                </div>
            </div>
            <div class="container-fluid">
                <div id="theGrid" style="height: 730px;"></div>
            </div>
            <!--        <div class="grid_box">-->

            <!--            <div class="h-640" data-ax5grid="sujuGrid" ></div>-->
            <!--        </div>-->
        </section>
    </div>
    <script type="text/x-tmpl" id="sujuTemplate">
        <style>
            /* 아이템 테이블 전체 설정 */
            .item-table
            .SuJu_remark-table {
                width: 100%;
                border-collapse: collapse;
                table-layout: fixed;
                margin-top: 10px;
            }

            /* 헤더 셀 스타일 */
            .item-table th
            .SuJu_remark-table th {
                background-color: #EDEFF5;
                text-align: center;
                font-weight: bold;
                padding: 8px;
                border: 1px solid #ccc;
            }

            /* 바디 셀 스타일 */
            .item-table td
            .SuJu_remark-table td {
                padding: 6px;
                text-align: center;
                border: 1px solid #ccc;
            }

            /* 입력 필드 기본 스타일 */
            .item-table input {
                width: 100%;
                box-sizing: border-box;
                padding: 4px;
            }

            /* 품목 & 비고 왼쪽 정렬 */
            .item-table td:first-child,
            .item-table td:nth-child(6) {
                text-align: left;
            }

            /* 공통 버튼 스타일 */
            .item-table .btn.in_btn {
                display: inline-flex;
                justify-content: center;
                align-items: center;
                width: 32px;
                height: 32px;
                border-radius: 4px;
                padding: 0;
                border: 1px solid #B3B3B3;
                background-color: #fff;
                cursor: pointer;
                transition: background-color 0.2s;
                line-height: 0;
            }

            /* + 버튼 전용 스타일 */
            .item-table .btn.in_btn.plus img {
                width: 10px;
                height: 10px;
                display: block;
            }

            /* 공통 아이콘 버튼 이미지 (삭제, 검색 포함) */
            .item-table .btn.in_btn img {
                width: 12px;
                height: 12px;
                display: block;
                margin-right: 5px;
            }

            /* 공통 버튼 스타일 */
            .SuJu_remark-table .btn.in_btn {
                display: inline-flex;
                justify-content: center;
                align-items: center;
                width: 32px;
                height: 32px;
                border-radius: 4px;
                padding: 0;
                border: 1px solid #B3B3B3;
                background-color: #fff;
                cursor: pointer;
                transition: background-color 0.2s;
                line-height: 0;
            }

            /* + 버튼 전용 스타일 */
            .SuJu_remark-table .btn.in_btn.plus img {
                width: 10px;
                height: 10px;
                display: block;
            }

            /* 공통 아이콘 버튼 이미지 (삭제, 검색 포함) */
            .SuJu_remark-table .btn.in_btn img {
                width: 12px;
                height: 12px;
                display: block;
                margin-right: 5px;
            }

            .input-with-button {
                display: flex;
                gap: 4px; /* 버튼과 input 사이 여백 */
                align-items: center;
            }

            .input-with-button input {
                flex: 1; /* 나머지 영역 차지 */
                min-width: 0;
                padding: 4px;
            }

            .input-with-button .btn.in_btn {
                flex-shrink: 0;
            }

            .content_wrap.popup {
                display: flex;
                flex-direction: column;
                height: 100%;
            }

            .table-wrap {
                flex: 1;
                overflow-y: auto;
                padding-right: 5px;
            }

            .popup-button {
                flex-shrink: 0;
                padding: 10px;
                background: #fff;
                border-top: 1px solid #ddd;
            }

            .input-with-checkbox {
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .input-with-checkbox input[type="number"] {
                flex: 1;
                min-width: 0;
                padding: 4px;
            }

            .input-with-checkbox input[type="checkbox"] {
                flex-shrink: 0;
                width: 18px;
                height: 18px;
            }
        </style>
        <div class="content_wrap popup" id="div_excel_upload">
            <div class="table-wrap">
                <form id="sujuForm">
                    <table class="write-table">
                     <caption>수주등록 테이블</caption>
                     <input type="hidden" id="id" name="id">
                      <tbody>
                        <tr>
                          <th>수주일</th>
                          <td><input type="date" id="JumunDate" name="JumunDate"></td>
                          <th>출고예정일</th>
                          <td><input type="date" id="DueDate" name="DueDate"></td>
                        </tr>
                        <tr>
                          <th>상호(차주)</th>
                          <td>

                          <input id="cboCompany" name="Company_id" type="hidden">
                            <input class="form-control2" type="text" id="CompanyName" name="CompanyName"
                            placeholder="상호(차주) 검색 버튼을 클릭하여 검색하세요" readonly/>
                            <a class="btn btn-delete" title="검색" id="btnCompanySearch">
                                <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                상호 검색
                            </a>

                          </td>
                          <th>계약자</th>
                          <td><input type="text" name="contractnm" placeholder="계약자" ></td>
                        </tr>
                        <tr>
                          <th>주소</th>
                          <td><input type="text" name="contaddres" placeholder="주소" style="width:95%"></td>
                          <th>H.P</th>
                          <td><input type="text" name="hpnumber" placeholder="전화번호" inputmode="tel" autocomplete="tel" maxlength="14"></td>
                        </tr>
                        <tr>
                          <th>운수회사</th>
                          <td><input type="text" name="transcltnm" placeholder="운수회사" style="width:95%" ></td>
                          <th>색상</th>
                          <td><input type="text" name="matcolor" placeholder="색상"></td>
                        </tr>
                        <tr>
                          <th>차종</th>
                          <td>
                            <input type="hidden" name="suju_id" />
                            <input type="hidden" name="product_code"/>
                            <input type="text" name="txtProductName" placeholder="코드 또는 차종 입력 후 엔터" autocomplete="off" />
                            <input type="hidden" name="MaterialGroupName" />
                            <input type="hidden" name="Material_id" />
                            <a class="btn in_btn" title="품목 검색" id="btnProductSearch" >
                                <img src="/images/icon/btn-srch-black.svg" alt="검색 아이콘" />
                                차종 검색
                            </a>
                          </td>
                          <th>대수</th>
                          <td><input type="number" name="quantity" placeholder="대수"></td>
                        </tr>
                        <tr>
                          <th>수정 사양</th>
                          <td colspan="3"><textarea name="modifytext" style="height:60px;" placeholder="수정 사양"></textarea></td>
                        </tr>
                        <tr>
                          <th>기본 가격</th>
                          <td>
                            <input type="text" name="UnitPrice" style="text-align:right;width:95%;" placeholder="기본가격(별도)" >
                            <input type="hidden" name="originalUnitPrice" />
                          </td>
                          <th>옵션가격</th>
                          <td ><input type="text" name="TotalOptPrice" style="text-align:right;" placeholder="총 옵션가격"></td>
                        </tr>
                        <tr>
                          <th>D/C</th>
                          <td ><input type="text" name="dcPrice" style="text-align:right; width:95%;" placeholder="D/C" ></td>

                          <th>총가격</th>
                          <td><input type="text" name="Price" style="text-align:right;" placeholder="총가격(별도)"></td>
                        </tr>
                        <tr>
                         <th>계약가격</th>
                          <td ><input type="text" name="ContractPrice" style="text-align:right; width:95%;" placeholder="계약가격(포함)"></td>
                          <th></th>
                           <td></td>
                        </tr>
                        <tr>
                           <th>수주구분</th>
                            <td>
                                <select id="cboSujuType" name="SujuType"></select>
                            </td>
                          <th>상태</th>
                          <td ><input type="text" id="StateName" name="StateName" readonly placeholder="상태"></td>
                        </tr>
                      </tbody>
                    </table>
                    <!-- 옵션사항 + 특이사항 나란히 배치 -->
                    <div style="display:flex; gap:10px; margin-top:10px; width:100%;">
                      <!-- 옵션사항 테이블 -->
                      <table class="item-table" style="flex:1;">
                        <colgroup>
                          <col style="width: 30%">
                          <col style="width: 20%">
                          <col style="width: 30%">
                          <col style="width: 5%">
                        </colgroup>
                        <thead>
                          <tr id="itemHeaderRow">
                            <th>옵션사항</th>
                            <th>옵션가격</th>
                            <th>비고</th>
                            <th>
                              <a class="btn in_btn plus" id="addOptionRow" title="추가">
                                <img src="/images/icon/ico-plus.svg" alt="등록 아이콘" />
                              </a>
                            </th>
                          </tr>
                        </thead>
                        <tbody>
                          <!-- 템플릿 행 -->
                          <tr class="item-template-row" style="display: none;">
                            <td>
                             <input type="hidden" name="option_id" />
                             <input type="text" name="sjoption"  placeholder="옵션사항" />
                            </td>
                            <td><input type="text" name="optamt"  placeholder="옵션가격" /></td>
                            <td><input type="text" name="description" placeholder="비고"/></td>
                            <td class="al_c item_border">
                              <a class="btn in_btn" title="삭제" onclick="removeItemRow(this)">
                                <img src="/images/icon/ico-delete.svg" alt="삭제 아이콘" />
                              </a>
                            </td>
                          </tr>
                        </tbody>
                      </table>

                      <!-- 특이사항 테이블 -->
                      <table class="SuJu_remark-table notes-table" style="flex:1;">
                        <colgroup>
                          <col style="width:95%">
                          <col style="width:5%">
                        </colgroup>
                        <thead>
                          <tr>
                            <th>특이사항</th>
                            <th>
                              <a class="btn in_btn plus" id="addRemarkRow" title="추가">
                                <img src="/images/icon/ico-plus.svg" alt="등록 아이콘" />
                              </a>
                            </th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr class="remark-template-row" style="display: none;">
                            <td><input type="hidden" name="remark_id" />
                              <textarea name="sjremark" style="width:100%; height:60px;" placeholder="특이사항 입력"></textarea>
                            </td>
                            <td class="al_c item_border">
                              <a class="btn in_btn" title="삭제" onclick="removeRemarkRow(this)">
                                <img src="/images/icon/ico-delete.svg" alt="삭제 아이콘" />
                              </a>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                </form>
            </div>
            <div id="notUpdate" style="display:none;">*계획 또는 출하가 진행된 수주는 수정이 불가합니다.</div>
            <div class="popup-button">
                    <button type="button" class="btn-popup y_write_auth" id="btnPopSujuSave">저장</button>
                    <button type="button" class="btn-popup" id="modal-close-button">닫기</button>
            </div>
        </div>
    </script>

    <script type="text/x-tmpl" id="excelUploadTemplate">
        <div class="content_wrap popup" id="div_excel_upload">

            <div class="table-wrap">
                <form id="excelUploadForm">
                <table class="write-table">
                    <colgroup>
                        <col style="width: 25%;">
                        <col style="width: 75%;">
                    </colgroup>
                    <tbody>
                        <tr>
                            <th style="text-align: center">
                                <label>일자</label>
                            </th>
                            <td>
                                <input style="width:300px;" type="date" id="data_date" name="data_date" value=""  />
                            </td>
                        </tr>
                        <tr>
                            <th style="text-align: center">
                                <label>첨부파일</label>
                            </th>
                            <td>
                                <input style="width:300px; height: 44px;" type="file" id="upload_file" name="upload_file" enctype="multipart/form-data" accept=".xls, .xlsx"/>
                            </td>
                        </tr>
                    </tbody>
                </table>
                </form>
            </div>
            <div class="pt-2">
                <textarea id="upload_message" style='display:none;width:100%;height:150px;'></textarea>
            </div>

            </section>

            <div class="popup-button">
                <button type="button" class="btn-popup y_write_auth" id="btn_excel_save" >저장</button>
                <button type="button" class="btn-popup" id="modal-close-button">닫기</button>
            </div>
        </div>
    </script>
</th:block>

<th:block layout:fragment="scripts">
    <!--<th:block th:replace="/common/columns_setting :: columns_setting"></th:block>-->
    <th:block th:replace="/common/multiform_material :: multiform_material"></th:block>
    <th:block th:replace="/common/popup_company :: popup_company"></th:block>
    <th:block th:replace="/common/popup_project :: popup_project"></th:block>

    <script type="text/javascript">

        let isInternalFormatting = false;
        class SujuUploadPage {
            constructor() {
                this.url = '/api/sales/suju';
                this.grid = null;
                this.$btnEdit = $('#btnEdit');
                this.$btnAddNew = $('#btnAddNew');
                this.viewData = new wijmo.collections.CollectionView();
                this.init();

            }

            resetSujuListIndex() {
                this.sujuListIndex = 0;
            }

            nextSujuListIndex() {
                return this.sujuListIndex++;
            }

            init() {
                let _this = this;
                this.grid = new wijmo.grid.FlexGrid('#theGrid', {
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        {binding: 'CompanyName', header: ' 상호(차주)', width: 150, align: 'center'},
                        {binding: 'JumunDate', header: '수주일', width: 120, align: 'center'},
                        {binding: 'DueDate', header: '출고예정일', width: 120, align: 'center'},
                        {binding: 'product_name', header: '차종', width: 350},
                        {binding: 'SujuQty', header: '대수', width: 50, align: 'center', format: 'n0'},
                        {binding: 'UnitPrice', header: '기본가격', width: 150, align: 'right', format: 'n0'},
                        {binding: 'Price', header: '계약가격', width: 150, align: 'right', format: 'n0'},
                        {binding: 'matcolor', header: '색상', width: 200, align: 'center', format: 'n0'},
                        {binding: 'StateName', header: '작업상태', width: 100, align: 'center'},
                        {binding: 'ShipmentStateName', header: '출하상태', width: 100, align: 'center'},
                        {binding: 'vechidno', header: '차대번호', width: 200, align: 'center'},
                        {binding: 'contaddres', header: '주소', width: 270, align: 'center'},
                    ],
                    itemsSource: this.viewData, // 데이터를 설정할 배열
                });

                new FlexGridContextMenu(this.grid);
                this.grid.downloadFileName = '수주 내역';

                this.grid.hostElement.addEventListener('dblclick', function (e) {
                    let items = _this.grid.selectedItems;
                    if (items.length === 0) {
                        return false;
                    }
                    _this.$btnEdit.trigger('click');
                });

                let nowDate = CommonUtil.getYYYYMMDD();
                let dueDate = CommonUtil.getYYYYMMDD(10);

                //수주등록 클릭
                this.$btnAddNew.click(function (e) {
                    let defaultData = {
                        id: '',
                        mode: 'new',
                        JumunDate: nowDate,
                        DueDate: dueDate,
                    };
                    _this.showSujuForm(defaultData);
                });

                // 수주 수정 클릭
                this.$btnEdit.click(function (e) {
                    let selectedItems = _this.grid.selectedItems;
                    const it = _this.grid.selectedItems && _this.grid.selectedItems[0];

                    if (selectedItems.length === 1) {
                        window.selectedGridId = it.id;
                        let data = {
                            id: selectedItems[0].id,
                            action: 'detail'
                        };
                        let fnsuccess = function (result) {
                            result.data['mode'] = 'edit';
                            const selected = selectedItems[0];
                            // 기본 설정
                            if (selected.StateName) {
                                result.data['StateName'] = selected.StateName;
                            }
                            if (selected.State) {
                                result.data['State'] = selected.State;
                            }

                            // 출하 상태가 있다면 덮어쓰기
                            if (selected.ShipmentStateName) {
                                result.data['StateName'] = selected.ShipmentStateName;
                            }
                            _this.showSujuForm(result.data);
                        };
                        AjaxUtil.getAsyncData(_this.url + '/detail', data, fnsuccess);
                    } else {
                        Alert.alert('', '선택된 데이터가 없습니다.');
                    }

                });

                // 삭제 버튼
                $('#btnDelete').click(function (e) {
                    let items = _this.grid.selectedItems;
                    if (items.length > 0) {
                        Alert.confirm('', '삭제하시겠습니까?',
                            function () {
                                let id = items[0].id;
                                let state = items[0].State;
                                let ShipmentStateName = items[0].ShipmentStateName;
                                _this.deleteSujuData(id, state, ShipmentStateName);
                            },
                            function () {
                            }
                        );
                    } else {
                        Alert.alert('', '삭제할 항목을 선택해주세요.', function () {
                            $(this).focus();
                        });
                    }
                });

                // 엔터키 검색
                $('#keyword').on('keypress', function (e) {
                    if (e.keyCode === 13) {
                        _this.searchMainData();
                    }
                });
            }

            showSujuForm(data) {

                //sujuTemplate
                let _this = this;
                let content = tmpl('sujuTemplate', data);
                let $content = $(content);

                let modalContainer = null;
                if (data.mode === 'new') {
                    modalContainer = new PopupDraggable('등록');
                } else {
                    modalContainer = new PopupDraggable('수정');
                }
                modalContainer.open({width: 1300, height: 600, $content});

                // 제품검색
                let $btnProductSearch = $content.find('#btnProductSearch');
                let $sujuForm = $content.find('#sujuForm');

                let $cboSujuType = $content.find('#cboSujuType');

                if (data.mode === 'new') {
                    $btnProductSearch.removeAttr('disabled');
                }else {
                    // 버튼 숨김
                    $content.find('#btnProductSearch').hide();
                    $content.find('#btnCompanySearch').hide();
                    // 입력창 읽기전용 + 포커스/탭 방지 + 스타일(선택)
                    $content.find('input[name="txtProductName"]')
                        .prop('readonly', true)
                        .attr('tabindex', '-1')
                        .addClass('readonly'); // CSS로 배경/커서 처리 가능
                }
                page.resetRemarkListIndex();

                $content.find('#btnCompanySearch').click(function () {
                    let poppage = new PopCompComponent();
                    let $poppage = $(poppage);
                    let searchcallback = function (items) {
                        $content.find('#cboCompany').val(items.id);
                        $content.find('#CompanyName').val(items.compname);

                        // if ($Material_id.val() && $cboCompany.val()) {
                        //     tryShowPrice();
                        // }
                    };

                    poppage.show(searchcallback);
                });

                // 저장버튼
                let $btnPopSujuSave = $('#btnPopSujuSave');

                //수주구분
                AjaxUtil.fillSelectOptions($cboSujuType, 'system_code', 'choose', 'sales', 'suju_type');

                function sanitizeHeadForForm(data) {
                    const head = {...data};

                    // 폼 대상 아님: 리스트/객체 제거
                    delete head.items;
                    delete head.sjremark;

                    // null -> '', 숫자/불리언 -> 문자열
                    Object.keys(head).forEach(k => {
                        const v = head[k];
                        if (v == null) head[k] = '';
                        else if (typeof v === 'object') delete head[k]; // 혹시 남아있는 객체 방지
                        else if (typeof v !== 'string') head[k] = String(v);
                    });

                    return head;
                }

                setTimeout(() => {
                    // 상단 폼 바인딩(등록 모드면 보통 빈값)
                    FormUtil.BindDataSujuForm(sanitizeHeadForForm(data), $sujuForm);

                    if (data.mode === 'new') {
                        Remark.fill($content, []);      // 비우고
                        Remark.ensureMin($content, 2);
                    } else {
                        // ✅ 수정 모드면 DB 값 주입
                        populateOptionRows($content, data.items || []);
                        populateRemarkRows($content, data.sjremark || []);
                    }

                    const preFormatSelectors = [
                        'input[name="UnitPrice"]',
                        'input[name="Price"]',
                        'input[name="dcPrice"]',
                        'input[name="TotalOptPrice"]',
                        'input[name="ContractPrice"]',
                        '.item-table tbody input[name^="optamt_"]'
                    ];
                    preFormatSelectors.forEach(sel => {
                        $content.find(sel).each(function () {
                            const v = $(this).val();
                            if (v != null && v !== '') {
                                $(this).trigger('input');   // ↩️ 이미 등록된 input 핸들러로 포맷
                            }
                        });
                    });

                    // 계산/포맷 초기화
                    initOptionPricing($content);
                }, 100);

                if (data.StateName && data.StateName !== '수주') {
                    $('#btnPopSujuSave').hide();
                    $('#notUpdate')
                        .css('margin-top', '10px') // 조건 만족 시 margin-top 적용
                        .show();
                    $('.popup-button').css('margin-top', '10px');
                }

                if (data.SujuQty > 0) {
                    $SujuQty.val(data.SujuQty.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
                }


                // 수주등록 팝업 저장버튼 클릭
                $btnPopSujuSave.click(function (e) {

                    //수주일, 납기일 체크?
                    let data = FormUtil.extractForm($sujuForm);

                    if (!$('#cboCompany').val()) {
                        Alert.alert('', '판매처를 선택하세요.');
                        return;
                    }

                    if (!data.Material_id) {
                        Alert.alert('', '차종을 선택하세요.');
                        return;
                    }

                    Alert.confirm('', '저장하시겠습니까?', function () {
                        const items = [];
                        // 1) 옵션(items)은 기존대로
                        for (let i = 0; i < page.sujuListIndex; i++) {
                            const sjoption = data[`sjoption_${i}`] || '';
                            const optamt   = (data[`optamt_${i}`] || '0').replace(/,/g, '');
                            const desc     = data[`description_${i}`] || '';

                            if (sjoption || desc || Number(optamt) > 0) {
                                items.push({ sjoption, optamt, description: desc });
                            }
                        }
                        const sjremark = [];
                        Object.keys(data)
                            .filter(k => k.startsWith('sjremark_'))
                            .sort((a,b)=>parseInt(a.split('_')[1]||0)-parseInt(b.split('_')[1]||0))
                            .forEach(k => {
                                const remark = (data[k] || '').trim();
                                if (remark) sjremark.push({ sjremark: remark });
                            });

                        // 공통 정보 + 리스트 전송
                        const payload = {
                            id: data.id,
                            suju_id: data.suju_id,
                            spjangcd: data.spjangcd,
                            JumunDate: data.JumunDate,
                            DueDate: data.DueDate,
                            Company_id: data.Company_id,
                            CompanyName: data.CompanyName,
                            SujuType: data.SujuType,
                            contaddres: data.contaddres, //주소
                            contractnm:data.contractnm ,//계약자
                            hpnumber: data.hpnumber,    //핸드폰
                            transcltnm: data.transcltnm,    //운수회사
                            matcolor: data.matcolor,    //색상
                            txtProductName: data.txtProductName,
                            Material_id: (data.Material_id|| '0').replace(/,/g, ''),
                            modifytext:data.modifytext, //수정사양
                            UnitPrice:(data.UnitPrice || '0').replace(/,/g, ''), //기본가격(단가)
                            price:(data.Price || '0').replace(/,/g, ''), //총가격
                            dcPrice:(data.dcPrice || '0').replace(/,/g, ''), //dc 가격
                            optPrice: (data.TotalOptPrice || '0').replace(/,/g, ''),//총 옵션가격
                            quantity: (data.quantity || '0').replace(/,/g, ''), //대수
                            unitPriceChanged: (() => {
                                const ori = parseFloat(data[`originalUnitPrice`] || '0');
                                const cur = parseFloat((data[`UnitPrice`] || '0').replace(/,/g, ''));
                                return ori !== cur;
                            })(),
                            items: items,
                            sjremark: sjremark
                        };

                        AjaxUtil.postJsonData(_this.url + '/manual_save', payload, function (res) {
                            if (res.success) {
                                Notify.success("저장되었습니다.");
                                _this.searchMainData();
                                modalContainer.close();
                            } else {
                                Alert.alert('저장 실패', res.message || '알 수 없는 오류');
                            }
                        });

                    });

                });

                // 단가 정보 가져오기
                function tryShowPrice($row) {
                    const $form = $sujuForm;
                    const mat_pk = $row.find('input[name^="Material_id"]').val();
                    const company_id = $content.find('#cboCompany').val();
                    const JumunDate = $content.find('#JumunDate').val();

                    let url = _this.url + '/readPriceSuju';
                    let data = {
                        'mat_pk': mat_pk,
                        'company_id': company_id,
                        'JumunDate': JumunDate
                    };

                    if (mat_pk && company_id && JumunDate) {
                        let fnsuccess = function (result) {
                            let unitPrice = 0;
                            if (result && result.data && result.data.length > 0) {
                                unitPrice = parseFloat(result.data[0].UnitPrice) || 0;

                                $form.find('input[name="UnitPrice"]').val(unitPrice.toLocaleString()).trigger('input');
                                const $orig = $form.find('input[name="originalUnitPrice"]');
                                if (!$orig.val()) $orig.val(unitPrice.toLocaleString());
                            } else {
                                //단가 없음 처리도 헤더 기준
                                $form.find('input[name="UnitPrice"]').val('0').trigger('input');
                                $form.find('input[name="originalUnitPrice"]').val('0');
                            }
                            initOptionPricing($content);
                        };

                        AjaxUtil.getAsyncData(url, data, fnsuccess);
                    }
                }

                function populateOptionRows($scope, rows) {
                    const $tbody    = $scope.find('.item-table tbody');
                    const $template = $tbody.find('.item-template-row');

                    // 템플릿 숨김 + 기존 표시 행 제거(템플릿 제외)
                    $template.hide();
                    $tbody.find('tr:visible').not('.item-template-row').remove();

                    // 인덱스 초기화
                    if (typeof page.resetSujuListIndex === 'function') page.resetSujuListIndex();

                    // ✅ 최소 3행 보장
                    const total = Math.max(Array.isArray(rows) ? rows.length : 0, 3);

                    for (let i = 0; i < total; i++) {
                        const row = rows[i] || {}; // 부족분은 빈 행으로

                        const idx = page.nextSujuListIndex();
                        const $tr = $template.clone(true, true).removeClass('item-template-row').show();

                        // name 인덱싱: sjoption → sjoption_#, optamt → optamt_#, description → description_#
                        $tr.find('input,textarea,select').each(function () {
                            const $el  = $(this);
                            const base = ($el.attr('name') || '').replace(/_\d+$/, '');
                            if (base) $el.attr('name', `${base}_${idx}`);
                        });

                        // 숫자 안전 포맷팅(콤마 포함 문자열도 처리)
                        const toLocale = v => {
                            if (v === null || v === undefined || v === '') return '';
                            const num = parseFloat(String(v).replace(/,/g, ''));
                            return Number.isFinite(num) ? num.toLocaleString() : '';
                        };

                        // 값 세팅 (option_id hidden 포함)
                        $tr.find(`input[name="option_id_${idx}"]`).val(row.option_id || '');
                        $tr.find(`input[name="sjoption_${idx}"]`).val(row.sjoption || '');
                        $tr.find(`input[name="optamt_${idx}"]`).val(toLocale(row.optamt));
                        $tr.find(`input[name="description_${idx}"]`).val(row.description || '');

                        // 삭제 버튼 id 충돌 방지
                        $tr.find('a[title="삭제"]').attr('id', `btnDelItem_${idx}`);

                        $tbody.append($tr);
                    }
                }

                // --- 특이사항 테이블 주입 ---
                function populateRemarkRows($scope, rows) {
                    const $tbody    = $scope.find('.SuJu_remark-table tbody');
                    const $template = $tbody.find('.remark-template-row');

                    rows.forEach(row => {
                        const idx = page.nextRemarkIndex();
                        const $tr = $template.clone(true, true).removeClass('remark-template-row').show();

                        // name 인덱싱
                        $tr.find('textarea,input').each(function () {
                            const $el = $(this);
                            const base = ($el.attr('name') || '').replace(/_\d+$/, '');
                            if (base) $el.attr('name', `${base}_${idx}`);
                        });

                        // 값 세팅
                        $tr.find(`textarea[name="sjremark_${idx}"]`).val(row.sjremark || '');

                        // 삭제 버튼 id
                        $tr.find('a[title="삭제"]').attr('id', `btnDelRemark_${idx}`);

                        $tbody.append($tr);
                    });
                }

                // === 옵션 합계 + 상단 금액 계산 모듈 (showSujuForm 내부) ===
                function initOptionPricing($scope) {
                    // $scope: 보통 $content (없으면 fallback)
                    $scope = ($scope && $scope.length) ? $scope : $('#div_excel_upload');

                    function num(v) {
                        if (v == null) return 0;
                        const n = parseFloat(String(v).replace(/[^\d.-]/g, ''));
                        return Number.isFinite(n) ? n : 0;
                    }

                    function setVal($inp, value) {
                        if (!$inp || !$inp.length) return;
                        if (typeof formatNumberInput === 'function') {
                            formatNumberInput(String(value || 0), $inp[0]);
                        } else {
                            $inp.val(value ? Number(value).toLocaleString() : '');
                        }
                    }

                    // 1) 옵션행 optamt_ 합계 → TotalOptPrice
                    function recalcOptionTotal() {
                        let sum = 0;
                        $scope.find('.item-table tbody input[name^="optamt_"]').each(function () {
                            sum += num($(this).val());
                        });
                        setVal($scope.find('input[name="TotalOptPrice"]'), sum);
                        return sum;
                    }

                    // 2) 기본가격 + 옵션가격 = 총가격
                    // 3) 총가격 - D/C = 계약가격
                    function recalcHeaderTotals() {
                        const unit = num($scope.find('input[name="UnitPrice"]').val());       // 기본가격
                        const opts = num($scope.find('input[name="TotalOptPrice"]').val());   // 옵션가격(합계)
                        const dc   = num($scope.find('input[name="dcPrice"]').val());         // D/C

                        const price    = unit + opts;  // 총가격
                        const contract = price - dc;   // 계약가격

                        setVal($scope.find('input[name="Price"]'), price);
                        setVal($scope.find('input[name="ContractPrice"]'), contract);
                    }

                    // 이벤트 바인딩(중복 방지 .opt 네임스페이스)
                    function bindOptionEvents() {
                        // 옵션가격 입력 시: 합계→헤더 재계산
                        $scope
                            .off('input.opt change.opt', '.item-table tbody input[name^="optamt_"]')
                            .on('input.opt change.opt',  '.item-table tbody input[name^="optamt_"]', function () {
                                recalcOptionTotal();
                                recalcHeaderTotals();
                            });

                        // 행 추가 후 재계산 (기존 버튼 로직 뒤 실행)
                        $scope
                            .off('click.opt', '#addOptionRow')
                            .on('click.opt',  '#addOptionRow', function () {
                                setTimeout(function () {
                                    recalcOptionTotal();
                                    recalcHeaderTotals();
                                });
                            });

                        // 삭제 훅킹
                        window.removeItemRow = (function (orig) {
                            return function (el) {
                                if (typeof orig === 'function') orig(el);
                                else $(el).closest('tr').remove();
                                recalcOptionTotal();
                                recalcHeaderTotals();
                            };
                        })(window.removeItemRow);

                        // 상단 입력값 변화 시 총/계약가격 재계산
                        $scope
                            .off('input.head change.head', 'input[name="UnitPrice"], input[name="TotalOptPrice"], input[name="dcPrice"]')
                            .on('input.head change.head',  'input[name="UnitPrice"], input[name="TotalOptPrice"], input[name="dcPrice"]', function () {
                                recalcHeaderTotals();
                            });
                    }

                    // 외부에서도 재계산을 요청할 수 있게 노출(선택)
                    $scope.data('recalcOptionTotal', recalcOptionTotal);
                    $scope.data('recalcHeaderTotals', recalcHeaderTotals);

                    // 초기 1회 바인딩 & 계산
                    bindOptionEvents();
                    recalcOptionTotal();
                    recalcHeaderTotals();
                }

                // 숫자 포맷 (input 중 formatting)
                $content.on('input', 'input[name^="Price"], input[name^="UnitPrice"], input[name^="dcPrice"], input[name^="TotalOptPrice"],' +
                    'input[name^="ContractPrice"], input[name^="optamt_"]', function () {
                    if (isInternalFormatting) return;
                    isInternalFormatting = true;

                    const $this = $(this);
                    const input = this;
                    const raw = $this.val().replace(/[^0-9]/g, '');
                    const cursor = input.selectionStart;
                    const prevLength = input.value.length;

                    if (raw === '') {
                        $this.val('');
                    } else {
                        const formatted = Number(raw).toLocaleString();
                        $this.val(formatted);

                        const diff = formatted.length - prevLength;
                        input.setSelectionRange(cursor + diff, cursor + diff);
                    }

                    isInternalFormatting = false;
                });

                // 검색 버튼 클릭 시 팝업
                $content.on('click', 'a[title="품목 검색"]', function () {
                    const $row = $(this).closest('tr');

                    const $productInput = $row.find('input[name^="txtProductName"]');
                    const $productId = $row.find('input[name^="Material_id"]');
                    const $productCode = $row.find('input[name^="product_code"]');
                    const $materialGroup = $row.find('input[name^="MaterialGroupName"]');

                    const pop = new PopMatComponent();
                    pop.material_type = 'product,sangpum';

                    pop.show(function (item) {
                        $productInput.val(item.Name);
                        $productId.val(item.id);
                        $productCode.val(item.Code);
                        $materialGroup.val(item.group_name);
                        tryShowPrice($row);
                    });


                });

                $content.on('keydown', 'input[name^="txtProductName"]', function (e) {
                    if (e.key !== 'Enter' && e.keyCode !== 13) return;

                    e.preventDefault();

                    const $field = $(this);
                    const $row = $field.closest('tr');

                    const $productInput = $row.find('input[name^="txtProductName"]');
                    const $productId = $row.find('input[name^="Material_id"]');
                    const $productCode = $row.find('input[name^="product_code"]');

                    const keyword = $field.val().trim();
                    const pop = new PopMatComponent();
                    pop.material_type = 'product,sangpum';

                    const callback = function (item) {
                        $productId.val(item.id || '');
                        $productInput.val(item.Name || '');
                        $productCode.val(item.Code || '');
                        tryShowPrice($row);
                    };

                    if (!keyword) {
                        pop.focusAfterClose = $field[0];
                        pop.show(callback);
                        return;
                    }

                    const data = {
                        keyword: keyword,
                        spjangcd: sessionStorage.getItem('spjangcd')
                    };

                    const result = AjaxUtil.getSyncData('/api/popup/search_material', data);
                    const rows = result?.data || [];

                    if (rows.length === 1) {
                        callback(rows[0]);
                    } else {
                        pop.show(callback);
                        setTimeout(() => {
                            pop.$keyword.val(keyword);
                            pop.$btnMaterialSearch.trigger('click');
                        }, 50);
                    }
                });

                // 품목명 지우면 코드들도 같이 지워지게
                $content.on('input', 'input[name^="txtProductName"]', function () {
                    const $field = $(this);
                    const $row = $field.closest('tr');

                    const $productId = $row.find('input[name^="Material_id"]');
                    const $productCode = $row.find('input[name^="product_code"]');

                    if ($field.val().trim() === '') {
                        // 값이 비었을 경우 연관된 필드 초기화
                        $productId.val('');
                        $productCode.val('');
                    }
                });
                //옵션사항
                $content.find('#addOptionRow').click(function () {
                    const $tbody = $content.find('.item-table tbody');
                    const $template = $tbody.find('.item-template-row');

                    for (let i = 0; i < 3; i++) {
                        const $newRow = $template.clone().removeClass('item-template-row').show();
                        const index = page.nextSujuListIndex();
                        $newRow.find('input').each(function () {
                            const baseName = $(this).attr('name');
                            if (baseName) {
                                $(this).attr('name', `${baseName}_${index}`);
                            }
                        });

                        $newRow.find('a[title="삭제"]').attr('id', `btnDelItem_${index}`);
                        $tbody.append($newRow);
                    }
                });
                //특이사항
                $content.find('#addRemarkRow').click(function (){
                    const $tbody = $content.find('.SuJu_remark-table tbody');
                    const $template = $tbody.find('.remark-template-row');

                    for (let i = 0; i < 2; i++) {
                        const $newRow = $template.clone(true, true).removeClass('remark-template-row').show();

                        const index = page.nextRemarkIndex();   // ✅ 전용 인덱스 사용
                        $newRow.find('textarea').each(function () {
                            const baseName = (($(this).attr('name')) || '').replace(/_\d+$/, ''); // 뒤 인덱스 제거
                            if (baseName) $(this).attr('name', `${baseName}_${index}`);
                        });

                        $newRow.find('a[title="삭제"]').attr('id', `btnDelRemark_${index}`);     // 충돌 방지
                        $tbody.append($newRow);
                    }
                });

                $content.on('keydown', '.SuJu_remark-table tbody textarea[name^="sjremark"]', function (e) {
                    const key = e.key;
                    if (key !== 'ArrowUp' && key !== 'ArrowDown') return;
                    if (e.isComposing) return; // 한글 조합 중이면 무시
                    e.preventDefault();        // 커서 이동 방지(행 이동만)

                    const $cur   = $(this);
                    const $row   = $cur.closest('tr');
                    const $tbody = $row.closest('tbody');

                    // 템플릿 행 제외하고 위/아래 대상 찾기
                    const $targetRow = (key === 'ArrowDown')
                        ? $row.nextAll('tr:visible').not('.remark-template-row').first()
                        : $row.prevAll('tr:visible').not('.remark-template-row').first();

                    if ($targetRow.length) {
                        const $next = $targetRow.find('textarea[name^="sjremark"]');
                        if ($next.length) $next.focus().select();
                        return;
                    }

                    // 마지막 행에서 ↓ 눌렀을 때만 자동 추가
                    if (key === 'ArrowDown') {
                        // 추가 전 행 개수
                        const beforeCount = $tbody.find('tr:visible').not('.remark-template-row').length;

                        $content.find('#addRemarkRow').trigger('click');

                        // 새 행 생성 후, "첫 번째로 추가된 새 행"에 포커스
                        setTimeout(() => {
                            const $rows = $tbody.find('tr:visible').not('.remark-template-row');
                            const $newRow = $rows.eq(beforeCount); // 방금 추가된 첫 행
                            const $ta = $newRow.find('textarea[name^="sjremark"]');
                            if ($ta.length) $ta.focus().select();
                        }, 20);
                    }
                });


                // 포커스 자동 이동: Enter + 방향키(←→↑↓)
                $content.on('keydown', 'input', function (e) {
                    const key = e.key;

                    if (!['Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(key)) return;
                    e.preventDefault();

                    const $input = $(this);
                    const $row = $input.closest('tr');
                    const nameAttr = $input.attr('name') || '';

                    const focusOrder = [
                        'sjoption_',
                        'optamt_',
                        'description_',
                    ];

                    const currentIndex = focusOrder.findIndex(prefix => nameAttr.startsWith(prefix));
                    if (currentIndex === -1) return;

                    let $nextInput = null;

                    // ↔️ 좌우 이동
                    if (key === 'ArrowRight' && currentIndex < focusOrder.length - 1) {
                        const nextPrefix = focusOrder[currentIndex + 1];
                        $nextInput = $row.find(`input[name^="${nextPrefix}"]`);
                    } else if (key === 'ArrowLeft' && currentIndex > 0) {
                        const prevPrefix = focusOrder[currentIndex - 1];
                        $nextInput = $row.find(`input[name^="${prevPrefix}"]`);
                    }

                    // ↕️ 상하 이동
                    if (key === 'ArrowDown' || key === 'ArrowUp') {
                        const $targetRow = key === 'ArrowDown'
                            ? $row.nextAll('tr:visible').first()
                            : $row.prevAll('tr:visible').first();

                        const allowAutoAdd = ['txtProductName_', 'description_'];
                        const isAllowedField = allowAutoAdd.some(prefix => nameAttr.startsWith(prefix));

                        // ⬇️ 방향키 + 현재 행이 마지막 + 허용된 필드일 경우 → 행 자동 추가
                        if (key === 'ArrowDown' && !$targetRow.length && isAllowedField) {
                            $content.find('#addOptionRow').trigger('click');

                            setTimeout(() => {
                                const $rows = $content.find('.item-table tbody tr:visible').not('.item-template-row');
                                const $newRow = $rows.last();
                                const $newInput = $newRow.find('input[name^="txtProductName_"]');
                                if ($newInput.length) $newInput.focus().select();
                            }, 50);
                            return;
                        }
                        // 일반 상하 이동
                        $nextInput = $targetRow.find(`input[name^="${focusOrder[currentIndex]}"]`);
                    }

                    // ↵ Enter 키: 현재 행 내 다음 필드
                    if (key === 'Enter' && currentIndex < focusOrder.length - 1) {
                        const nextPrefix = focusOrder[currentIndex + 1];
                        $nextInput = $row.find(`input[name^="${nextPrefix}"]`);
                    } else if (key === 'Enter' && nameAttr.startsWith('description_')) {
                        const $nextRow = $row.nextAll('tr:visible').first();
                        if (!$nextRow.length) {
                            //console.log('다음 행 없음. 행 자동 추가 트리거.');
                            $content.find('#addOptionRow').trigger('click');

                            setTimeout(() => {
                                const $rows = $content.find('.item-table tbody tr:visible').not('.item-template-row');
                                const $newRow = $rows.last();
                                const $newInput = $newRow.find('input[name^="txtProductName_"]');
                                if ($newInput.length) $newInput.focus().select();
                            }, 50);
                            return;
                        } else {
                            $nextInput = $nextRow.find('input[name^="txtProductName_"]');
                        }
                    }

                    if ($nextInput && $nextInput.length) {
                        $nextInput.focus().select();
                    }
                });

                // 단일 필드라면
                $content.find('input[name="hpnumber"]')
                    .off('input')
                    .on('input', function () {
                        this.value = formatKoreanPhone(this.value);
                    })
                    .each(function () {
                        if ($(this).val()) this.value = formatKoreanPhone($(this).val());
                    });

                // 템플릿 행이 동적으로 추가되는 경우(이벤트 위임 권장)
                $content.on('input', 'input[name="hpnumber"]', function () {
                    this.value = formatKoreanPhone(this.value);
                });

                function ensureMinRemarkRows(min = 2) {
                    const $tbody   = $content.find('.SuJu_remark-table tbody');
                    const current  = $tbody.find('tr:visible').not('.remark-template-row').length;
                    const need     = Math.max(min - current, 0);

                    // addRemarkRow는 1클릭에 2행 추가하므로 클릭 횟수 보정
                    for (let i = 0; i < Math.ceil(need / 2); i++) {
                        $content.find('#addRemarkRow').trigger('click');
                    }
                }

            }//shwoSujuForm

            deleteSujuData(id, state, ShipmentStateName) {
                let _this = this;
                let url = _this.url + '/delete';
                let data = {'id': id, 'State': state, 'ShipmentStateName': ShipmentStateName}
                let fnsuccess = function (res) {
                    if (res.success) {
                        Notify.success('삭제되었습니다.');
                        _this.searchMainData();
                    } else {
                        Alert.alert('', res.message);
                    }
                };

                AjaxUtil.postAsyncData(url, data, fnsuccess);
            }

            // exportExcel() {
            //     var targetview = this.grid;
            //     targetview.exportExcel('수주내역.xls');
            // }

            searchMainData() {
                let _this = this;
                let date_kind = $('#cboDateKind').val();
                let start = $('#srchStartDt').val();
                let end = $('#srchEndDt').val();
                let url = this.url + '/read';

                let data = {
                    'date_kind': date_kind,
                    'start': start,
                    'end': end,
                    'action': 'read'
                };

                let fnsuccess = function (result) {
                    if (result != null) {
                        _this.viewData.sourceCollection = result.data;

                        if (window.selectedGridId) {
                            GridUtil.selectRowById(_this.grid, window.selectedGridId);
                            window.selectedGridId = null;
                        }
                    }
                };
                AjaxUtil.getAsyncData(url, data, fnsuccess);

            }

            // 엑셀 업로드 버튼
            showPopupExcelUpload(data) {
                let _this = this;
                let content = tmpl('excelUploadTemplate', data);
                let $content = $(content);
                $content.find('#data_date').val(data.data_date);
                $content.find('#day_index').val(data.day_index);

                //팝업공통모듈
                let modalContainer = new PopupDraggable('엑셀 업로드');
                modalContainer.open({width: 440, height: 220, $content});


                $content.find('#btn_excel_save').on('click', function () {
                    let $form = $content.find('#excelUploadForm');
                    Alert.confirm('',
                        '저장하시겠습니까?',
                        function () {
                            _this.saveSujuBulkData($form, modalContainer);
                            //modalContainer.close();
                        },
                        function () {
                        }
                    );
                });
            }

            // 엑셀 업로드 저장
            saveSujuBulkData($form, modalContainer) {
                let _this = this;
                var form = $('#excelUploadForm')[0];
                var formData = new FormData(form);

                formData['data_date'] = $('#srchStartDt').val();
                formData.append("uploadfile", $('#upload_file')[0].files[0].name);

                let result = AjaxUtil.postFileSyncData(_this.url + '/upload_save', formData);

                if (result) {
                    let message = '저장되었습니다.';
                    if (result.success) {
                        Notify.success(message);
                        _this.searchMainData();
                        modalContainer.close();
                    } else {

                        Alert.alert('', result.message);

                        /*let $divMessage = modalContainer.$content.find('#upload_message');
                        $divMessage.text(JSON.stringify(result.error_items));
                        $divMessage.show();*/
                    }
                }

            }

            downloadExcelForm() {
                let _this = this;
                //let url = '/api/files/mes_form?action=suju_upload';
                let fileName = "수주업로드양식.xlsx";
                let url = '/api/files/mes_form?file_name=' + fileName;
                /*
                let data = {
                    //'tableName' : tableName,
                    'file_name': "수주업로드양식.xlsx",
                };
                */
                AjaxUtil.downloadFile(url, fileName);
            }

        }

        // remark.js (showSujuForm 안에 넣어도 OK)
        const Remark = {
            resetIndex($scope) { $scope.data('__remarkIdx', 0); },
            nextIdx($scope)    { const n = ($scope.data('__remarkIdx')||0) + 1; $scope.data('__remarkIdx', n); return n; },

            clear($scope) {
                const $tb = $scope.find('.SuJu_remark-table tbody');
                $tb.find('tr:visible').not('.remark-template-row').remove();
            },

            fill($scope, rows = []) {
                const $tb  = $scope.find('.SuJu_remark-table tbody');
                const $tpl = $tb.find('.remark-template-row').hide();
                this.clear($scope); this.resetIndex($scope);

                rows.forEach(r => {
                    const idx = this.nextIdx($scope);
                    const $tr = $tpl.clone(true, true).removeClass('remark-template-row').show();
                    $tr.find('textarea,input').each(function(){
                        const $el = $(this);
                        const base = ($el.attr('name')||'').replace(/_\d+$/, '');
                        if (base) $el.attr('name', `${base}_${idx}`);
                    });
                    $tr.find(`input[name="remark_id_${idx}"]`).val(r.remark_id || '');
                    $tr.find(`textarea[name="sjremark_${idx}"]`).val(r.sjremark || '');
                    $tr.find('a[title="삭제"]').attr('id', `btnDelRemark_${idx}`);
                    $tb.append($tr);
                });
            },

            ensureMin($scope, min = 2) {
                const $tb = $scope.find('.SuJu_remark-table tbody');
                const cur = $tb.find('tr:visible').not('.remark-template-row').length;
                const need = Math.max(min - cur, 0);
                for (let i = 0; i < need; i++) {
                    const idx = this.nextIdx($scope);
                    const $tpl = $tb.find('.remark-template-row');
                    const $tr  = $tpl.clone(true, true).removeClass('remark-template-row').show();
                    $tr.find('textarea,input').each(function(){
                        const $el = $(this);
                        const base = ($el.attr('name')||'').replace(/_\d+$/, '');
                        if (base) $el.attr('name', `${base}_${idx}`).val('');
                    });
                    $tr.find('a[title="삭제"]').attr('id', `btnDelRemark_${idx}`);
                    $tb.append($tr);
                }
            },

            extract($scope) {
                const out = [];
                $scope.find('.SuJu_remark-table tbody tr:visible').not('.remark-template-row').each(function(){
                    const txt = ($(this).find('textarea[name^="sjremark_"]').val()||'').trim();
                    if (txt) out.push({ sjremark: txt });
                });
                return out;
            }
        };


        //행 삭제 함수
        function removeItemRow(el) {
            const $tbody = $(el).closest('tbody');
            const $rows = $tbody.find('tr:not(.item-template-row)');
            const $targetRow = $(el).closest('tr');

            if ($rows.length <= 3) {
                // 입력값이 있으면 초기화만 하고 리턴
                const hasData = $targetRow.find('input[type="text"], input[type="number"]').filter(function () {
                    return $(this).val().trim() !== '';
                }).length > 0;

                if (hasData) {
                    $targetRow.find('input[type="text"], input[type="number"]').val('');
                    // hidden 값도 초기화하고 싶다면 아래 추가
                    $targetRow.find('input[type="hidden"]').val('');
                }

                return;
            }

            // 4개 이상이면 정상 삭제
            $targetRow.remove();
        }

        function removeRemarkRow(el) {
            const $tbody = $(el).closest('tbody');
            const $rows = $tbody.find('tr:not(.item-template-row)');
            const $targetRow = $(el).closest('tr');

            if ($rows.length <= 2) {
                // 최소 1개는 남겨야 하므로 값만 초기화
                $targetRow.find('input[type="text"], input[type="number"], textarea').val('');
                $targetRow.find('input[type="hidden"]').val('');
                return;
            }

            // 2개 이상일 때는 정상 삭제
            $targetRow.remove();
        }

        function formatKoreanPhone(value) {
            const d = value.replace(/\D/g, '').slice(0, 12); // 숫자만, 최대 12자리(050x 등)

            // 대표번호(1588/1661/1800 등): 4-4
            if (/^(15|16|18)\d{0,}$/.test(d)) {
                if (d.length <= 4) return d;
                return d.slice(0, 4) + '-' + d.slice(4, 8);
            }

            // 프리픽스 길이 결정
            const prefixLen =
                d.startsWith('02') ? 2 :
                    (d.startsWith('050') && d.length >= 4) ? 4 : 3;

            if (d.length <= prefixLen) return d;

            const p = d.slice(0, prefixLen);
            const rest = d.slice(prefixLen);

            // 02 지역번호
            if (prefixLen === 2) {
                if (d.length <= 5)        return `${p}-${rest}`;                          // 02-XXX
                if (d.length <= 9)        return `${p}-${rest.slice(0,3)}-${rest.slice(3)}`; // 02-XXX-XXXX
                return `${p}-${rest.slice(0,4)}-${rest.slice(4,8)}`;                      // 02-XXXX-XXXX
            }

            // 050x(가상번호)
            if (prefixLen === 4) {
                if (rest.length <= 4)     return `${p}-${rest}`;
                return `${p}-${rest.slice(0,4)}-${rest.slice(4,8)}`;                      // 050x-XXXX-XXXX
            }

            // 그 외(010/011/016~019, 031~064, 070 등)
            if (rest.length <= 3)       return `${p}-${rest}`;
            if (d.length <= 10)         return `${p}-${rest.slice(0,3)}-${rest.slice(3,7)}`; // 3-3-4
            return `${p}-${rest.slice(0,4)}-${rest.slice(4,8)}`;                         // 3-4-4
        }

        // 유효성 체크(선택)
        function isValidKoreanPhone(value) {
            const d = value.replace(/\D/g, '');
            return /^(01[0-9]\d{7,8}|02\d{7,8}|0[3-9]\d{8}|070\d{8}|050\d{8,9}|1[568]\d{7})$/.test(d);
        }



        let page = null;

        $(document).ready(function (e) {

            page = new SujuUploadPage();


            $('#srchStartDt').val(CommonUtil.getYYYYMMDD(-7));
            $('#srchEndDt').val(CommonUtil.getYYYYMMDD());

            page.searchMainData();


            // 검색
            $('#btnSearch').click(function (e) {
                page.searchMainData();
            });

            // 양식 다운로드
            $('#btnDownloadTemplate').click(function (e) {
                page.downloadExcelForm();
            });

            // 엑셀 업로드 버튼
            $('#btnShowUpload').click(function (e) {
                let data = {
                    'id': '',
                    'data_date': CommonUtil.getYYYYMMDD(),
                };
                page.showPopupExcelUpload(data);
            });

            page.resetRemarkListIndex = function () { page.RemarkListIndex = 0; };
            page.nextRemarkIndex      = function () { return page.RemarkListIndex++; };
        })


    </script>

</th:block>
<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
</html>