<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<head>
  <style>
      .wj-header {
          text-align: center !important;
      }

      .input-with-button {
          display: flex;
          gap: 4px; /* ë²„íŠ¼ê³¼ input ì‚¬ì´ ì—¬ë°± */
          align-items: center;
      }

      .input-with-button input {
          flex: 1; /* ë‚˜ë¨¸ì§€ ì˜ì—­ ì°¨ì§€ */
          min-width: 0;
          padding: 4px;
      }

      .input-with-button .btn.in_btn {
          flex-shrink: 0;
          width: 40px;
      }

      .input-with-button button img, .btn img {
          margin-right: 1px;
      }

      .write-table input, select {
          width: auto;
      }

      /* 1366px ì´í•˜: ì˜¤ë¥¸ìª½ í¼ ê°ì¶”ê³ , ì„¹ì…˜ì„ ì„¸ë¡œ ìŠ¤íƒ + ìƒë‹¨ ì €ì¥/ì‚­ì œ/ASë²„íŠ¼ ìˆ¨ê¹€ */
      @media (max-width: 1366px) {
          .layout-contents > div[style*="display: flex"] > section:last-of-type {
              display: none !important;
          }

          .layout-contents > div[style*="display: flex"] {
              flex-direction: column !important;
          }

          .layout-contents > div[style*="display: flex"] > section {
              width: 100% !important;
          }

          /* ê¸°ë³¸ í¼ì€ ê°ì¶¤ (ëª¨ë‹¬ë¡œë§Œ ì‚¬ìš©) */
          .table-wrap {
              display: none !important;
          }

          /* ì‘ì€ í™”ë©´ì—ì„  ìƒë‹¨ ë²„íŠ¼ì€ ëª¨ë‹¬ ì „ìš© ë²„íŠ¼ìœ¼ë¡œ ëŒ€ì²´ */
          #btnSave, #btnDel, #btnASList {
              display: none !important;
          }

          .ax5modal[data-modal-els="root"] {
              height: 70dvh !important; /* ë™ì  ë·°í¬íŠ¸ */
              height: 70svh !important; /* iOS safe */
              height: 70vh !important; /* fallback */
              top: 5dvh !important; /* ì‚´ì§ ì•„ë˜ ë„ìš°ê¸°(ì›í•˜ë©´ 0) */
              display: flex;
              flex-direction: column;
          }

          /* ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì£¼ì…í•œ bodyì˜ inline height ë¬´ë ¥í™”: Flexë¡œ ì±„ìš°ê¸° */
          .ax5modal[data-modal-els="root"] .ax-modal-body {
              display: flex;
              flex-direction: column;
              height: calc(100vh - 40px) !important;
              overflow: hidden; /* ë°–ìœ¼ë¡œ íŠ€ëŠ” ê²ƒ ì°¨ë‹¨ */
          }

          /* ëª¨ë‹¬ ë‚´ë¶€ ë˜í¼: ì„¸ë¡œ í”Œë ‰ìŠ¤ */
          .ax5modal .modal-form-wrap {
              display: flex;
              flex-direction: column;
              flex: 1 1 auto;
              min-height: 0; /* ë‚´ë¶€ ìŠ¤í¬ë¡¤ í—ˆìš© */
          }

          /* í¼ë§Œ ìŠ¤í¬ë¡¤ */
          .ax5modal .modal-form-wrap > #basicForm_modal {
              flex: 1 1 auto;
              min-height: 0;
              overflow: auto;      /* ìŠ¤í¬ë¡¤ì€ ì—¬ê¸°ì„œë§Œ */
              padding: 8px;        /* ì¸ë¼ì¸ ëŒ€ì‹  CSS */
              box-sizing: border-box;
          }

          /* í•˜ë‹¨ ë²„íŠ¼ ê³ ì • ì˜ì—­ (sticky) */
          .ax5modal .modal-form-wrap .modal-actions {
              position: sticky;
              bottom: 0;
              left: 0;
              right: 0;
              width: 100%;
              z-index: 1;
              background: #fff;            /* ìŠ¤í¬ë¡¤ ì‹œ ë‚´ìš©ê³¼ ë¶„ë¦¬ */
              border-top: 1px solid #e5e7eb;
              padding: 8px;
              display: flex;               /* ë²„íŠ¼ ì •ë ¬ */
              justify-content: center;
              gap: 8px;
              flex-wrap: wrap;             /* ë²„íŠ¼ ë§ìœ¼ë©´ ì¤„ë°”ê¿ˆ */
              text-align: center;          /* í˜¹ì‹œ í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ì •ë ¬ */
          }

          .modal-form-wrap {
              --fs-base: 13.5px;
              --fs-label: 13px;
              --cell-pad-y: 6px;
              --cell-pad-x: 8px;
              --input-h: 34px;
          }
          .btn-aslist {
              color: #fff !important;
              background-color: #337ab7 !important;
              border-color: #337ab7 !important;
              font-size: revert;
          }

      }

      /* ê³µí†µ(ëª¨ë‹¬ ë‚´ë¶€ ê¸°ë³¸ê°’) */
      .modal-form-wrap {
          --fs-base: 14px; /* ê¸°ë³¸ ë³¸ë¬¸ í°íŠ¸ */
          --fs-label: 13px; /* ë¼ë²¨/í…Œì´ë¸” í—¤ë” */
          --cell-pad-y: 8px; /* ì…€ ìƒí•˜ íŒ¨ë”© */
          --cell-pad-x: 10px; /* ì…€ ì¢Œìš° íŒ¨ë”© */
          --input-h: 36px; /* ì¸í’‹/ì…€ë ‰íŠ¸ ë†’ì´ */

          font-size: var(--fs-base);
      }

      .modal-form-wrap .write-table th,
      .modal-form-wrap .write-table td {
          padding: var(--cell-pad-y) var(--cell-pad-x);
      }

      .modal-form-wrap input[type="text"],
      .modal-form-wrap input[type="date"],
      .modal-form-wrap select {
          height: var(--input-h);
      }

      @media (max-width: 768px) {
          #basicForm_modal .write-table {
              font-size: 0.92rem;
          }

          #basicForm_modal input[type="text"],
          #basicForm_modal input[type="date"],
          #basicForm_modal select {
              height: 32px;
          }

          #basicForm_modal textarea {
              min-height: 96px; /* ë„ˆë¬´ ì‘ì•„ì§€ì§€ ì•Šê²Œ */
          }
      }

      /* íƒœë¸”ë¦¿/ëª¨ë°”ì¼(â‰¤1024px) : í•œ ë‹¨ê³„ ë” íƒ€ì´íŠ¸ */
      @media (max-width: 1024px) {
          .modal-form-wrap {
              --fs-base: 13px;
              --fs-label: 12.5px;
              --cell-pad-y: 5px;
              --cell-pad-x: 8px;
              --input-h: 32px;
          }
      }

      /* iPad Pro landscape ê°™ì€ 1366Ã—1024 ì¼€ì´ìŠ¤ì— ë³´ìˆ˜ì ìœ¼ë¡œ */
      @media (max-width: 1366px) and (max-height: 1024px) {
          .modal-form-wrap {
              --fs-base: 13px;
              --cell-pad-y: 5px;
              --input-h: 32px;
          }
      }

      /* ultra-small(â‰¤768px) : ëª¨ë°”ì¼ì— ë§ì¶° ë” íƒ€ì´íŠ¸ */
      @media (max-width: 768px) {
          .modal-form-wrap {
              --fs-base: 12.5px;
              --fs-label: 12px;
              --cell-pad-y: 4px;
              --cell-pad-x: 6px;
              --input-h: 30px;
          }
      }

      /* ë¼ë²¨ë§Œ ë¯¸ì„¸ ì¡°ì • */
      .modal-form-wrap .write-table th label {
          font-size: var(--fs-label);
      }

      /* í•„ìš” ì‹œ ê¸´ í…ìŠ¤íŠ¸ ì…ë ¥ì„ ìœ„í•œ textarea ê¸°ë³¸ ë†’ì´ */
      @media (max-width: 1024px) {
          .modal-form-wrap textarea#fixText {
              min-height: 96px;
          }
      }
  </style>
</head>
<th:block layout:fragment="content">
  <div class="layout-contents">
    <!-- Page Title -->
    <div class="page-title-wrap">
      <div class="left">
        <h2>AS ì°¨ëŸ‰ì ê²€ê´€ë¦¬</h2>
        <a title="ë¶ë§ˆí¬" class="bookmark toggle">
          ë‚´ë©”ë‰´
        </a>
        <button type="button" class="btn-default pull-right mr-1" id="btnHeaderCompress" title="í™”ë©´ í™•ëŒ€/ì¶•ì†Œ">
          <i class="fas fa-compress" id="iCompress"></i>
        </button>
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
        <li>ê¸°ì¤€ì •ë³´</li>
        <li>AS ì°¨ëŸ‰ì ê²€ê´€ë¦¬</li>
      </ul>
    </div>

    <div style="display: flex; gap: 5px">
      <section class="section" style="width: 40%;">
        <div class="section-top">
          <div class="search-wrap">
            <!--<dl>
              <dt>
                <label>ì œì›</label>
              </dt>
              <dd>
                <div class="srch-box">
                  <select id="cboSpcmngno" name="cboSpcmngno">

                  </select>
                </div>
              </dd>
            </dl>-->
            <dl>
              <dt>
                <label>ë“±ë¡ ë²ˆí˜¸</label>
              </dt>
              <dd>
                <div class="srch-box">
                  <input type="text" id="txtRegno" name="txtRegno">
                </div>
              </dd>
            </dl>

            <dl>
              <dt><span class="eq"></span></dt>
              <dd>
                <li>
                  <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch">
                    <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                    ê²€ìƒ‰
                  </a>
                </li>
              </dd>
            </dl>
          </div>

        </div>
        <div class="container-fluid">
          <p id="selectedItem"></p>
          <div id="theGrid"></div>
        </div>
      </section>
      <section style="width: 60%;">
        <div class="section-top">
          <div class="search-wrap">
            <ul>
              <li>
                <button type="button" class="btn-default" id="btnASList" name="btnASList"
                        style="height: 36px; width:115px;">as ì ‘ìˆ˜ì„ íƒ
                </button>
              </li>
              <li>
                <button type="button" class="btn-default" id="btnNew" name="btnNew"
                        style="height: 36px; width:115px;"><i
                    class="fas fa-plus"></i>ì‹ ê·œë“±ë¡
                </button>
              </li>

              <li>
                <button type="button" class="btn-default y_write_auth" id="btnSave"
                        style="float:none; height: 36px; width:115px;">
                  <i class="fas fa-save"></i>ì €ì¥
                </button>
              </li>

              <li>
                <button type="button" class="btn-danger y_write_auth" id="btnDel"
                        style="float:none; height: 36px; width:115px;"><i
                    class="fas fa-trash"></i>ì‚­ì œ
                </button>
              </li>
            </ul>
          </div>
        </div>

        <div class="table-wrap" style=" overflow-x: auto;">
          <form id="basicForm">
            <table class="write-table" style="width: 100%; border-collapse: collapse;">
              <caption style="text-align: left; margin-bottom: 8px;">ë“±ë¡í…Œì´ë¸”</caption>
              <input type="hidden" id="id" name="id"/>
              <input type="hidden" id="as_id" name="as_id"/>
              <tbody>
              <tr>
                <th>
                  <label for="regno"><span class="eq">*</span>ë“±ë¡ë²ˆí˜¸</label>
                </th>
                <td>
                  <input id="regno" name="regno" placeholder="ë“±ë¡ë²ˆí˜¸" readonly>
                </td>
                <th>
                  <label for="itemcode"><span class="eq">*</span>ì°¨ëŸ‰ëª…ì¹­(ì°¨ì¢…)</label>
                </th>
                <td>
                  <input type="hidden" id="vechidno" name="vechidno">
                  <input type="hidden" id="Material_id" name="Material_id">
                  <input id="itemcode" name="itemcode" placeholder="ì°¨ëŸ‰ëª…ì¹­(ì°¨ì¢…)" readonly>
                </td>
              </tr>
              <tr>
                <th>
                  <label for="regdate"><span class="eq">*</span>ë“±ë¡ì¼ì</label>
                </th>
                <td>
                  <input type="date" id="regdate" name="regdate">
                </td>
                <th>
                  <label for="fixdate">ì ê²€/ì •ë¹„ì˜ë¢°ì¼ì</label>
                </th>
                <td>
                  <input type="date" id="fixdate" name="fixdate">
                </td>
              </tr>
              <tr>
                <th>
                  <label for="fixText">ì‘ì—…ë‚´ìš©</label>
                </th>
                <td colspan="5">
                  <textarea id="fixText" name="fixText" placeholder="ì‘ì—…ë‚´ìš©" style="height:90px;"></textarea>
                </td>
              </tr>
              <tr>
                <th>
                  <label for="partgroup">ë¶€í’ˆêµ¬ë¶„</label>
                </th>
                <td>
                  <input type="text" id="partgroup" name="partgroup" placeholder="ë¶€í’ˆêµ¬ë¶„">
                </td>
                <th>
                  <label for="partqty">ë¶€í’ˆìˆ˜ëŸ‰</label>
                </th>
                <td>
                  <input type="text" id="partqty" name="partqty" placeholder="ë¶€í’ˆìˆ˜ëŸ‰">
                </td>
              </tr>
              <tr>
                <th>
                  <label for="uamt">ë¶€í’ˆë‹¨ê°€</label>
                </th>
                <td>
                  <input type="text" id="uamt" name="uamt" placeholder="ë¶€í’ˆë‹¨ê°€">
                </td>
                <th>
                  <label for="totamt">í•©ê³„</label>
                </th>
                <td>
                  <input type="text" id="totamt" name="totamt" placeholder="í•©ê³„">
                </td>
              </tr>
              <tr>
                <th>
                  <label for="workpay">ê³µì„</label>
                </th>
                <td>
                  <input type="text" id="workpay" name="workpay" placeholder="ê³µì„">
                </td>
                <th>
                  <label for="pernm">ì •ë¹„ê¸°ì‚¬</label>
                </th>
                <td>
                  <input type="text" id="pernm" name="pernm" placeholder="ì •ë¹„ê¸°ì‚¬">
                </td>
              </tr>
              <tr>
                <th>
                  <label for="mileage">ì£¼í–‰ê±°ë¦¬</label>
                </th>
                <td>
                  <input type="text" id="mileage" name="mileage" placeholder="ì£¼í–‰ê±°ë¦¬ -KM">
                </td>
                <th>
                  <label for="endflag">ì¶œê³ ì²˜ë¦¬</label>
                </th>
                <td style="display:flex;justify-content:center;align-items:center;">
                  <input type="checkbox" id="endflag" name="endflag">
                </td>
              </tr>
              </tbody>
            </table>
          </form>
        </div>
      </section>
    </div>
  </div> <!--//layout-contents end -->

</th:block>
<th:block layout:fragment="scripts">
  <th:block th:replace="/as/popup_as_list :: popup_ASList"></th:block>
  <script type="text/javascript">
    class ASManagementPage {
      constructor() {
        this.grid = null;
        this.viewData = new wijmo.collections.CollectionView();
        this.url = '/api/definition/ASManagement';
        this._onOpenByClick    = (e) => this._openFromHitTest(e);
        this._onOpenByDblClick = (e) => this._openFromHitTest(e);
        this.init();
      }

      init() {
        let _this = this;
        this.grid = new wijmo.grid.FlexGrid('#theGrid', {
          selectionMode: wijmo.grid.SelectionMode.Row,
          headersVisibility: wijmo.grid.HeadersVisibility.Column,
          autoGenerateColumns: false,
          showMarquee: true,
          isReadOnly: true,
          formatItem: (sender, e) => {
            if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
              e.cell.style.textAlign = 'center';
            }
          },
          columns: [
            {binding: 'id', header: 'id', visible: false},
            {binding: 'as_id', header: 'id', visible: false},
            {binding: 'regdate', header: 'ë“±ë¡ì¼ì', width: 120, align: 'center'},
            {binding: 'regno', header: 'ë“±ë¡ë²ˆí˜¸', width: 120, align: 'left'},
            {binding: 'itemcode', header: 'ì°¨ëŸ‰ëª…ì¹­', width: 180, align: 'center'},
            {binding: 'fixdate', header: 'ì ê²€ì¼ì', width: 120, align: 'center'},
            {binding: 'fixtext', header: 'ì‘ì—…ë‚´ìš©', width: 210, align: 'left'},
            {binding: 'pernm', header: 'ì •ë¹„ê¸°ì‚¬', width: 100, align: 'center'},
          ],
          itemsSource: this.viewData, // ë°ì´í„°ë¥¼ ì„¤ì •í•  ë°°ì—´
        });

        new FlexGridContextMenu(this.grid);
        this.grid.downloadFileName = 'ASì°¨ëŸ‰ì ê²€ê´€ë¦¬';

        this.bindGridOpenHandler();

        //ë¯¸ë””ì–´ì¿¼ë¦¬/ë¦¬ì‚¬ì´ì¦ˆ ì‹œ í•¸ë“¤ëŸ¬ ì¬ë°”ì¸ë”©
        const mq = window.matchMedia('(max-width: 1366px)');
        const rebind = () => this.bindGridOpenHandler();
        if (mq.addEventListener) mq.addEventListener('change', rebind);
        else mq.addListener(rebind); // êµ¬í˜• ë¸Œë¼ìš°ì € ëŒ€ì‘
        window.addEventListener('resize', rebind);

        $('#txtRegno').on('keypress', function (e) {
          if (e.keyCode === 13) {
            _this.searchMainData();
          }
        });

        $('#btnASList').click(function () {
          let poppage = new PopASListComponent();
          let $poppage = $(poppage);
          let searchcallback = function (items) {
            console.log('items : ', items);
            document.getElementById('as_id').value = items.asid;
            document.getElementById('Material_id').value = items.Material_id;
            document.getElementById('itemcode').value = items.itemcode;
            document.getElementById('regno').value = items.regno;
            document.getElementById('vechidno').value = items.vechidno;
          };

          poppage.show(searchcallback);
        });
      }

      _openFromHitTest(e) {
        const ht = this.grid.hitTest(e);
        if (!ht || ht.cellType !== wijmo.grid.CellType.Cell) return;

        let item = (ht.row > -1 && this.grid.rows[ht.row]) ? this.grid.rows[ht.row].dataItem : null;
        if (!item && this.grid.selectedItems.length === 1) item = this.grid.selectedItems[0];
        if (!item) return Alert.alert('', 'ì„ íƒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');

        AjaxUtil.getAsyncData(this.url + '/detail', { id: item.id }, (result) => {
          if (!result || !result.data) return Alert.alert('ì˜¤ë¥˜', 'ìƒì„¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          const d = result.data;

          const isSmall = window.matchMedia('(max-width: 1366px)').matches;

          if (isSmall) {
            // ì‘ì€ í™”ë©´: ëª¨ë‹¬
            openFormModal('edit', d);

            // ëª¨ë‹¬ DOMì´ ë¶™ì€ ë’¤ì— í¬ë§·/í•©ê³„ ì ìš©
            setTimeout(() => {
              const $ctx = $('#basicForm_modal');

              // ìš°ì„  ê°’ ì±„ìš°ê¸°(í•„ìš” ì‹œ fillFormë¡œ ëŒ€ì²´)
              // fillForm($ctx, d);  // ì´ë¯¸ ì“°ì‹ ë‹¤ë©´ ì´ í•œ ì¤„ë¡œ ëª¨ë‘ ë°”ì¸ë”©
              $ctx.find('#itemcode').val(d.itemcode || '');
              // ìˆ«ì í•„ë“œ í¬ë§·
              formatNumberInput(d.partqty ?? '', '#partqty', $ctx);
              formatNumberInput(d.uamt    ?? '', '#uamt',    $ctx);
              formatNumberInput(d.totamt  ?? '', '#totamt',  $ctx);
              formatNumberInput(d.workpay ?? '', '#workpay', $ctx);

              // ë§ˆì¼ë¦¬ì§€ëŠ” km ì „ìš© í¬ë§·
              $ctx.find('#mileage').val(d.mileage ?? '');
              formatMileageInput($ctx.find('#mileage'));

              // í•©ê³„ ë³´ì •
              calculateTotal($ctx);

              // í¬ì»¤ìŠ¤
              $ctx.find('#spcmngno').focus();
            }, 0);

          } else {
            // í° í™”ë©´: ì˜¤ë¥¸ìª½ í¼
            const $ctx = $('#basicForm');
            fillForm($ctx, d);
            $ctx.find('#itemcode').val(d.itemcode || '');
            // ìˆ«ì í•„ë“œ í¬ë§·
            formatNumberInput(d.partqty ?? '', '#partqty', $ctx);
            formatNumberInput(d.uamt    ?? '', '#uamt',    $ctx);
            formatNumberInput(d.totamt  ?? '', '#totamt',  $ctx);
            formatNumberInput(d.workpay ?? '', '#workpay', $ctx);

            // ë§ˆì¼ë¦¬ì§€ëŠ” km ì „ìš© í¬ë§·
            formatMileageInput($ctx.find('#mileage'));

            // í•©ê³„ ë³´ì •
            calculateTotal($ctx);
          }
        });
      }

      // í´ë¦­/ë”ë¸”í´ë¦­ í•¸ë“¤ëŸ¬ ë™ì  ìŠ¤ìœ„ì¹­
      bindGridOpenHandler() {
        const host = this.grid.hostElement;
        const isSmall = window.matchMedia('(max-width: 1366px)').matches;

        // ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€: ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ í•´ì œ
        host.removeEventListener('click',    this._onOpenByClick);
        host.removeEventListener('dblclick', this._onOpenByDblClick);

        if (isSmall) {
          // ì‘ì€ í™”ë©´: í´ë¦­ìœ¼ë¡œ ì˜¤í”ˆ
          host.addEventListener('click', this._onOpenByClick, false);
        } else {
          // í° í™”ë©´: ë”ë¸”í´ë¦­ìœ¼ë¡œ ì˜¤í”ˆ
          host.addEventListener('dblclick', this._onOpenByDblClick, false);
        }
      }

      searchMainData() {
        let _this = this;

        let data = {
          'txtRegno': $('#txtRegno').val()
        }

        let fnsuccess = function (result) {
          if (result != null) {
            _this.viewData = new wijmo.collections.CollectionView(result.data);
            _this.grid.itemsSource = _this.viewData;
          }
        };

        AjaxUtil.getAsyncData(_this.url + '/read', data, fnsuccess);
      }

      //ì €ì¥
      saveMainData($form) {
        const _this = this;
        const $ctx = $form && $form.length ? $form : getActiveForm();

        if (!$ctx.find('#regno').val()) {
          Alert.alert('', 'ë“±ë¡ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
          return;
        }
        if (!$ctx.find('#Material_id').val()) {
          Alert.alert('', 'ì°¨ëŸ‰ëª…ì¹­(ì°¨ì¢…)ì„ ì„ íƒí•˜ì„¸ìš”.');
          return;
        }
        if (!$ctx.find('#itemcode').val()) {
          Alert.alert('', 'ì°¨ëŸ‰ëª…ì¹­(ì°¨ì¢…)ì„ ì…ë ¥í•˜ì„¸ìš”.');
          return;
        }

        const data = {
          id: $ctx.find('#id').val(),
          as_id: $ctx.find('#as_id').val(),
          regno: $ctx.find('#regno').val(),
          itemcode: $ctx.find('#itemcode').val(),
          Material_id: $ctx.find('#Material_id').val(),
          regdate: $ctx.find('#regdate').val(),
          vechidno: $ctx.find('#vechidno').val(),
          fixdate: $ctx.find('#fixdate').val(),
          fixText: $ctx.find('#fixText').val(),
          partgroup: $ctx.find('#partgroup').val(),
          partqty: $ctx.find('#partqty').val(),
          uamt: $ctx.find('#uamt').val().replace(/,/g, ''),
          totamt: $ctx.find('#totamt').val().replace(/,/g, ''),
          workpay: $ctx.find('#workpay').val().replace(/,/g, ''),
          pernm: $ctx.find('#pernm').val(),
          mileage: $ctx.find('#mileage').val().replace(/,/g, ''),
          endflag: $ctx.find('#endflag').is(':checked') ? '0' : '1',
        };

        Alert.confirm('', 'ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
          AjaxUtil.postJsonData(_this.url + '/save', data, function (result) {
            if (result && result.success) {
              Alert.alert('', 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
              _this.searchMainData();
              // ëª¨ë‹¬ì´ë©´ ë‹«ê¸°
              const isModal = $ctx.attr('id') === 'basicForm_modal';
              if (isModal) {
                const modal = $ctx.data('modal');
                if (modal && typeof modal.close === 'function') modal.close();
              } else {
                $('#btnNew').click(); // ê¸°ë³¸ í¼ ì´ˆê¸°í™”
              }
            } else {
              Alert.alert('', 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
          });
        });
      };

      deleteASData(id, opts = {}) {
        if (!id) {
          Alert.alert('', 'ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ëª©ë¡ì—ì„œ í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.');
          return;
        }

        Alert.confirm('', 'ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
          const url = this.url + '/delete';
          const data = {id};

          AjaxUtil.postAsyncData(url, data, (res) => {
            if (res && res.success) {
              Notify.success('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
              this.searchMainData();
              if (opts.closeModal) {
                const $ctx  = opts.$ctx || $('#basicForm_modal');
                const modal = $ctx.data('modal');
                if (modal && typeof modal.close === 'function') {
                  modal.close();
                }
              } else {
                // ì¼ë°˜ í™”ë©´ì—ì„œëŠ” ê¸°ì¡´ì²˜ëŸ¼ ì´ˆê¸°í™”
                $('#btnNew').click();
              }
            } else {
              Alert.alert('', res && res.message ? res.message : 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
          });
        });
      }
    }

    function getActiveForm() {
      return $('#basicForm_modal').length ? $('#basicForm_modal') : $('#basicForm');
    }

    function fillForm($root, d) {
      $root.find('#id').val(d.id || '');
      $root.find('#as_id').val(d.as_id || '');
      $root.find('#regno').val(d.regno || '');
      $root.find('#Material_id').val(d.Material_id || '');
      $root.find('#itemcode').val(d.ItemCode || '');
      $root.find('#regdate').val(d.regdate || d.regdate || '');
      $root.find('#fixdate').val(d.fixdate || d.fixdate || '');
      $root.find('#fixText').val(d.fixtext || '');
      $root.find('#partgroup').val(d.partgroup || '');
      $root.find('#partqty').val(d.partqty || '');
      $root.find('#uamt').val(d.uamt || '');
      $root.find('#totamt').val(d.totamt || '');
      $root.find('#workpay').val(d.workpay || '');
      $root.find('#pernm').val(d.pernm || '');
      $root.find('#mileage').val(d.mileage || '');
      $root.find('#endflag').prop('checked', d.endflag === '0');
    }

    // 1) ë·°í¬íŠ¸ ê¸°ë°˜ ëª¨ë‹¬ í¬ê¸° ê³„ì‚°(ì•„ì´íŒ¨ë“œ ëŒ€ì‘ í¬í•¨)
    function calcModalSize() {
      const vw = (window.visualViewport && window.visualViewport.width) || window.innerWidth;
      const vh = (window.visualViewport && window.visualViewport.height) || window.innerHeight;

      const OUTER_GAP_W = 40;  // ì¢Œìš° ì—¬ë°±
      const OUTER_GAP_H = 40;  // ìƒí•˜ ì—¬ë°±

      // ìµœëŒ€ì¹˜ ì œí•œ + í™”ë©´ ê°€ìš© í¬ê¸° ë°˜ì˜
      const w = Math.min(vw - OUTER_GAP_W, 900);
      const h = Math.min(vh - OUTER_GAP_H, 700);

      return {w, h, bodyH: h - 96};
    }

    // 2) ëª¨ë‹¬ ì˜¤í”ˆ (ì‹ ê·œ/ìˆ˜ì • ê³µí†µ)
    function openFormModal(mode /* 'new' | 'edit' */, initialData) {
      const title = (mode === 'new') ? 'ì‹ ê·œë“±ë¡' : 'ìˆ˜ì •';
      const modal = new PopupDraggable(title);

      // ì¤‘ë³µ ëª¨ë‹¬ ë°©ì§€
      try {
        $('#basicForm_modal').closest('.modal-form-wrap').remove();
      } catch (e) {
      }

      // í¼ í´ë¡ 
      const $clone = $('#basicForm').clone(true, true);
      $clone.attr('id', 'basicForm_modal');
      $clone.data('isModal', true);
      $clone.data('modal', modal);

      // ì‹ ê·œ ì´ˆê¸°í™” / ìˆ˜ì • ë°”ì¸ë”©
      if (mode === 'new') {
        $clone[0].reset();
        $clone.find('input[type="hidden"]').val('');
        const today = new Date();
        $clone.find('#regdate').val(CommonUtil.formatYYYYMMDD(today));
        $clone.find('#fixdate').val(CommonUtil.formatYYYYMMDD(today));
      } else if (initialData) {
        fillForm($clone, initialData);
      }

      // ëª¨ë‹¬ ì»¨í…ì¸  ë˜í¼
      // const $wrap = $('<div class="modal-form-wrap" style="padding:8px;"></div>').append($clone);
      const $wrap = $('<div class="modal-form-wrap"></div>').append($clone);

      // ===== ëª¨ë‹¬ ì „ìš© ë²„íŠ¼ ì˜ì—­ (AS ì ‘ìˆ˜ì„ íƒ + ì €ì¥/ì‚­ì œ/ë‹«ê¸°) =====
      // const $actions = $('<div style="margin-top:12px; display:flex; justify-content:center; flex-wrap:wrap; gap:8px;"></div>');
      const $actions = $('<div class="modal-actions" style="margin-top:12px; display:flex; justify-content:center; flex-wrap:wrap; gap:8px;"></div>');

      // AS ì ‘ìˆ˜ì„ íƒ (ëª¨ë‹¬ ë‚´ë¶€)
      const $btnASListInModal = $('<button type="button" class="btn-default btn-aslist">AS ì ‘ìˆ˜ì„ íƒ</button>');
      $btnASListInModal.on('click', function () {
        let poppage = new PopASListComponent();
        poppage.show(function (items) {
          if (!items) return;
          $clone.find('#as_id').val(items.asid || '');
          $clone.find('#Material_id').val(items.Material_id || '');
          $clone.find('#itemcode').val(items.itemcode || '');
          $clone.find('#regno').val(items.regno || '');
        });
      });
      $actions.append($btnASListInModal);

      // ì €ì¥
      const $btnSaveModal = $('<button type="button" class="btn-default btn-aslist">ì €ì¥</button>');
      $btnSaveModal.on('click', function () {
        page.saveMainData($clone);
      });
      $actions.append($btnSaveModal);

      // ì‚­ì œ(ìˆ˜ì • ëª¨ë“œì¼ ë•Œë§Œ)
      let $btnDeleteModal = null;
      if (mode === 'edit') {
        $btnDeleteModal = $('<button type="button" class="btn-danger">ì‚­ì œ</button>');
        $btnDeleteModal.on('click', function () {
          const id = $clone.find('#id').val();
          page.deleteASData(id);
          const modalInst = $clone.data('modal');
          if (modalInst && typeof modalInst.close === 'function') modalInst.close();
        });
        $actions.append($btnDeleteModal);
      }

      // ë‹«ê¸°
      const $btnCloseModal = $('<button type="button" class="btn-popup">ë‹«ê¸°</button>');
      $actions.append($btnCloseModal);

      $wrap.append($actions);

      // ===== ìµœì´ˆ ì˜¤í”ˆ: ë™ì  í¬ê¸° ì ìš© =====
      const size0 = calcModalSize();
      modal.open({width: size0.w, height: size0.h, $content: $wrap});

      // í¬ì»¤ìŠ¤ ì§„ì…
      setTimeout(() => {
        $clone.find('#regno').focus();
      }, 0);

      // ===== ë¦¬ì‚¬ì´ì¦ˆ ëŒ€ì‘ (rAF ë””ë°”ìš´ìŠ¤ + visualViewport) =====
      let resizeRAF = null;
      const doResize = () => {
        const s = calcModalSize();
        if (typeof modal.resize === 'function') modal.resize(s.w, s.h);
      };
      const onResize = () => {
        if (resizeRAF) cancelAnimationFrame(resizeRAF);
        resizeRAF = requestAnimationFrame(doResize);
      };

      window.addEventListener('resize', onResize);
      if (window.visualViewport) window.visualViewport.addEventListener('resize', onResize);

      // ì •ë¦¬ í•¨ìˆ˜
      const cleanupResize = () => {
        if (resizeRAF) cancelAnimationFrame(resizeRAF);
        window.removeEventListener('resize', onResize);
        if (window.visualViewport) window.visualViewport.removeEventListener('resize', onResize);
      };

      // ë‹«ê¸° ë²„íŠ¼ í•¸ë“¤ëŸ¬ (ë¦¬ìŠ¤ë„ˆ í•´ì œ í¬í•¨)
      $btnCloseModal.on('click', function () {
        cleanupResize();
        if (typeof modal.close === 'function') modal.close();
      });

      // ëª¨ë‹¬ ìì²´ onClose í›…ì—ì„œë„ ì•ˆì „í•˜ê²Œ ì •ë¦¬
      const prevOnClose = modal.onClose;
      modal.onClose = () => {
        cleanupResize();
        if (typeof prevOnClose === 'function') prevOnClose();
      };

      // (ì„ íƒ) ì˜¤í”ˆ ì§í›„ í•œ ë²ˆ ë” ë³´ì • â€” ëª¨ë°”ì¼ í‚¤ë³´ë“œ/íˆ´ë°” ëŠ¦ê²Œ ë°˜ì˜ ì‹œ
      setTimeout(doResize, 50);
    }

    // âœ… ê³µí†µ ìˆ«ì í¬ë§· (ì½¤ë§ˆ) - ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜
    function formatNumberInput(inputValue, targetSelector, $ctx) {
      const $scope = ($ctx && $ctx.length) ? $ctx : getActiveForm();
      let cleaned = (inputValue || '').toString().replace(/[^0-9]/g, '').replace(/,/g, '');
      let formatted = cleaned.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      $scope.find(targetSelector).val(formatted);
    }

    // âœ… ë§ˆì¼ë¦¬ì§€ ì „ìš©: '123,456 km' + ì»¤ì„œ ' km' ì• ê³ ì •
    function formatMileageInput($input) {
      let val = $input.val() || '';
      let digits = val.replace(/[^0-9]/g, '');
      let formatted = digits ? digits.replace(/\B(?=(\d{3})+(?!\d))/g, ',') + ' km' : '';
      $input.val(formatted);

      // ë¹ˆ ê°’ì´ë©´ ì»¤ì„œ ê³ ì • ë¶ˆí•„ìš”
      if (!formatted) return;

      // í•­ìƒ ' km' ì•ì— ì»¤ì„œ ê³ ì • (ìŒìˆ˜ ë°©ì–´)
      const pos = Math.max(0, formatted.length - 3);
      const el = $input[0];
      if (el.setSelectionRange) el.setSelectionRange(pos, pos);
    }

    // âœ… í•©ê³„ ê³„ì‚° (ì¸ì ì—†ìœ¼ë©´ í™œì„± í¼)
    function calculateTotal($ctx) {
      const $scope = ($ctx && $ctx.length) ? $ctx : getActiveForm();
      if (!$scope || !$scope.length) return;

      let qty  = ($scope.find('#partqty').val() || '').replace(/[^0-9]/g, '');
      let uamt = ($scope.find('#uamt').val()    || '').replace(/[^0-9]/g, '');
      let total = (qty && uamt) ? (parseInt(qty, 10) * parseInt(uamt, 10)) : 0;

      formatNumberInput(total.toString(), '#totamt', $scope);
    }

    /* ======================
       ì´ë²¤íŠ¸ ë°”ì¸ë”© (ìœ„ì„)
    ====================== */

    // ğŸ”¹ ë§ˆì¼ë¦¬ì§€: ì „ìš© í•¸ë“¤ëŸ¬ë§Œ ë°”ì¸ë”© (ì¤‘ë³µ ê¸ˆì§€)
    $(document).on('input focus', '#basicForm #mileage, #basicForm_modal #mileage', function () {
      formatMileageInput($(this));
    });

    // ğŸ”¹ ì½¤ë§ˆ í¬ë§·(ë‹¨ê°€/í•©ê³„/ê³µì„)
    $(document).on('input', '#basicForm #uamt, #basicForm_modal #uamt, #basicForm #totamt, #basicForm_modal #totamt, #basicForm #workpay, #basicForm_modal #workpay', function () {
      formatNumberInput(this.value, '#' + this.id, getActiveForm());
    });

    // ğŸ”¹ ìˆ˜ëŸ‰/ë‹¨ê°€ ë³€ê²½ ì‹œ í•©ê³„ ì¬ê³„ì‚°
    $(document).on('input', '#basicForm #partqty, #basicForm_modal #partqty, #basicForm #uamt, #basicForm_modal #uamt', function () {
      // ì…ë ¥ í¬ë§·
      formatNumberInput(this.value, '#' + this.id, getActiveForm());
      // í•©ê³„
      calculateTotal();
    });

    $(document).ready(function (e) {

      // ===== ë°˜ì‘í˜•: ì˜¤ë¥¸ìª½ ë²„íŠ¼ì˜ì—­ì„ ì™¼ìª½ ìƒë‹¨ìœ¼ë¡œ ì´ë™ =====
      const ResponsiveToolbar = (function () {
        const BREAKPOINT = 1366;
        const $sections = $('.layout-contents > div[style*="display: flex"]').children('section');
        const $leftSectionTop = $sections.eq(0).find('.section-top');
        const $rightSectionTop = $sections.eq(1).find('.section-top');

        // ì›ìœ„ì¹˜ë¥¼ ê¸°ì–µí•  placeholder
        const $placeholder = $('<div id="rightSectionTop_ph" style="display:none;"></div>');
        let moved = false;

        function apply() {
          if (window.innerWidth <= BREAKPOINT && !moved) {
            // ì›ìœ„ì¹˜ ê¸°ì–µ
            $rightSectionTop.after($placeholder);
            // ì™¼ìª½ ìƒë‹¨ìœ¼ë¡œ ë²„íŠ¼ì˜ì—­ ì´ë™ (ê²€ìƒ‰ë°” ì•„ë˜ì— ë¶™ì„)
            $rightSectionTop.appendTo($leftSectionTop);
            moved = true;
          } else if (window.innerWidth > BREAKPOINT && moved) {
            // ì›ìœ„ì¹˜ë¡œ ë³µê·€
            $placeholder.after($rightSectionTop);
            $placeholder.remove();
            moved = false;
          }
        }

        $(window).on('resize', apply);
        apply();
        return {apply};
      })();

      page = new ASManagementPage();

      let today = new Date();
      let monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

      $('#regdate').val(CommonUtil.formatYYYYMMDD(today));
      $('#fixdate').val(CommonUtil.formatYYYYMMDD(today));

      AjaxUtil.fillSelectOptions($('#cboSpcmngno'), 'material_group', 'all', false);
      AjaxUtil.fillSelectOptions($('#spcmngno'), 'material_group', 'choose', false);

      page.searchMainData();

      // ê²€ìƒ‰
      $('#btnSearch').click(function (e) {
        e.preventDefault();
        page.searchMainData();
      });

      $('#btnSave').off('click').on('click', function (e) {
        e.preventDefault();
        page.saveMainData(getActiveForm());
      });

      $('#btnDel').off('click').on('click', function (e) {
        e.preventDefault();
        const id = getActiveForm().find('#id').val() || $('#id').val();
        page.deleteASData(id);
      });
      // ë‹¨ê°€ë‚˜ ìˆ˜ëŸ‰ì´ ë°”ë€” ë•Œë§ˆë‹¤ í•©ê³„ ì¬ê³„ì‚°
      $('#partqty, #uamt').on('input', function () {
        // ì…ë ¥ í•„ë“œ í¬ë§· ì ìš©
        formatNumberInput(this.value, '#' + this.id);
        // í•©ê³„ ì¬ê³„ì‚°
        calculateTotal();
      });
      //ì´ˆê¸°í™”
      $('#btnNew').off('click').on('click', function (e) {
        e.preventDefault();
        if (window.innerWidth <= 1366) {
          openFormModal('new');
        } else {
          // í° í™”ë©´: ê¸°ì¡´ ì¸ë¼ì¸ ì´ˆê¸°í™” ìœ ì§€
          $('#basicForm')[0].reset();
          $('input[name="endflag"]').prop('checked', false);
          $('#basicForm').find('input[type="hidden"]').val('');
          const today = new Date();
          $('#regdate').val(CommonUtil.formatYYYYMMDD(today));
          $('#fixdate').val(CommonUtil.formatYYYYMMDD(today));
        }
      });

    });
  </script>

</th:block>
<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
</html>