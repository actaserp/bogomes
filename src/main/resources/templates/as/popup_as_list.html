<th:block th:fragment="popup_ASList">
  <script type="text/x-tmpl" id="popup_asListSearchTemplate">

    <div class="content_wrap popup">

        <section class="section" style="padding-top: 10px;">

            <div class="section-top">
                <div class="search-wrap" style="text-align: left;">
                    <dl>
                        <dt>
                            <label for="srch_vechidno">
                                차대번호
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <input type="text" id="srch_vechidno" name="srch_vechidno"
                                style="width:160px;" placeholder="차대번호" />
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            <label for="srch_owner">
                                차주
                            </label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <input type="text" id="srch_owner" name="srch_owner"
                                style="width:160px;" placeholder="차주" />
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>&nbsp;</dt>
                        <dd>
                            <li>
                                <a class="btn btn-delete" title="검색" id="btnCompSearch">
                                    <!--                                        class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                                    <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                    검색
                                </a>
                            </li>
                        </dd>
                    </dl>
                </div>
                <div class="container-fluid">
                    <div id="theGrid2" style="height: 300px;"></div>
                </div>
            </div>
        </section>
            <div class="popup-button">
                <button type="button" class="btn-popup" id="btnSelect" ><span data-commonCd="선택">선택</span></button>
                <button type="button" class="btn-popup" id="btn-search-close"><span data-commonCd="닫기">닫기</span></button>
            </div>
    </div>
  </script>

  <script type="text/javascript">

    class PopASListComponent {
      static currentInstance = null;

      constructor() {
        if (PopASListComponent.currentInstance) {
          PopASListComponent.currentInstance.close(); // 이전 인스턴스 닫기
        }
        PopASListComponent.currentInstance = this;

        this.grid = null;
        this.viewData = new wijmo.collections.CollectionView();
        this.selectedItem = null;
        this.callback = null;
        this.modalContainer = new PopupDraggable('AS 접수선택');
        this.$btnCompSearch = null;
        this.$btnSelect = null;
      }

      searchDataBind() {
        let _this = this;
        let url = '/api/popup/search_asList';
        let data = {
          'vechidno': $('#srch_vechidno').val(),
          'owner': $('#srch_owner').val(),
        };

        let result = AjaxUtil.getSyncData(url, data);
        if (result) {
          this.viewData.sourceCollection = result.data;
          setTimeout(() => {
            if (this.grid && this.grid.rows.length > 0) {
              const lastCol = Math.max(0, this.grid.columns.length - 1);
              this.grid.select(new wijmo.grid.CellRange(0, 0, 0, lastCol), true);
              this.grid.focus();
            }
          }, 0);
        }
        this.selectedItem = null;

        //검색버튼을 누르고 초기화한다
        this.selectedItem = null;
      }

      selectData(item) {
        this._skipAutoFocus = false;

        if (typeof this.callback === 'function') {
          this._skipAutoFocus = true; // 콜백 안에서 포커스 줄 예정
          this.callback(item);
        }

        this.close();
      }

      show(callback) {
        let _this = this;

        this.callback = callback;

        let content = tmpl('popup_asListSearchTemplate', {});
        let $content = $(content);
        this.modalContainer.open({width: 800, height: 500, $content});

        setTimeout(() => {

          const el = document.getElementById('theGrid2');
          if (!el) {
            return;
          }

          const existingGrid = wijmo.Control.getControl(el);
          if (existingGrid) {
            existingGrid.dispose();
          }

          this.grid = new wijmo.grid.FlexGrid('#theGrid2', {
            selectionMode: wijmo.grid.SelectionMode.Row,
            autoGenerateColumns: false,
            showMarquee: true,
            isReadOnly: true,
            keyActionEnter: wijmo.grid.KeyAction.None,
            columns: [
              {binding: 'asid', header: 'as_id', visible: false},
              {binding: 'itemcode', header: '차명', width: 120, align: 'center'},
              {binding: 'vechidno', header: '차대번호', width: '*', align: 'left'},
              {binding: 'owner', header: '차주', width: 150, align: 'left'},
              {binding: 'regno', header: '등록번호', width: 200, align: 'left'},
            ],
            itemsSource: this.viewData,
          });
          this.grid.rowHeaders.columns.splice(0, 1);
          new FlexGridContextMenu(this.grid);
          this.grid.downloadFileName = 'as 접수내역';

          this.$btnCompSearch = $content.find('#btnCompSearch');
          this.$btnSelect     = $content.find('#btnSelect');
          // ✅ 조회 버튼
          this.$btnCompSearch.click(() => this.searchDataBind());
          // 초기 자동 조회
          $('#btnCompSearch').click();

          this.$btnSelect.click(() => {
            const items = this.grid.selectedItems;
            if (items.length > 0) this.selectData(items[0]);
          });

          this._detachGridHandlers = GridUtil.enableResponsiveRowSelection(
            this.grid,
            (item) => this.selectData(item)
          )

          this.$btnSelect.click(function (e) {
            // 그리드에서 현재 선택된 item을 찾아서 호출한다.
            let items = _this.grid.selectedItems;
            if (items.length === 0) {
              return false;
            }
            _this.selectData(items[0]);
          });


          //닫기버튼을 아래 ID로 사용한다면 호출하는 화면에서 이벤트 처리 필요없음
          $content.find('#btn-search-close').on('click', function () {
            _this.close();
          });


          this._escHandler = function (e) {
            if (e.key === 'Escape' || e.keyCode === 27) {
              _this.close();
            }
          };
          $(document).on('keydown.popupesc', this._escHandler);

          // 모달 닫힐 때 포커스 복원
          this.modalContainer.onClose = () => {
            // ESC 후 포커스 복원
            if (this.focusAfterClose && document.body.contains(this.focusAfterClose)) {
              setTimeout(() => { this.focusAfterClose.focus(); }, 50);
            }
            // ESC 이벤트 제거
            $(document).off('keydown.popupesc', this._escHandler);

            // ✅ GridUtil detach
            try { if (typeof this._detachGridHandlers === 'function') this._detachGridHandlers(); } catch(e){}

            // (선택) wijmo 컨트롤 제거
            try { if (this.grid && !this.grid.isDisposed) this.grid.dispose(); } catch(e){}
          };

        }, 50);
      }

      close() {
        this.modalContainer.close();
      }
    }

    $(document).on('keydown', '#compCode', function (e) {
      if (e.key === 'Enter' || e.keyCode === 13) {
        e.preventDefault();
        $('#btnCompSearch').trigger('click');
      }
    });

    $(document).on('keydown', '#compName', function (e) {
      if (e.key === 'Enter' || e.keyCode === 13) {
        e.preventDefault();
        $('#btnCompSearch').trigger('click');
      }
    });

    $(document).on('keydown', '#business_number', function (e) {
      if (e.key === 'Enter' || e.keyCode === 13) {
        e.preventDefault();
        $('#btnCompSearch').trigger('click');
      }
    });
  </script>