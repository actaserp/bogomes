<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<head>
  <style>
      .wj-header {
          text-align: center !important;
      }
      .input-with-button {
          display: flex;
          gap: 4px; /* ë²„íŠ¼ê³¼ input ì‚¬ì´ ì—¬ë°± */
          align-items: center;
      }

      .input-with-button input {
          flex: 1; /* ë‚˜ë¨¸ì§€ ì˜ì—­ ì°¨ì§€ */
          min-width: 0;
          padding: 4px;
      }

      .input-with-button .btn.in_btn {
          flex-shrink: 0;
          width:40px;
      }
      .input-with-button button img, .btn img {
          margin-right: 1px;
      }
      /* 1366px ì´í•˜: ì˜¤ë¥¸ìª½ í¼ ê°ì¶”ê³ , ì„¹ì…˜ì„ ì„¸ë¡œ ìŠ¤íƒ */
      @media (max-width: 1366px) {
          .layout-contents > div[style*="display: flex"] > section:last-of-type {
              display: none !important;
          }
          .layout-contents > div[style*="display: flex"] {
              flex-direction: column !important;
          }
          .layout-contents > div[style*="display: flex"] > section {
              width: 100% !important;
          }
          /* ê¸°ë³¸ í¼ì€ ê°ì¶¤ (ëª¨ë‹¬ë¡œë§Œ ì‚¬ìš©) */
          .table-wrap {
              display: none !important;
          }
          #btnSave, #btnDel {
              display: none !important;
          }
          #basicForm_modal input,
          #basicForm_modal select,
          #basicForm_modal textarea {
              width: 100% !important;
              max-width: 100% !important;
              min-width: 0 !important;
          }

          /* ì…€ ì—¬ë°±/í•„ë“œ ë†’ì´ ì¡°ê¸ˆ íƒ€ì´íŠ¸í•˜ê²Œ */
          #basicForm_modal .write-table th,
          #basicForm_modal .write-table td {
              padding: 4px 6px;
          }
          #basicForm_modal input[type="text"],
          #basicForm_modal input[type="date"],
          #basicForm_modal select {
              height: 34px;
          }

          /* ê²€ìƒ‰ ë²„íŠ¼ í­ë„ ì‚´ì§ ì¤„ì—¬ì„œ ê³µê°„ í™•ë³´ */
          #basicForm_modal .input-with-button .btn.in_btn {
              width: 34px;
          }

          /* ê³ ì •í­ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ì„ ë¬´ì‹œí•´ì•¼ í•  ê²½ìš°(ì˜ˆ: txtProductNameì˜ width:250px) */
          #basicForm_modal #txtProductName {
              width:auto !important;
          }
          #basicForm_modal #spcmngno {
              width:auto !important;
          }
          .ax5modal[data-modal-els="root"] {
              height: 70dvh !important;      /* ë™ì  ë·°í¬íŠ¸ */
              height: 70svh !important;      /* iOS safe */
              height: 70vh  !important;      /* fallback */
              top: 5dvh !important;          /* ì‚´ì§ ì•„ë˜ ë„ìš°ê¸°(ì›í•˜ë©´ 0) */
              display: flex; flex-direction: column;
          }

          /* ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì£¼ì…í•œ bodyì˜ inline height ë¬´ë ¥í™”: Flexë¡œ ì±„ìš°ê¸° */
          .ax5modal[data-modal-els="root"] .ax-modal-body {
              height: calc(100vh - 40px) !important;   /* inline height ë®ì–´ì“°ê¸° */
              flex: 1 1 auto;            /* ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì°¨ì§€ */
              min-height: 0;             /* ìì‹ ìŠ¤í¬ë¡¤ í—ˆìš© */
              top: 20px !important;
          }

          /* ëª¨ë‹¬ ë‚´ë¶€ ìŠ¤í¬ë¡¤ ì˜ì—­ */
          .ax5modal .modal-form-wrap {
              height: 100% !important;
              overflow-y: auto;
          }

      }

      @media (max-width: 768px) {
          #basicForm_modal .write-table { font-size: 0.92rem; }
          #basicForm_modal input[type="text"],
          #basicForm_modal input[type="date"],
          #basicForm_modal select {
              height: 32px;
          }
          #basicForm_modal textarea {
              min-height: 96px; /* ë„ˆë¬´ ì‘ì•„ì§€ì§€ ì•Šê²Œ */
          }
      }

  </style>
</head>

<th:block layout:fragment="content">
  <div class="layout-contents">
    <!-- Page Title -->
    <div class="page-title-wrap">
      <div class="left">
        <h2>AS ì°¨ëŸ‰ê´€ë¦¬</h2>
        <a title="ë¶ë§ˆí¬" class="bookmark toggle">
          ë‚´ë©”ë‰´
        </a>
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
        <li>ê¸°ì¤€ì •ë³´</li>
        <li>AS ì°¨ëŸ‰ê´€ë¦¬</li>
      </ul>
    </div>

    <div style="display: flex; gap: 5px">
      <section class="section" style="width: 40%;">
        <div class="section-top">
          <div class="search-wrap">
            <dl>
              <dt>
                <label>ì œì›</label>
              </dt>
              <dd>
                <div class="srch-box">
                  <select id="cboSpcmngno" name="cboSpcmngno">

                  </select>
                </div>
              </dd>
            </dl>
            <dl>
              <dt>
                <label>ì°¨ëŒ€ë²ˆí˜¸</label>
              </dt>
              <dd>
                <div class="srch-box">
                  <input type="text" id="txtVechidno" name="txtVechidno">
                </div>
              </dd>
            </dl>

            <dl>
              <dt><span class="eq"></span></dt>
              <dd>
                <li>
                  <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch">
                    <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                    ê²€ìƒ‰
                  </a>
                </li>
              </dd>
            </dl>
          </div>

        </div>
        <div class="container-fluid">
          <p id="selectedItem"></p>
          <div id="theGrid"></div>
        </div>
      </section>
      <section style="width: 60%;">
        <div class="section-top">
          <div class="search-wrap">
            <ul>
              <li>
                <button type="button" class="btn-default" id="btnNew" name="btnNew"
                        style="height: 36px; width:115px;"><i
                    class="fas fa-plus"></i>ì‹ ê·œë“±ë¡
                </button>
              </li>

              <li>
                <button type="button" class="btn-default y_write_auth" id="btnSave"
                        style="float:none; height: 36px; width:115px;">
                  <i class="fas fa-save"></i>ì €ì¥
                </button>
              </li>

              <li>
                <button type="button" class="btn-danger y_write_auth" id="btnDel"
                        style="float:none; height: 36px; width:115px;"><i
                    class="fas fa-trash"></i>ì‚­ì œ
                </button>
              </li>
            </ul>
          </div>
        </div>

        <div class="table-wrap" style=" overflow-x: auto;">
          <form id="basicForm">
            <table class="write-table" style="width: 100%; border-collapse: collapse;">
              <caption style="text-align: left; margin-bottom: 8px;">ë“±ë¡í…Œì´ë¸”</caption>
              <input type="hidden" id="id" name="id"/>
              <tbody>
              <tr>
                <th>
                  <label for="spcmngno"><span class="eq">*</span>ì œì›</label>
                </th>
                <td>
                  <select id="spcmngno" name="spcmngno" style="width:210px;">
                  </select>
                </td>
                <th>
                  <label for="vechidno"><span class="eq">*</span>ì°¨ëŒ€ë²ˆí˜¸</label>
                </th>
                <td>
                  <input id="vechidno" name="vechidno" placeholder="ì°¨ëŒ€ë²ˆí˜¸" style="width: 100%;">
                </td>

              </tr>
              <tr>
                <th>
                  <label><span class="eq">*</span>ì°¨ëŸ‰</label>
                </th>
                  <td>
                    <div class="input-with-button">
                      <input type="text" id="txtProductName" name="txtProductName"
                             placeholder="ì½”ë“œ ë˜ëŠ” ì°¨ì¢… ì…ë ¥ í›„ ì—”í„°" autocomplete="off" style="width: 250px;"/>
                      <input type="hidden" id ="Material_id" name="Material_id" />
                      <a class="btn in_btn" title="í’ˆëª© ê²€ìƒ‰" id="btnProductSearch" >
                        <img src="/images/icon/btn-srch-black.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜" />
                      </a>
                    </div>
                  </td>
                <th>
                  <label for="OWNER">ì°¨ì£¼</label>
                </th>
                <td>
                  <input type="text" id="OWNER" name="OWNER" placeholder="ì°¨ì£¼" style="width: 100%;">
                </td>

              </tr>
              <tr>
                <th>
                  <label for="PERNM">ì°¨ëŸ‰ìˆ˜ë¦¬ë‹´ë‹¹</label>
                </th>
                <td>
                  <input type="text" style="width: 100%;" id="PERNM" name="PERNM" placeholder="ì°¨ëŸ‰ìˆ˜ë¦¬ë‹´ë‹¹ì" >
                </td>
                <th>
                  <label for="inputDate">ì‘ì—…(ì™„ë£Œ)ì¼ì</label>
                </th>
                <td>
                  <input type="date" style="width: 100%;" id="inputDate" name="inputDate">
                </td>
              </tr>
              <tr>
                <th>
                  <label for="outDate">ì¶œê³ ë‚ ì§œ</label>
                </th>
                <td>
                  <input type="date" style="width: 100%;" id="outDate" name="outDate">
                </td>
                <th>
                  ì¶œê³ ì²˜ë¦¬
                </th>
                <td style="display:flex;justify-content:center;align-items:center;">
                  <input type="checkbox" id="endflag" name="endflag">
                </td>
              </tr>
              <tr>
                <th>
                  <label for="fixText">ì‘ì—…ë‚´ìš©</label>
                </th>
                <td  colspan="5">
                  <textarea id="fixText" name="fixText" placeholder="ì‘ì—…ë‚´ìš©"></textarea>
                </td>
              </tr>
              </tbody>
            </table>
          </form>
        </div>
      </section>
    </div>
  </div> <!--//layout-contents end -->
</th:block>
<th:block layout:fragment="scripts">
  <th:block th:replace="/common/approve_box :: approve_box"></th:block>
  <th:block th:replace="/common/ax5_uploader :: ax5_uploader"></th:block>
  <th:block th:replace="/common/upload_one_image_box :: upload_one_image_box"></th:block>
  <th:block th:replace="/common/multiform_material :: multiform_material"></th:block>
  <script type="text/javascript">
    class ASVehiclePage {
      constructor() {
        this.grid = null;
        this.viewData = new wijmo.collections.CollectionView();
        this.url = '/api/definition/ASVehicle';
        this._onOpenByClick   = (e) => this._openFromHitTest(e);
        this._onOpenByDblClick= (e) => this._openFromHitTest(e);
        this.init();
      }

      init() {
        let _this = this;
        this.grid = new wijmo.grid.FlexGrid('#theGrid', {
          selectionMode: wijmo.grid.SelectionMode.Row,
          headersVisibility: wijmo.grid.HeadersVisibility.Column,
          autoGenerateColumns: false,
          showMarquee: true,
          isReadOnly: true,
          formatItem: (sender, e) => {
            if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
              e.cell.style.textAlign = 'center';
            }
          },
          columns: [
            {binding: 'id', header: 'id', visible: false},
            {binding: 'spcmngno', header: 'ì œì›', width: 150, align: 'left'},
            {binding: 'ItemCode', header: 'ì°¨ëª…', width: 200, align: 'left'},
            {binding: 'vechidno', header: 'ì°¨ëŒ€ë²ˆí˜¸', width: 200, align: 'center'},
            {binding: 'owner', header: 'ì°¨ì£¼', width: 150, align: 'center'},
            {binding: 'outdate', header: 'ì¶œê³ ì¼ì', width: 120, align: 'center'},
            {binding: 'inputdate', header: 'ì™„ë£Œì¼ì', width: 120, align: 'center'},
            {binding: 'endflag', header: 'ì¶œê³ ì—¬ë¶€', width: 100, align: 'center'}
          ],
          itemsSource: this.viewData, // ë°ì´í„°ë¥¼ ì„¤ì •í•  ë°°ì—´
        });

        new FlexGridContextMenu(this.grid);
        this.grid.downloadFileName = 'ASì°¨ëŸ‰ê´€ë¦¬';

        this.bindGridOpenHandler();
        // âœ… í™”ë©´ í¬ê¸°/ë¯¸ë””ì–´ì¿¼ë¦¬ ë³€ê²½ ì‹œ í•¸ë“¤ëŸ¬ êµì²´
        const mq = window.matchMedia('(max-width: 1366px)');
        const rebind = () => this.bindGridOpenHandler();
        if (mq.addEventListener) mq.addEventListener('change', rebind);
        else mq.addListener(rebind); // êµ¬í˜• ë¸Œë¼ìš°ì €
        window.addEventListener('resize', rebind);

        $('#txtVechidno').on('keypress', function (e) {
          if (e.keyCode === 13) {
            _this.searchMainData();
          }
        });
      }
      // ìƒì„¸ ì˜¤í”ˆ ê³µí†µ ë¡œì§
      _openFromHitTest(e) {
        const ht = this.grid.hitTest(e);
        if (!ht || ht.cellType !== wijmo.grid.CellType.Cell) return;

        let item = (ht.row > -1 && this.grid.rows[ht.row]) ? this.grid.rows[ht.row].dataItem : null;
        if (!item && this.grid.selectedItems.length === 1) item = this.grid.selectedItems[0];
        if (!item) return Alert.alert('', 'ì„ íƒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');

        AjaxUtil.getAsyncData(this.url + '/detail', { id: item.id }, (result) => {
          if (!result || !result.data) return Alert.alert('ì˜¤ë¥˜', 'ìƒì„¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          const d = result.data;

          const isSmall = window.matchMedia('(max-width: 1366px)').matches;
          if (isSmall) {
            openFormModal('edit', d);
            setTimeout(() => $('#basicForm_modal #spcmngno').focus(), 0);
          } else {
            fillForm($('#basicForm'), d);
          }
        });
      }

      bindGridOpenHandler() {
        const host = this.grid.hostElement;
        const isSmall = window.matchMedia('(max-width: 1366px)').matches;

        // ì´ì „ ë°”ì¸ë”© í•´ì œ (ì¤‘ë³µ ë°©ì§€)
        host.removeEventListener('click', this._onOpenByClick);
        host.removeEventListener('dblclick', this._onOpenByDblClick);

        if (isSmall) {
          // ì‘ì€ í™”ë©´: í´ë¦­ í•œ ë²ˆìœ¼ë¡œ ì—´ê¸°
          host.addEventListener('click', this._onOpenByClick, false);
        } else {
          // í° í™”ë©´: ë”ë¸”í´ë¦­ìœ¼ë¡œ ì—´ê¸°
          host.addEventListener('dblclick', this._onOpenByDblClick, false);
        }
      }

      searchMainData() {
        let _this = this;

        let data = {
          'spcmngno': $("#cboSpcmngno").val(),
          'vechidno': $("#txtVechidno").val(),
          spjangcd: sessionStorage.getItem('spjangcd')
        }
        let fnsuccess = function (result) {
          if (result != null) {
            _this.viewData = new wijmo.collections.CollectionView(result.data);
            _this.grid.itemsSource = _this.viewData;
          }
        };

        AjaxUtil.getAsyncData(_this.url + '/read', data, fnsuccess);
      }

      //ì €ì¥ (í¼ ì»¨í…ìŠ¤íŠ¸ ì§€ì›)
      saveMainData($form) {
        const _this = this;
        const $ctx = $form && $form.length ? $form : getActiveForm();

        const data = {
          id:          $ctx.find('#id').val(),
          spcmngno:    $ctx.find('#spcmngno').val(),
          vechidno:    $ctx.find('#vechidno').val(),
          Material_id: $ctx.find('#Material_id').val(),
          OWNER:       $ctx.find('#OWNER').val(),
          PERNM:       $ctx.find('#PERNM').val(),
          inputDate:   $ctx.find('#inputDate').val(),
          outDate:     $ctx.find('#outDate').val(),
          endflag:     $ctx.find('#endflag').is(':checked') ? '0' : '1',
          fixText:     $ctx.find('#fixText').val(),
        };

        Alert.confirm('', 'ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
          AjaxUtil.postJsonData(_this.url + '/save', data, function (result) {
            if (result && result.success) {
              Alert.alert('', 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
              _this.searchMainData();
              const isModal = $ctx.data('isModal') || $ctx.attr('id') === 'basicForm_modal';
              if (isModal) {
                const modal = $ctx.data('modal');
                if (modal && typeof modal.close === 'function') modal.close();
              } else {
                $('#btnNew').click(); // ê¸°ì¡´ ì´ˆê¸°í™”
              }
            } else {
              Alert.alert('', 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
          });
        });
      }

      // âœ… ê³µí†µ ì‚­ì œ í•¨ìˆ˜
      deleteASData(id, opts = {}) {
        if (!id) {
          Alert.alert('', 'ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ëª©ë¡ì—ì„œ í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.');
          return;
        }

        Alert.confirm('', 'ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
          const url = this.url + '/delete';
          const data = {id};

          AjaxUtil.postAsyncData(url, data, (res) => {
            if (res && res.success) {
              Notify.success('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
              this.searchMainData();
              if (opts.closeModal) {
                const $ctx  = opts.$ctx || $('#basicForm_modal');
                const modal = $ctx.data('modal');
                if (modal && typeof modal.close === 'function') {
                  modal.close();
                }
              } else {
                // ì¼ë°˜ í™”ë©´ì—ì„œëŠ” ê¸°ì¡´ì²˜ëŸ¼ ì´ˆê¸°í™”
                $('#btnNew').click();
              }
            } else {
              Alert.alert('', res && res.message ? res.message : 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
          });
        });
      }
    }

    $('#btnProductSearch').click(function () {
      const $row = $(this).closest('tr');

      const $productInput = $row.find('input[name^="txtProductName"]');
      const $productId = $row.find('input[name^="Material_id"]');

      const pop = new PopMatComponent();
      pop.material_type = 'product,sangpum';

      pop.show(function (item) {
        $productInput.val(item.Name);
        $productId.val(item.id);

      });
    });
    function fillProductFields($row, item) {
      const $productInput  = $row.find('input[name^="txtProductName"]');
      const $productId     = $row.find('input[name^="Material_id"]');
      $productInput.val(item?.Name || '');
      $productId.val(item?.id || '');
    }

    // âœ… ì—”í„°í‚¤ë¡œ í’ˆëª© ê²€ìƒ‰/ì„ íƒ
    $(document).on('keydown', 'input[name^="txtProductName"]', function (e) {
      // Enterë§Œ ì²˜ë¦¬ (í‚¤ ì½”ë“œ í˜¸í™˜)
      if (e.key !== 'Enter' && e.keyCode !== 13) return;
      e.preventDefault();

      const $field = $(this);
      const $row   = $field.closest('tr'); // í˜„ì¬ ì…ë ¥ì´ ìˆëŠ” í–‰(ë‹¨ì¼í¼ì´ì–´ë„ OK)
      const keyword = ($field.val() || '').trim();

      const pop = new PopMatComponent();
      pop.material_type = 'product,sangpum';

      const callback = function (item) {
        if (!item) return;
        fillProductFields($row, item);
        // í•„ìš” ì‹œ í¬ì»¤ìŠ¤ ì´ë™ ë“± ì¶”ê°€
        // $row.find('input[name="ë‹¤ìŒí•„ë“œ"]').focus();
      };

      // ğŸ” í‚¤ì›Œë“œ ì—†ìœ¼ë©´ ê·¸ëƒ¥ íŒì—… ì—´ê¸°
      if (!keyword) {
        pop.focusAfterClose = $field[0];
        pop.show(callback);
        return;
      }

      // ğŸ” í‚¤ì›Œë“œë¡œ ì¦‰ì‹œ ê²€ìƒ‰ ì‹œë„ â†’ 1ê±´ì´ë©´ ìë™ì„ íƒ, ê·¸ ì™¸ëŠ” íŒì—… ì—´ê³  ìë™ê²€ìƒ‰
      const data = {
        keyword: keyword,
        spjangcd: sessionStorage.getItem('spjangcd')
      };
      const result = AjaxUtil.getSyncData('/api/popup/search_material', data);
      const rows = result?.data || [];

      if (rows.length === 1) {
        callback(rows[0]);
      } else {
        pop.show(callback);
        // íŒì—… ì—´ë¦° ë’¤ ì‚¬ìš©ìê°€ ì¹œ í‚¤ì›Œë“œë¡œ ìë™ ê²€ìƒ‰ íŠ¸ë¦¬ê±°
        setTimeout(() => {
          if (pop.$keyword && pop.$btnMaterialSearch) {
            pop.$keyword.val(keyword);
            pop.$btnMaterialSearch.trigger('click');
          }
        }, 50);
      }
    });

    // âœ… ì‚¬ìš©ìê°€ txtProductName ë‚´ìš©ì„ ì§€ìš¸ ë•Œ ì—°ê´€ í•„ë“œ ì´ˆê¸°í™”
    $(document).on('input', 'input[name^="txtProductName"]', function () {
      const $field = $(this);
      const $row   = $field.closest('tr');     // ë‹¨ì¼ í¼ì´ì–´ë„ ì•ˆì „

      if ($field.val().trim() === '') {
        $row.find('input[name^="Material_id"]').val('');
      }
    });

    //Ã— ë²„íŠ¼ìœ¼ë¡œ ë¹„ìš¸ ë•Œë„ ë™ì¼ ì²˜ë¦¬
    $(document).on('click', '.btn-clear', function () {
      const $wrap = $(this).closest('.input-clear, .input-with-button, td, tr');
      $wrap.find('input[name^="txtProductName"]').val('').trigger('input');
    });

    function fillForm($root, d) {
      $root.find('#id').val(d.id || '');
      $root.find('#spcmngno').val(d.spcmngno || '');
      $root.find('#vechidno').val(d.vechidno || '');
      $root.find('#Material_id').val(d.Material_id || '');
      $root.find('#txtProductName').val(d.ItemCode || '');
      $root.find('#OWNER').val(d.owner || '');
      $root.find('#PERNM').val(d.pernm || '');
      $root.find('#inputDate').val(d.inputdate || '');
      $root.find('#outDate').val(d.outdate || '');
      $root.find('#fixText').val(d.fixtext || '');
      // ì²´í¬ ë¡œì§: endflag === '0' ì´ë©´ ì²´í¬
      $root.find('#endflag').prop('checked', d.endflag === '0');
    }

    function getActiveForm() {
      // ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ëª¨ë‹¬ í¼, ì•„ë‹ˆë©´ ê¸°ë³¸ í¼
      return $('#basicForm_modal').length ? $('#basicForm_modal') : $('#basicForm');
    }

    function openFormModal(mode /* 'new' | 'edit' */, initialData) {
      const title = (mode === 'new') ? 'ë“±ë¡' : 'ìˆ˜ì •';
      const modal = new PopupDraggable(title);

      // ì¤‘ë³µ ëª¨ë‹¬ í¼ ë°©ì§€ (ì´ë¯¸ ì—´ë ¤ìˆë‹¤ë©´ ì œê±°/ì •ë¦¬)
      try { $('#basicForm_modal').closest('.modal-form-wrap').remove(); } catch (e) {}

      // í¼ í´ë¡  ìƒì„±
      const $clone = $('#basicForm').clone(true, true);
      $clone.attr('id', 'basicForm_modal'); // ì»¨í…ìŠ¤íŠ¸ êµ¬ë¶„ìš©

      $clone.data('isModal', true);
      $clone.data('modal', modal);

      // ì»¨í…ì¸  ë˜í¼
      const $wrap = $('<div class="modal-form-wrap" style="padding:8px;"></div>').append($clone);

      // ì‹ ê·œì¼ ë•Œ ì´ˆê¸°í™”
      if (mode === 'new') {
        $clone[0].reset();
        $clone.find('input[type="hidden"]').val('');
        const today = new Date();
        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
        $clone.find('#inputDate').val(CommonUtil.formatYYYYMMDD(monthStart));
        $clone.find('#outDate').val(CommonUtil.formatYYYYMMDD(today));
      }

      // ìˆ˜ì •ì¼ ë•Œ ë°”ì¸ë”©
      if (mode === 'edit' && initialData) fillForm($clone, initialData);

      // === ë°˜ì‘í˜• ì‚¬ì´ì¦ˆë¡œ ì˜¤í”ˆ ===
      const size = calcModalSize();
      modal.open({
        width:  size.w,
        height: size.h,        // â† ëª¨ë‹¬ ìì²´ ë†’ì´ë„ vh ê¸°ë°˜ìœ¼ë¡œ ê½‰ ì°¨ê²Œ
        $content: $wrap
      });

      // ë¦¬ì‚¬ì´ì¦ˆ(ì°½ í¬ê¸°/ëª¨ë°”ì¼ í‚¤ë³´ë“œ ë³€í™”) ëŒ€ì‘
      const onResize = () => {
        const s = calcModalSize();
        if (typeof modal.resize === 'function') modal.resize(s.w, s.h);

      };
      window.addEventListener('resize', onResize);
      if (window.visualViewport) window.visualViewport.addEventListener('resize', onResize);

      // ëª¨ë‹¬ ì „ìš© ë²„íŠ¼ ì˜ì—­
      const $actions = $('<div style="margin-top:12px; display:flex; justify-content:center; gap:8px;"></div>');

// ì €ì¥ ë²„íŠ¼
      const $btnSaveModal = $('<button type="button" class="btn-default">ì €ì¥</button>');
      $actions.append($btnSaveModal);

// ìˆ˜ì • ëª¨ë“œì¼ ë•Œ ì‚­ì œ ë²„íŠ¼
      if (mode === 'edit') {
        const $btnDeleteModal = $('<button type="button" class="btn-danger">ì‚­ì œ</button>');
        $actions.append($btnDeleteModal);

        $btnDeleteModal.on('click', function () {
          const id = $clone.find('#id').val();
          page.deleteASData(id, { closeModal: true, $ctx: $clone });
          if (typeof modal.close === 'function') modal.close();
        });
      }

// ë‹«ê¸° ë²„íŠ¼
      const $btnCloseModal = $('<button type="button" class="btn-popup" id="modal-close-button">ë‹«ê¸°</button>');
      $actions.append($btnCloseModal);

      $btnCloseModal.on('click', function () {
        if (typeof modal.close === 'function') modal.close();
      });

      $wrap.append($actions);

    // ì €ì¥ í•¸ë“¤ëŸ¬
      $btnSaveModal.on('click', function () {
        page.saveMainData($clone);
      });

    }
    // í™”ë©´/ê°€ìƒë·°í¬íŠ¸(ëª¨ë°”ì¼ í‚¤ë³´ë“œ)ê¹Œì§€ ë°˜ì˜í•´ì„œ ëª¨ë‹¬ í¬ê¸° ê³„ì‚°
    function calcModalSize() {
      // ë·°í¬íŠ¸(ê°€ìƒ í‚¤ë³´ë“œ í¬í•¨) ê¸°ì¤€ ê°’
      const vw = (window.visualViewport && window.visualViewport.width)  || window.innerWidth;
      const vh = (window.visualViewport && window.visualViewport.height) || window.innerHeight;

      // ë°”ê¹¥ ì—¬ë°±(íƒ€ì´í‹€ë°”/ê·¸ë¦¼ì/ì™¸ê³½ ë§ˆì§„) â€“ í™”ë©´ì„ ê½‰ ì±„ìš°ë˜ ì‚´ì§ ì—¬ë°±ë§Œ ë‚¨ê¹€
      const OUTER_GAP_W = 40;
      const OUTER_GAP_H = 40;   // â† í•„ìš”í•˜ë©´ 32~64 ì‚¬ì´ë¡œ ë¯¸ì„¸ì¡°ì •

      // ìµœì†Œ/ìµœëŒ€ ì•ˆì „ê°’
      const MIN_W = 360, MAX_W = 900;
      const MIN_H = 420, MAX_H = 1000;

      // ëª¨ë‹¬ ì „ì²´ í¬ê¸°(= open ì‹œ height)
      const w = Math.max(MIN_W, Math.min(MAX_W, vw - OUTER_GAP_W));
      const h = Math.max(MIN_H, Math.min(MAX_H, vh - OUTER_GAP_H));

      // ëª¨ë‹¬ ë‚´ë¶€ì—ì„œ ë²„íŠ¼/íŒ¨ë”© ë“±ì„ ì œì™¸í•œ ë³¸ë¬¸ ë†’ì´
      const INNER_GAP = 96; // íƒ€ì´í‹€/í•˜ë‹¨ë²„íŠ¼/ë‚´ë¶€íŒ¨ë”© í•©
      return { w, h, bodyH: h - INNER_GAP };
    }


    $(document).ready(function (e) {

      // ===== ë°˜ì‘í˜•: ì˜¤ë¥¸ìª½ ë²„íŠ¼ì˜ì—­ì„ ì™¼ìª½ ìƒë‹¨ìœ¼ë¡œ ì´ë™ =====
      const ResponsiveToolbar = (function () {
        const BREAKPOINT = 1366;
        const $sections = $('.layout-contents > div[style*="display: flex"]').children('section');
        const $leftSectionTop  = $sections.eq(0).find('.section-top');
        const $rightSectionTop = $sections.eq(1).find('.section-top');

        // ì›ìœ„ì¹˜ë¥¼ ê¸°ì–µí•  placeholder
        const $placeholder = $('<div id="rightSectionTop_ph" style="display:none;"></div>');
        let moved = false;

        function apply() {
          if (window.innerWidth <= BREAKPOINT && !moved) {
            // ì›ìœ„ì¹˜ ê¸°ì–µ
            $rightSectionTop.after($placeholder);
            // ì™¼ìª½ ìƒë‹¨ìœ¼ë¡œ ë²„íŠ¼ì˜ì—­ ì´ë™ (ê²€ìƒ‰ë°” ì•„ë˜ì— ë¶™ì„)
            $rightSectionTop.appendTo($leftSectionTop);
            moved = true;
          } else if (window.innerWidth > BREAKPOINT && moved) {
            // ì›ìœ„ì¹˜ë¡œ ë³µê·€
            $placeholder.after($rightSectionTop);
            $placeholder.remove();
            moved = false;
          }
        }

        $(window).on('resize', apply);
        apply();
        return { apply };
      })();

      page = new ASVehiclePage();

      let today = new Date();
      let monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

      $('#inputDate').val(CommonUtil.formatYYYYMMDD(monthStart));
      $('#outDate').val(CommonUtil.formatYYYYMMDD(today));

      AjaxUtil.fillSelectOptions($('#cboSpcmngno'), 'material_group', 'all', false);
      AjaxUtil.fillSelectOptions($('#spcmngno'), 'material_group', 'choose', false);

      page.searchMainData();

      // ê²€ìƒ‰
      $('#btnSearch').click(function (e) {
        e.preventDefault();
        page.searchMainData();
      });

      $('#btnSave').off('click').on('click', function (e) {
        e.preventDefault();
        const $activeForm = getActiveForm();
        page.saveMainData($activeForm);
      });


      $('#btnDel').on('click', (e) => {
        e.preventDefault();
        const id = $('#id').val();
        page.deleteASData(id);   // âœ… ë¶„ë¦¬í•œ í•¨ìˆ˜ í˜¸ì¶œ
      });

      //ì´ˆê¸°í™”
      $('#btnNew').off('click').on('click', function (e) {
        e.preventDefault();

        if (window.innerWidth <= 1366) {
          // ì‘ì€ í™”ë©´: ëª¨ë‹¬ë¡œ ë“±ë¡ í¼
          openFormModal('new');
          setTimeout(() => {
            $('#basicForm_modal #spcmngno').focus();
          }, 0);
          return;
        }

        // í° í™”ë©´: ê¸°ì¡´ ì´ˆê¸°í™” ë™ì‘ ìœ ì§€
        $('#basicForm')[0].reset();
        $('input[name="endflag"]').prop('checked', false);
        $('#basicForm').find('input[type="hidden"]').val('');

        const today = new Date();
        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

        let startStr = CommonUtil.formatYYYYMMDD(monthStart);
        let endStr   = CommonUtil.formatYYYYMMDD(today);
        $('#inputDate').val(startStr).trigger('change');
        $('#outDate').val(endStr).trigger('change');
      });

    });
  </script>

</th:block>
<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
</html>