<html layout:decorate="~{layout_page}">
<head>
    <link href="/resource/fullCalendar/c-main.min.css" rel="stylesheet">
    <style>
        #calendar {
            max-width: 100%;
            margin: 0 auto;
        }

        #checkTable table, tr, td {
            border: none;
            height: 20px;
        }

        #checkTable td {
            text-align: center;
        }

        .checkbox-container {
            display: flex;
            gap: 10px; /* 각 체크박스 사이 간격 */
            align-items: center;
        }
    </style>
</head>

<th:block layout:fragment="content">
    <div class="layout-contents">
        <div class="page-title-wrap">
            <div class="left">
                <h2>근무시간 캘린더</h2>
                <a title="북마크" class="bookmark toggle">
                    내 메뉴
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
                <li>시스템설정</li>
                <li>기준정보</li>
                <li>근무시간캘린더</li>
            </ul>
        </div>
        <section class="section">
            <div class="section-top">
                <div class="search-wrap">
                    <dl>
                        <dt>
                            <label>공장</label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <select class="form-control2" id="search_factory" name="search_factory"></select>
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>
                            <label></label>
                        </dt>
                        <dd>
                            <li>
                                <a class="btn btn-delete" title="검색" id="btnMultiInsert">
                                    <!-- <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">-->
                                    일괄 등록
                                </a>
                            <!-- <button type="button" class="btn-default" id="btnMultiInsert" data-labelCd="일괄 등록"> 일괄 등록
                             </button>-->
                            </li>
                        </dd>
                    </dl>

                    <dl>
                        <dt><span class="eq"></span></dt>
                        <dd>
                            <li>
                                <a class="btn btn-delete" title="검색" id="btnSearch">
                                    <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                    검색
                                </a>
                                <!--<button type="button" class="btn-default" id="btnSearch" title="조회"><i
                                        class="fas fa-search"></i></button>-->
                            </li>
                        </dd>
                    </dl>
                </div>
            </div>
            <div class="grid_box" id="grid_box_calendar">
                <div class="h-760">
                    <div id='calendar'></div>
                </div>
                <div class="table_info_box"></div>
            </div>
        </section>
    </div>


    <!-- 근무시간 캘린더 일정등록 스크립트 -->
    <script type="text/x-tmpl" id="eventTmpl">
        <div class="content_wrap popup">
        <div class="table-wrap">
                <form id="modalForm" enctype="multipart/form-data">
                    <table class="write-table">
                          <input type="hidden" id="_id" value="" />
                        <caption>주문등록 테이블</caption>
                        <tbody>
                            <tr>
                                <th style="text-align: center">
                                    <label for="factory_pk">공장</label>
                                </th>
                                <td>
                                     <select class="form-control2 "name="factory_pk" id="factory_pk"></select>
                                </td>

                                <th style="text-align: center">
                                    <label>휴일여부</label>
                                </th>
                                <td style="text-align: center; vertical-align: middle;">
                                    <div style="display: flex; justify-content: center; align-items: center; height: 100%;">
                                        <input type="checkbox" id="holiday_yn" name="holiday_yn" value="Y" />
                                    </div>
                                </td>

                            </tr>


                            <tr>
                                <th style="text-align: center">
                                    <label for="start">시작일자</label>
                                </th>
                                <td>
                                <div data-ax5picker="multi" id="srchDt">
                                     <input class="tac " type="text" id="start" name="start" />
                                     <span class="input-group-text fs-xl">
                                            <i class="fas fa-calendar-alt calendar_color" ></i>
                                     </span>
                                </div>
                                </td>
                                <th style="text-align: center">
                                    <label for="end">종료일자</label>
                                </th>
                                <td>
                                <!--<div data-ax5picker="multi" id="srchDt">-->
                                     <input class="tac " type="text" id="end" name="end" />
                                        <span class="input-group-text fs-xl">
                                          <i class="fas fa-calendar-alt calendar_color"></i>
                                        </span>
                                        <!--</div>-->
                                </td>
                            </tr>

                            <tr>
                                <th style="text-align: center">
                                    <label for="startTime">출근시간</label>
                                </th>
                                <td>
                                     <input class="form-control2" type="text" id="startTime" name="startTime"/>
                                </td>
                                <th style="text-align: center">
                                    <label for="edit-end-time">퇴근시간</label>
                                </th>
                                <td>
                                     <input class="form-control2" type="text" id="endTime" name="endTime" />
                                </td>
                            </tr>

                            <tr>
                                <th style="text-align: center">
                                    <label for="worktime">순근무시간(hr)</label>
                                </th>
                                <td>
                                    <input class="form-control2" type="number" name="worktime" id="worktime" />
                                </td>
                                <th></th>
                                <td></td>
                                <td>
                                    <div id="batchSection" style="display:none;">
                                        <div id="checkTable">
                                            <div class="mt-5 tal checkbox-container">
                                                <input type="checkbox" value="0"> 일
                                                <input type="checkbox" value="1" checked> 월
                                                <input type="checkbox" value="2" checked> 화
                                                <input type="checkbox" value="3" checked> 수
                                                <input type="checkbox" value="4" checked> 목
                                                <input type="checkbox" value="5" checked> 금
                                                <input type="checkbox" value="6"> 토
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </form>
            </div>

            <div class="popup-button popup_button_group bottom">
                <div class="left_align modalBtnContainer-addEvent">
                      <button type="button" class="btn-popup y_write_auth" id="btnInsert" ><span data-labelCd="저장">저장</span></button>
                      <button type="button" class="btn-popup" id="modal-close-button"><span data-labelCd="닫기">닫기</span></button>
                </div>
                <div class="left_align modalBtnContainer-modifyEvent">
                   <button type="button" class="btn-popup y_write_auth" id="btnUpdate" data-labelCd="저장">저장</button>
                    <button type="button" class="btn-popup y_write_auth" id="btnDelete" data-labelCd="삭제">삭제</button>
                    <button type="button" class="btn-popup"  id="modal-close-button" data-labelCd="닫기">닫기</button>
                </div>
            </div>


            <!--<section class="pt-2">
                    <div class="table_box sub">
                        <form id="modalForm" enctype="multipart/form-data">
                            <input type="hidden" id="_id" value="" />
                            <div class="row">
                                <div class="col-6">
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text fit_box_t7" data-labelCd="공장">공장</span>
                                        </div>
                                            <select class="form-control2 "name="factory_pk" id="factory_pk"></select>
                                    </div>
                                </div>

                                <div class="col-4 mt-5 tal" >
                                    <input type="checkbox" id="holiday_yn" name="holiday_yn" value="Y" />
                                    휴일여부
                                </div>

                                <div class="col-12" >
                                    <div class="input-group" >
                                        <div class="input-group-prepend">
                                            <span class="input-group-text fit_box_t7" data-labelCd="일자">일자</span>
                                        </div>
                                        <div data-ax5picker="multi" id="srchDt">
                                            <div class="input-group-append">
                                            <input class="tac " type="text" id="start" name="start" />
                                                <span class="input-group-text fs-xl">
                                                    <i class="fas fa-calendar-alt calendar_color" ></i>
                                                </span>
                                            <span class="slow_sign">~</span>
                                            <input class="tac " type="text" id="end" name="end" />
                                                <span class="input-group-text fs-xl">
                                                    <i class="fas fa-calendar-alt calendar_color"></i>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-6">
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text fit_box_t7" data-labelCd="출근시간">출근시간</span>
                                        </div>

                                                <input class="form-control2" type="text" id="startTime" name="startTime" />
                                    </div>
                                </div>

                                <div class="col-6">
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text fit_box_t7" data-labelCd="퇴근시간">퇴근시간</span>
                                        </div>
                                                <input class="form-control2" type="text" id="endTime" name="endTime"  />
                                    </div>
                                </div>

                                <div class="col-6">
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text fit_box_t7" data-labelCd="순근무시간(hr)">순근무시간(hr)</span>
                                        </div>
                                                <input class="form-control2" type="number" name="worktime" id="worktime" />
                                    </div>
                                </div>

                                <div class="col-6" id="batchSection" style="display:none;">
                                    <div id="checkTable">
                                        <div class=" mt-5 tal" >
                                            <input type="checkbox" value="0" />
                                            일
                                            <input type="checkbox" value="1" checked />
                                            월
                                            <input type="checkbox" value="2" checked />
                                            화
                                            <input type="checkbox" value="3" checked />
                                            수
                                            <input type="checkbox" value="4" checked />
                                            목
                                            <input type="checkbox" value="5" checked />
                                            금
                                            <input type="checkbox" value="6" />
                                            토
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
            </section>
            <section >
                <div class="popup_button_group left_align  modalBtnContainer-addEvent" >
                    <button type="button" class="btn-popup y_write_auth y_write_auth" id="btnInsert" data-labelCd="저장">저장</button>
                    <button type="button" class="btn-popup" id="modal-close-button" data-labelCd="닫기">닫기</button>
                </div>
                <div class="popup_button_group left_align modalBtnContainer-modifyEvent">
                    <button type="button" class="btn-popup y_write_auth" id="btnUpdate" data-labelCd="저장">저장</button>
                    <button type="button" class="btn-popup y_write_auth" id="btnDelete" data-labelCd="삭제">삭제</button>
                    <button type="button" class="btn-popup"  id="modal-close-button" data-labelCd="닫기">닫기</button>
                </div>
            </section>-->



        </div>
    </script>
</th:block>

<th:block layout:fragment="scripts">
    <script type="text/javascript" src="/resource/fullCalendar/c-main.min.js?v=1001"></script>
    <script type="text/javascript" src="/resource/fullCalendar/ko.js?v=1001"></script>

    <script type="text/javascript">
        class WorkCalendarPage {
            constructor() {
                let _this = this;
                this.dicWorkcenterColor = {};
                this.$search_factory = null;

                this.init();
            }

            init() {
                let _this = this;
                this.$search_factory = $('#search_factory');
                let items = AjaxUtil.getSelectData('factory');
                this.$search_factory.append('<option value="">' + i18n.getGUIText('전체') + '</option>');

                $.each(items, function (idx, item) {
                    _this.$search_factory.append('<option value="' + item.value + '">' + item.text + '</option>');
                    let key = 'f' + item.value;
                    _this.dicWorkcenterColor[key] = _this.centerColor(item.value);
                });
                //AjaxUtil.fillSelectOptions(this.$search_work_center, 'workcenter', 'all', false);
                this.$search_factory.change(function () {
                    _this.refreshCalendar();
                });
            }

            getDisplayEventDate(event) {
                let displayEventDate;
                let startTimeEventInfo = moment(event.start).format('YYYY-MM-DD HH:mm');
                displayEventDate = startTimeEventInfo;
                return displayEventDate;
            }


            //근무 시간 계산
            calcIntervalHour(start_time, end_time) {
                let start = new Date();
                let end = new Date();
                let str1Arr = start_time.split(':');
                let str2Arr = end_time.split(':');
                start.setHours(str1Arr[0], str1Arr[1], 0, 0);
                end.setHours(str2Arr[0], str2Arr[1], 0, 0);
                var time = end.getTime() - start.getTime();
                time = time / 1000 / 60 / 60;
                return time;
            }

            //휴일체크
            holidayCheck() {
                let checked = $('#holiday_yn').prop('checked');
                if (checked)
                    $('#startTime').timepicker({
                        show2400: true,
                        timeFormat: 'H:i'
                    }).val('00:00');
                $('#endTime').timepicker({
                    show2400: true,
                    timeFormat: 'H:i'
                }).val('00:00');

                $('#worktime').val(0);
                $('#startTime').attr('disabled', checked);
                $('#endTime').attr('disabled', checked);
                $('#worktime').attr('disabled', checked);
            }

            timeSetting() {
                $('#startTime').timepicker({
                    show2400: true,
                    timeFormat: 'H:i'
                }).val('09:00');
                $('#endTime').timepicker({
                    show2400: true,
                    timeFormat: 'H:i'
                }).val('18:00');
            }


            initEvent() {
                let _this = this;

                $('#startTime, #endTime').on('change', function () {
                    let start_time = $('#startTime').val();
                    let end_time = $('#endTime').val();
                    let work_time = page.calcIntervalHour(start_time, end_time);
                    $('#worktime').val(work_time);
                });

                $('#btnMultiInsert').on('click', function (event) {
                    let __this = _this;
                    //$('#modalForm')[0].reset();
                    //_this.newEvent();
                    let data = {'id': ''}
                    let content = tmpl('eventTmpl', data);
                    let $content = $(content);
                    let modalContainer;
                    modalContainer = new PopupDraggable('일괄 등록');
                    modalContainer.open({width: 1340, height: 315, $content});

                    // 빈 <td></td> 숨기기
                    $('.table-wrap td').each(function () {
                        // <td> 내부에 요소가 없거나, 공백만 있는 경우 숨김 처리
                        if ($(this).is(':empty')) {
                            $(this).hide();
                        }
                    });

                    AjaxUtil.fillSelectOptions($('#factory_pk'), 'factory', 'choose', false);

                    page.timeSetting();
                    let work_time = page.calcIntervalHour($('#startTime').val(), $('#endTime').val());
                    $('#worktime').val(work_time);

                    $('#startTime, #endTime').on('change', function () {
                        let start_time = $('#startTime').val();
                        let end_time = $('#endTime').val();
                        let work_time = page.calcIntervalHour(start_time, end_time);
                        $('#worktime').val(work_time);
                    });

                    $('#start').attr('disabled', false);
                    $('#end').attr('disabled', false);
                    $('.modalBtnContainer-addEvent').show();
                    $('.modalBtnContainer-modifyEvent').hide();
                    $('#batchSection').css('display', 'block');
                    //$('#eventModal').modal('show');
                    $('#start').val(CommonUtil.getYYYYMMDD());
                    $('#end').val(CommonUtil.getYYYYMMDD(+7));
                    picker.bind({
                        target: $('[data-ax5picker="multi"]'),
                        direction: "top",
                        locale: {
                            format: 'YYYY-MM-DD'
                        },
                        content: {
                            width: 214,  // 130, //270,
                            margin: 10,
                            type: 'date',

                            config: {
                                control: {
                                    left: '<i class="fa fa-arrow-left"></i>',   //fa-chevron-left
                                    yearTmpl: '%s',
                                    monthTmpl: '%s',
                                    right: '<i class="fa fa-arrow-right"></i>'
                                },
                                lang: {
                                    yearTmpl: "%s년",
                                    months: ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'],
                                    dayTmpl: "%s"
                                }
                            }
                        },
                        btns: {
                            /*ok: {
                                label: "조회", theme: "default", onClick: function () {
                                    this.self.close();
                                    page.searchDataBind();


                                }
                            }*/
                        },
                        onStateChanged: function () {

                        }
                    });
                    $('#holiday_yn').on('click', function () {
                        page.holidayCheck();
                    });
                    //일괄등록버튼 클릭
                    $('#btnInsert').unbind();
                    $('#btnInsert').on('click', function () {
                        let holiday_yn = '';
                        if ($('#holiday_yn').prop('checked'))
                            holiday_yn = $('#holiday_yn').val();
                        let eventData = {
                            _id: null,
                            factory_pk: $('#factory_pk').val(),
                            //start: $('#start').val() + ' ' + $('#startTime').val(),
                            //end: $('#end').val() + ' ' + $('#endTime').val(),
                            date_from: $('#start').val(),
                            date_to: $('#end').val(),
                            holiday_yn: holiday_yn,
                            start: $('#startTime').val(),
                            end: $('#endTime').val(),
                            worktime: $('#worktime').val(),
                            //color: __this.centerColor($('#work_center_pk').val()),
                        };
                        if (!eventData.factory_pk) {
                            Alert.alert('', '공장을 선택하십시오.');
                            return;
                        }

                        _this.saveCalendar(eventData, true);
                        modalContainer.close();
                    });
                });


            }

            eventRender(event, element, view) {
                let _this = this;
                let selectTitle = event.factory_name;
                //let key = 'wc' + event.work_center_pk;
                //let bgcolor = _this.dicWorkcenterColor[key];
                //if (element[0].querySelector('.fc-title')) {
                //    element[0].querySelector('.fc-title').innerHTML = "<b>" + selectTitle + "</b>";
                //    if (event.holiday_yn == 'Y') {
                //      element.css('background-color', '#FF0000');
                //    }else {
                //      element.css('background-color', bgcolor);
                //    }
                //} else if (element[0].querySelector('.fc-list-item-title')) {
                //        //let dotCss = element[0].querySelector('.fc-event-dot').css();
                //        //let dotCss = $('.fc-event-dot')
                //    element[0].querySelector('.fc-list-item-title').innerHTML = "<b>" + selectTitle + "</b>";
                //    //if (event.holiday_yn == 'Y') {
                //    //    $('span .fc-event-dot').prop('background-color', '#FF0000');
                //    //}
                //    //else {
                //    //    //element.css('background-color', bgcolor);
                //    //    $('span .fc-event-dot').prop('background-color', bgcolor);
                //    //}
                //}
                ////element[0].querySelector('.fc-title').innerHTML = "<b>테스트</b>";
                //if (event.holiday_yn == 'Y') {
                //    element.css('background-color', '#FF0000');
                //    //element[0].querySelector('.fc-event-dot').css('background-color', '#FF0000');
                //}
                //else {
                //    element.css('background-color', bgcolor);
                //}

                //element.css('border-color', bgcolor);

                if (element[0].querySelector('.fc-title')) {
                    element[0].querySelector('.fc-title').innerHTML = "<b>" + selectTitle + "</b>";
                } else if (element[0].querySelector('.fc-list-item-title')) {
                    element[0].querySelector('.fc-list-item-title').innerHTML = "<b>" + selectTitle + "</b>";
                }

                //일정에 hover시 요약
                element.popover({
                    title: $('<div />', {
                        class: 'popoverTitleCalendar',
                        text: event.factory_name
                    }).css({
                        'background': event.backgroundColor,
                        'color': event.textColor
                    }),
                    content: $('<div />', {
                        class: 'popoverInfoCalendar'
                    })
                        //.append('<p><strong>시간:</strong> ' + moment(event.start).format('HH:mm') + '~' + moment(event.end).format('HH:mm') + '</p>')
                        .append('<p><strong>' + event.factory_name + '</strong></p>')
                        .append('<p><strong>시간:</strong> ' + this.getDisplayEventDate(event) + '</p>')
                        .append('<p><strong>순근무시간:</strong> ' + parseInt(event.worktime) + '(시간)</p>'),
                    delay: {
                        show: "500",
                        hide: "50"
                    },
                    trigger: 'hover',
                    placement: 'top',
                    html: true,
                    container: 'body'
                });

            }

            //수정
            eventClick(event, jsEvent, view) {
                let _this = this;
                //$('#eventModal').modal('show');
                let data = {'id': ''}
                let content = tmpl('eventTmpl', data);
                let $content = $(content);
                let modalContainer;
                modalContainer = new PopupDraggable('일정 수정');
                modalContainer.open({width: 600, height: 250, $content});

                AjaxUtil.fillSelectOptions($('#factory_pk'), 'factory', 'choose', false);
                $('.modalBtnContainer-addEvent').hide();
                $('.modalBtnContainer-modifyEvent').show();
                $('#modalForm').find('batchSection').css('display', 'none');
                $('.popover.fade.top').remove();
                if (event.end === null) {
                    event.end = event.start;
                }
                page.timeSetting();
                $('#_id').val(event._id);
                event.startTime = moment(event.start._d).format('HH:mm');
                event.endTime = moment(event.end._d).format('HH:mm');
                event.start = moment(event.start._d).format('YYYY-MM-DD');
                event.end = moment(event.end._d).format('YYYY-MM-DD');
                FormUtil.BindDataForm(event, $('#modalForm'));
                $('#start').attr('disabled', true);
                $('#end').attr('disabled', true);

                if ($('#holiday_yn').prop('checked')) {
                    page.holidayCheck();
                }

                $('#holiday_yn').on('click', function () {
                    page.holidayCheck();
                });

                $('#btnUpdate').unbind();
                //저장버튼 (수정)
                $('#btnUpdate').on('click', function () {
                    //let std = $('#start').val() + ' ' + $('#startTime').val();
                    //let end = $('#end').val() + ' ' + $('#endTime').val();
                    let data_date = $('#start').val();
                    let std = $('#startTime').val();
                    let end = $('#endTime').val();
                    let holiday_yn = '';
                    if ($('#holiday_yn').prop('checked'))
                        holiday_yn = $('#holiday_yn').val();
                    //event.color = _this.centerColor($('#work_center_pk').val());
                    event.factory_pk = $('#factory_pk').val();
                    event.data_date = data_date;
                    event.holiday_yn = holiday_yn;
                    event.start = std;
                    event.end = end;
                    event.worktime = $('#worktime').val();
                    _this.saveCalendar(event);
                    modalContainer.close();
                });
                // 삭제버튼
                $('#btnDelete').on('click', function (event) {
                    let url = '/api/support/work_calendar/delete';
                    let data = {id: $('#_id').val()};
                    let fnSuccess = function (res) {
                        if (res.success) {
                            Alert.alert('','삭제되었습니다.');
                            _this.refreshCalendar();
                            modalContainer.close();
                        } else {
                            Alert.alert('','삭제에 실패했습니다.');
                            _this.refreshCalendar();
                        }
                    }
                    AjaxUtil.postAsyncData(url, data, fnSuccess);
                });
            }

            //날짜 클릭
            dayClick(startDate, jsEvent, view) {
                let today = moment();
                let endDate;
                if (view.name == "month") {
                    startDate.set({
                        hours: today.hours(),
                        minute: today.minutes()
                    });
                    startDate = moment(startDate).format('YYYY-MM-DD HH:mm');
                    endDate = moment(startDate); //.subtract(1, 'days');

                    endDate.set({
                        hours: today.hours() + 1,
                        minute: today.minutes()
                    });
                    endDate = moment(endDate).format('YYYY-MM-DD HH:mm');
                } else {
                    startDate = moment(startDate).format('YYYY-MM-DD HH:mm');
                    endDate = moment(endDate).format('YYYY-MM-DD HH:mm');
                }

                this.newEvent(startDate, endDate, $(this).html());
            }

            //드롭
            eventDrop(event, delta, revertFunc, jsEvent, ui, view) {
                $('.popover.fade.top').remove();
                $('#batchSection').css('display', 'none');
                if (event.start._d) {
                    //event.start = moment(event.start._d).format('YYYY-MM-DD HH:mm');
                    //event.end = moment(event.end._d).format('YYYY-MM-DD HH:mm');
                    let start = moment(event.start._d);
                    event.data_date = start.format('YYYY-MM-DD');
                    event.start = start.format('HH:mm');
                    event.end = moment(event.start._d).format('H:mm');
                }
                this.saveCalendar(event);
            }

            //신규
            newEvent(start, end, eventType) {
                let _this = this;
                let data = {'id': ''}
                let content = tmpl('eventTmpl', data);
                let $content = $(content);
                let modalContainer;
                modalContainer = new PopupDraggable('일정 등록');
                modalContainer.open({width: 1220, height: 320, $content});
                AjaxUtil.fillSelectOptions($('#factory_pk'), 'factory', 'choose', false);
                page.timeSetting();
                $('#start').attr('disabled', true);
                $('#end').attr('disabled', true);
                $('.modalBtnContainer-addEvent').show();
                $('.modalBtnContainer-modifyEvent').hide();
                $('#batchSection').css('display', 'none');
                $('#eventModal').modal('show');
                $('#start').val(start.split(' ')[0]);
                $('#startTime').val(start.split(' ')[1]);
                $('#end').val(end.split(' ')[0]);
                $('#endTime').val(end.split(' ')[1]);
                let work_time = page.calcIntervalHour($('#startTime').val(), $('#endTime').val());
                $('#worktime').val(work_time);

                //휴일?
                $('#holiday_yn').on('click', function () {
                    page.holidayCheck();
                });

                // 신규 저장
                $('#btnInsert').unbind();
                $('#btnInsert').on('click', function () {
                    let holiday_yn = '';
                    if ($('#holiday_yn').prop('checked'))
                        holiday_yn = $('#holiday_yn').val();
                    let data = {
                        _id: null,
                        factory_pk: $('#factory_pk').val(),
                        //start: $('#start').val() + ' ' + $('#startTime').val(),
                        //end: $('#end').val() + ' ' + $('#endTime').val(),
                        data_date: $('#start').val(),
                        holiday_yn: holiday_yn,
                        start: $('#startTime').val(),
                        end: $('#endTime').val(),
                        worktime: $('#worktime').val(),
                        //color: _this.centerColor($('#work_center_pk').val()),
                        //allDay: false
                    };
                    if (!data.factory_pk) {
                        Alert.alert('', '공장을 선택해주세요');
                        return;
                    }
                    _this.saveCalendar(data, true);
                    modalContainer.close();
                });
            }

            select(startDate, endDate, jsEvent, view) {

                let today = moment();

                if (view.name == "month") {
                    startDate.set({
                        //hours: today.hours(),
                        hours: 9,
                        //minute: today.minutes()
                        minute: 0
                    });
                    startDate = moment(startDate).format('YYYY-MM-DD HH:mm');
                    endDate = moment(endDate).subtract(1, 'days');

                    endDate.set({
                        //hours: today.hours() + 1,
                        hours: 18,
                        //minute: today.minutes()
                        minute: 0
                    });
                    endDate = moment(endDate).format('YYYY-MM-DD HH:mm');
                } else {
                    startDate = moment(startDate).format('YYYY-MM-DD HH:mm');
                    endDate = moment(endDate).format('YYYY-MM-DD HH:mm');
                }
                if (moment(startDate).format('YYYY-MM-DD') != moment(endDate).format('YYYY-MM-DD'))
                    return;
                this.newEvent(startDate, endDate, $(this).html());
            }

            //파트별 색상 설정
            centerColor(factory_pk) {
                let setColor = '';
                let pk = parseInt(factory_pk);
                if (pk === 1) {
                    setColor = '#6bb191';
                } else if (pk === 2) {
                    setColor = '#36bce7';
                } else if (pk === 3) {
                    setColor = '#7993ba';
                } else {
                    let letters = '0123456789ABCDEF';
                    setColor = '#';
                    for (var i = 0; i < 6; i++) {
                        setColor += letters[Math.floor(Math.random() * 16)];
                    }
                }
                return setColor;
            }

            //drop, edit, new 저장 이벤트
            saveCalendar(data, newEvent) {
                let _this = this;
                let url = null;
                let param = null;
                if (!data.factory_pk) {
                    Alert.alert('', '공장을 선택하십시오.');
                    return;
                }
                if (data.holiday_yn != 'Y') {
                    if (!data.start || !data.end) {
                        Alert.alert('', '출근-퇴근시간을 입력하십시오.');
                        return;
                    }
                    if (!data.worktime) {
                        Alert.alert('', '순근무시간을 선택하십시오.');
                        return;
                    }
                    if (data.start > data.end) {
                        Alert.alert('', '종료 시간이 시작시간보다 앞설 수 없습니다.');
                        return;
                    }
                }
                if (!data.factory_pk || !data.worktime) {
                    Alert.alert('', '미입력 값이 있습니다');
                    return;
                }
                if ($('#modalForm').find('#batchSection').css('display') === 'none') {
                    if (!data.data_date) {
                        Alert.alert('', '일자를 선택하십시오.');
                        return;
                    }
                    let events = $('#calendar').fullCalendar('clientEvents');
                    let cnt = newEvent ? 0 : 1;//edit
                    let factory_pk = parseInt(data.factory_pk);

                    if (events.filter(x => moment(x.start).format('YYYY-MM-DD') === moment(data.start).format('YYYY-MM-DD') && factory_pk === parseInt(x.factory_pk)).length > cnt) {
                        $('#calendar').fullCalendar('refetchEvents');
                        Alert.alert('', '동일한 공장 데이터가 존재합니다.');
                        return;
                    }

                    url = '/api/support/work_calendar/save';
                    param = {
                        id: data._id,
                        data_date: data.data_date,
                        holiday_yn: data.holiday_yn,
                        start: data.start,
                        end: data.end,
                        factory_pk: data.factory_pk,
                        worktime: data.worktime
                    }

                } else {
                    if (!data.date_from || !data.date_to) {
                        Alert.alert('', '일자를 선택하십시오.');
                        return;
                    }
                    url = '/api/support/work_calendar/multi_save';
                    param = {
                        id: data._id,
                        date_from: data.date_from,
                        date_to: data.date_to,
                        holiday_yn: data.holiday_yn,
                        start: data.start,
                        end: data.end,
                        factory_pk: data.factory_pk,
                        worktime: data.worktime,
                        weekdays: $("#checkTable input:checkbox:checked").map(function () {
                            return $(this).val();
                        }).get().join(',')
                    }

                }
                let fnSuccess = function (res) {
                    if (res.success) {
                        Alert.alert('','저장되었습니다.'); // Notification
                        _this.refreshCalendar();
                        return true;
                    } else {
                        Alert.alert('','저장에 실패했습니다'); // Notification
                    }
                };
                AjaxUtil.postAsyncData(url, param, fnSuccess);

            }

            refreshCalendar() {
                //$('#eventModal').modal('hide');
                $('#calendar').fullCalendar('refetchEvents');
            }
        }

        let page = null;
        $(document).ready(function (e) {
            page = new WorkCalendarPage();
            page.initEvent();

            $('#calendar').fullCalendar({
                header: {
                    left: 'today, prevYear, nextYear, viewWeekends',
                    center: 'prev, title, next',
                    right: 'month, listWeek, listDay'
                },
                views: {
                    month: {eventLimit: 3}, // 한 날짜에 최대 이벤트 3개, 나머지는 + 처리됨
                    listWeek: {buttonText: '주'},
                    listDay: {buttonText: '일'},
                },
                locale: 'ko',
                timezone: "local",
                timeFormat: 'HH:mm',
                allDaySlot: true,
                displayEventTime: true,
                displayEventEnd: true,
                dayMaxEvents: true,
                defaultTimedEventDuration: '00:30:00',
                defaultDate: moment(moment(new Date()).format('YYYY-MM-DD')),
                editable: true,
                selectable: true,
                fixedWeekCount: false, //true : 한달 6주로 고정
                minTime: '00:00:00',
                maxTime: '24:00:00',
                timeFormat: 'HH:mm',
                slotLabelFormat: 'HH:mm',
                eventLimitClick: 'week', //popover
                contentHeight: 650,
                disableResizing: true,
                eventDurationEditable: false,
                eventRender: function (event, element, view) {
                    return page.eventRender(event, element, view);
                },
                //이벤트 클릭시 수정이벤트
                eventClick: function (event, jsEvent, view) {
                    page.eventClick(event, jsEvent, view);
                },
                //eventAfterAllRender: function (view) {
                //    if (view.name == "month") $(".fc-content").css('height', 'auto');
                //},
                eventAfterAllRender: function (view, a, b, c, d) {
                    if (view.name == "month") {
                        $(".fc-content").css('height', 'auto');
                    } else if (view.name == "listWeek") {
                        var filterTr = $('.fc-list-table tr');
                        var grpIdx = 0;
                        filterTr.toArray().forEach(function (e, idx) {
                            if ($(e).hasClass('fc-list-heading')) {
                                grpIdx++;
                            }
                            $(e).attr('idx', grpIdx);
                        })
                        filterTr.filter('.fc-list-heading').on('click', function (e, idx) {
                            var targetValue = $(e.currentTarget).attr('idx');
                            $('.fc-list-item[idx=' + targetValue + ']').toggle();
                        })
                    }

                },
                //일정 리사이즈
                //eventResize: function (event, delta, revertFunc, jsEvent, ui, view) {$('.popover.fade.top').remove();},                
                eventResize: function (event, delta, revertFunc, jsEvent, ui, view) {
                    $('.popover.fade.top').remove();
                },
                eventDragStart: function (event, jsEvent, ui, view) {
                    draggedEventIsAllDay = event.allDay;
                },
                //eventDragStart: function (event, jsEvent, ui, view) {},
                //일정 드래그앤드롭
                eventDrop: function (event, delta, revertFunc, jsEvent, ui, view) {
                    page.eventDrop(event, delta, revertFunc, jsEvent, ui, view);
                },
                //select: function (startDate, endDate, jsEvent, view) {
                //    return page.select(startDate, endDate, jsEvent, view);
                //},
                dayClick: function (startDate, jsEvent, view) {

                    return page.dayClick(startDate, jsEvent, view);
                },
                events: function (start, end, timezone, callback) {
                    //let url = '/api/support/work_calendar?keyword=' + $('#calendar').fullCalendar('getDate').format('YYYY-MM');
                    let url = '/api/support/work_calendar';
                    let param = {
                        'action': 'read',
                        'data_month': $('#calendar').fullCalendar('getDate').format('YYYY-MM'),
                        'factory_pk': $('#search_factory').val(),
                    };
                    let result = AjaxUtil.getSyncData(url + '/read', param);
                    if (result.data != null) {
                        result.data.forEach(function (item) {
                            var key = 'f' + item.factory_pk;
                            var color = page.dicWorkcenterColor[key];

                            if (item.holiday_yn == 'Y') {
                                color = '#FF0000'
                            }

                            item.color = color;
                        });
                        callback(result.data);
                    }
                    //   $.ajax({
                    // type: "get",
                    // url: url,
                    // dataType : "json",
                    // cache : false,
                    // success: function(res) {
                    //  callback(res);
                    // },
                    //       error: function (jqXHR, status, error) {
                    // }
                    //});
                },
            });

        });
    </script>
</th:block>
</html>
