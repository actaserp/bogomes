<html layout:decorate="~{layout_page}">
<head>
    <style>
        .wx210{
            width: 210px !important;
        }
        .wx190{
            width: 150px !important;
        }

    </style>
</head>
<th:block layout:fragment="content">
    <div class="layout-contents">
        <div class="page-title-wrap">
            <div class="left">
                <h2>방충방서트랩구분</h2>
                <a title="북마크" class="bookmark toggle">
                    내 메뉴
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
                <li>HACCP 기준정보</li>
                <li>방충방서트랩구분</li>
            </ul>
        </div>

        <section class="section">
            <div class="section-top">

                <div class="search-wrap">

                    <dl>
                        <dt>
                            <label>
                                기준일<span class="eq"></span>
                            </label>
                        </dt>
                        <dd>
                            <input type="date" class="form-control2" value="" id="txtBaseDate" name="txtBaseDate" placeholder="" title="" />
                        </dd>
                    </dl>

                    <dl>
                        <dt>&nbsp;</dt>
                        <dd>
                            <li>
                                <a class="btn btn-delete" title="검색" id="btnSearch">
                                    <!--                                        class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                                    <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                    검색
                                </a>
                            </li>
                        </dd>
                    </dl>
                </div>

            </div>
            <!--<div class="button-wrap">
                <ul>
                    <li style="cursor: default; list-style-image: none;">
                        <button class="btn" id="btnDown" title="순서 조정-아래로"><i class="fas fa-arrow-down"></i></button>

                    </li>
                    <li style="cursor: default; list-style-image: none;">
                        <button class="btn" id="btnUp" title="순서 조정-위로"><i class="fas fa-arrow-up"></i></button>

                    </li>
                    <li style="cursor: default; list-style-image: none;">
                        <button class="btn y_write_auth" id="btnOrderSave"><span data-labelCd="순서 저장">순서 저장</span></button>
                    </li>
                </ul>
            </div>-->
            <div id="theGrid" style="height: 450px;"></div>
        </section>

        <section>
            <div class="grid_box">

                <div class="tab-wrap">

                    <ul class="tab-links">
                        <li><a href="#tabJobRes" style="border-radius: 0">기본 정보</a></li>
                        <li><a href="#tabSemi" style="border-radius: 0">포획 해충</a></li>
                    </ul>
                    <div>

                        <section class="tab-item section" id="tabJobRes" style="border-top-left-radius: 0;">
                            <div class="button-wrap">
                                <ul>
                                    <li style="cursor: default; list-style-image: none;">
                                        <button class="btn" id="btnNew" ><i class="fas fa-plus"></i></button>
                                    </li>
                                    <li style="cursor: default; list-style-image: none;">
                                        <button class="btn y_write_auth" id="btnDel" disabled><i class="fas fa-trash"></i></button>
                                    </li>
                                    <li style="cursor: default; list-style-image: none;">
                                        <button class="btn y_write_auth" id="btnSave" disabled><i class="fas fa-save"></i></button>
                                    </li>
                                    <li style="cursor: default; list-style-image: none;">
                                        <button class="btn y_write_auth" id="btnSaveAsNew" disabled>새 항목으로 저장</button>
                                    </li>

                                </ul>
                            </div>
                            <form id="detailForm" class="form-group" style="width: 100%;">
                                <input type="hidden" id="id" name="id" />
                                <div class="section-top" id="detail_box">
                                    <div class="table-wrap">
                                        <input class="form-control2"  type="text" id="id" name="id" hidden/>
                                        <table class="write-table">
                                            <caption>작업 지시 테이블</caption>
                                            <tbody>
                                            <tr>
                                                <th style="text-align: center">
                                                    <label>코드</label>
                                                </th>
                                                <td>
                                                    <input class="form-control2" type="text" id="Code" name="Code" disabled="disabled" required>
                                                </td>
                                                <th style="text-align: center">
                                                    <label>*트랩구분명</label>
                                                </th>
                                                <td>
                                                    <input class="form-control2" type="text" id="Value" name="Value" disabled="disabled" required>
                                                </td>
                                            </tr>


                                            <tr>
                                                <th style="text-align: center">
                                                    <label>적용기간</label>
                                                </th>
                                                <td colspan="8">
                                                    <input class="form-control2 tac" type="date" id="StartDate" name="StartDate" disabled="disabled" required>
                                                    ~
                                                    <input class="form-control2 tac" type="date" id="EndDate" name="EndDate" value="2100-12-31" disabled="disabled" required></td>
                                            </tr>


                                            </tbody>
                                        </table>

                                    </div>
                                </div>
                            </form>
                        </section>
                        <!-- ㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁㅁ -->

                        <section class="tab-item section" id="tabSemi" style="border-top-left-radius: 0;">
                            <div class="button-wrap">
                                <ul>
                                    <li style="cursor: default; list-style-image: none;">
                                        <select id="cboPest" name="cboPest"></select>
                                    </li>
                                    <li style="cursor: default; list-style-image: none;">
                                        <button type="button" class="btn" id="btnAddPest" name="btnAddPest" ><i class="fas fa-plus"></i></button>
                                    </li>
                                    <li style="cursor: default; list-style-image: none;">
                                        <button type="button" class="btn" id="btnDelPest" name="btnDelPest" ><i class="fas fa-trash"></i></button>
                                    </li>
                                    <li style="cursor: default; list-style-image: none;">
                                        <button type="button" class="btn" id="btnUpPest" title="순서 조정-위로"><i class="fas fa-arrow-up"></i></button>
                                    </li>
                                    <li style="cursor: default; list-style-image: none;">
                                        <button type="button" class="btn" id="btnDownPest" title="순서 조정-아래로"><i class="fas fa-arrow-down"></i></button>
                                    </li>
                                    <li style="cursor: default; list-style-image: none;">
                                        <button type="button" class="btn y_write_auth" id="btnSavePest" ><i class="fas fa-save"></i></button>
                                    </li>
                                    <li style="cursor: default; list-style-image: none;">
                                        <button type="button" class="btn y_write_auth" id="btnPestOrderSave"><span data-labelCd="순서 저장">순서 저장</span></button>
                                    </li>

                                </ul>
                            </div>
                            <div class="grid_box">
                                <div id="pest_grid"></div>
                            </div>
                        </section>


                    </div>
                </div>

            </div>
        </section>
    </div>

</th:block>

<th:block layout:fragment="scripts">
    <script type="text/javascript" src="/js/grid.js?ver=22080801"></script>
    <script type="text/javascript">

        class CodePage {

            constructor() {

                this.grid = null;
                this.pest_grid = null;
                this.viewData = new wijmo.collections.CollectionView();
                this.viewData2 = new wijmo.collections.CollectionView();

                this.baseUrl = '/api/precedence/pest_trap';
                this.parent_code = 'pest_trap_class';
                this.table_name2 = 'master_t';
                this.relation_name = 'trap_class-pest';

                this.deletedRow = [];
                this.modifiedRow = [];
                this.defaultList = [];

                this.init();

            }

            init() {
                let _this = this;

                this.grid = new wijmo.grid.FlexGrid('#theGrid', {
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    columns: [

                        { binding: 'id', header: '번호', width: '*', align: 'left', visible: false},
                        { binding: 'code', header: '코드', width: '*', align: 'left' },
                        { binding: 'name', header: '트랩구분', width: '*', align: 'left' },
                        { binding: 'start_date', header: '적용시작일', width: '*', align: 'center' },
                        { binding: 'end_date', header: '적용종료일', width: '*', align: 'center' },

                    ],
                    itemsSource: this.viewData,
                    formatItem: function (s, e) {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center'; // 헤더 텍스트 가운데 정렬

                        }
                    },
                });

                this.grid.selectionChanged.addHandler((s, e) => {


                    let selectedRowIndex = s.selection.row; // 선택된 행의 인덱스
                    if (selectedRowIndex >= 0) { // 유효한 행이 선택되었는지 확인
                        let selectedRowData = s.rows[selectedRowIndex].dataItem; // 선택된 행의 데이터

                        _this.showDetail(selectedRowData.id);
                        _this.showPestList();
                        console.log('zz', _this.pest_grid.collectionView.items);

                        _this.defaultList = JSON.parse(JSON.stringify(_this.pest_grid.collectionView.items));


                        console.log(`선택된 행 인덱스: ${selectedRowIndex}`);
                        console.log('선택된 행 데이터:', selectedRowData);

                    }
                });
                new FlexGridContextMenu(this.grid);
                this.grid.downloadFileName = '방충방서트랩구분';


                this.pest_grid = new wijmo.grid.FlexGrid('#pest_grid', {
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: false,
                    columns: [

                        { binding: 'id', header: '번호', width: '*', align: 'left', isReadOnly: true},
                        { binding: 'data_pk2', header: '해충번호', width: '*', align: 'left', isReadOnly: true},
                        { binding: 'code', header: '코드', width: '*', align: 'left', isReadOnly: true },
                        { binding: 'name', header: '트랩구분', width: '*', align: 'left', isReadOnly: true },

                        {
                            binding: 'start_date',
                            header: '적용시작일',
                            width: '*',
                            align: 'center',
                            isReadOnly: false, // 수정 가능
                            editor: new wijmo.input.InputDate(document.createElement('div'), {
                                format: 'yyyy-MM-dd',
                                placeholder: '날짜 선택',
                                isRequired: true // 필수 입력
                            }),
                            format: 'yyyy-MM-dd'
                        },
                        {
                            binding: 'end_date',
                            header: '적용종료일',
                            width: '*',
                            align: 'center',
                            isReadOnly: false, // 수정 가능
                            editor: new wijmo.input.InputDate(document.createElement('div'), {
                                format: 'yyyy-MM-dd',
                                placeholder: '날짜 선택',
                                isRequired: true // 필수 입력
                            }),
                            format: 'yyyy-MM-dd'
                        }
                        //TODO: check

                    ],
                    itemsSource: this.viewData2,
                    formatItem: function (s, e) {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center'; // 헤더 텍스트 가운데 정렬

                        }
                    },
                });
                AjaxUtil.fillSelectOptions($('#cboPest'), 'master_data', 'choose', false, 'pest');
            }

            // 버튼 활성화 설정
            setButtonState() {
                let pk = $('#detailForm').find('#id').val();
                $('#btnNew').prop('disabled', false);
                $('#btnSave').prop('disabled', false);
                if (pk) {
                    $('#btnDel').prop('disabled', false);
                    $('#btnSaveAsNew').prop('disabled', false);
                }
                else {
                    $('#btnDel').prop('disabled', true);
                    $('#btnSaveAsNew').prop('disabled', true);
                }
            }

            // 창고 목록 조회
            searchMainData() {
                let _this = this;
                let url = this.baseUrl;
                let param = {
                    'parent_code': _this.parent_code,
                    'base_date': $('#txtBaseDate').val(),
                };

                let result = AjaxUtil.getSyncData(url + "/read", param);
                if (result != null) {
                    _this.viewData.sourceCollection = result.data;
                }

                $('#detailForm')[0].reset();
                $('#detailForm').find('#id').val('');
                $('#StartDate').val(_this.today_string);

                $('#detail_box').find('input, select, textarea').each(function () {
                    if (!$(this).is(':disabled')) {
                        $(this).attr('disabled', 'disabled');
                    }
                });

                this.setButtonState();
            }


            // 상세정보 조회
            showDetail(id) {
                let param = { 'id': id };
                let url = this.baseUrl;
                let result = AjaxUtil.getSyncData(url + "/detail", param);

                if (result != null) {
                    FormUtil.BindDataForm(result.data, $('#detailForm'));
                }

                this.setButtonState();
            }

            // 창고 정보 저장
            saveInfo(bSaveAsNew = false) {
                let _this = this;
                let validate = true;
                let $target = null;
                let url = this.baseUrl + '/save';

                //let data = $('#detailForm').serialize();
                let data = FormUtil.extractForm($('#detailForm'));
                data['parent_code'] = _this.parent_code;

                if (bSaveAsNew)
                    data.id = '';

                let fnSuccess = function (result) {
                    if (result.success) {
                        Notify.success("저장되었습니다.");
                        _this.searchMainData();
                    }
                    else
                        Alert.alert('에러', result.message);
                }

                // 필수입력 check routine
                $('#detail_box').find('input, select, textarea').each(function () {
                    if ($(this).is(':required')) {
                        if (!$(this).val()) {
                            validate = false;
                            $target = $(this);
                            return false;
                        }
                    }
                });

                if (validate) {
                    AjaxUtil.postAsyncData(url, data, fnSuccess);
                } else {
                    Alert.alert('', '필수 항목을 입력해주세요.', function () {
                        $target.focus();
                    });
                }
            }

            // 정보 삭제
            deleteData() {
                let _this = this;
                let url = this.baseUrl + '/delete';
                let id = $('#detailForm').find('#id').val();
                let data = { id: id };
                let fnSuccess = function (res) {
                    if (res.success) {
                        Notify.success('삭제되었습니다');
                        _this.searchMainData();
                    } else {
                        Alert.alert('', res.message);
                    }
                }
                AjaxUtil.postAsyncData(url, data, fnSuccess);
            }

            showPestList() {
                let _this = this;
                let id = $('#detailForm').find('#id').val();
                let param = {
                    table_name2: _this.table_name2,
                    relation_name: _this.relation_name,
                    base_id: id,
                };
                let result = AjaxUtil.getSyncData(_this.baseUrl + "/relation_data_list", param);

                if (result != null) {
                    _this.viewData2.sourceCollection = result.data;
                }
            }

            addPest() {
                let _this = this;
                let row = {};
                let pest_id = $('#cboPest').val();
                let name = $("#cboPest option:selected").text();
                let code = $('#cboPest option:selected').data('code');
                let already = false;
                page.pest_grid.collectionView.items.forEach(function (row) {
                    if (row.data_pk2 == pest_id)
                        already = true;
                });
                if (already)
                    return;

                row["data_pk2"] = pest_id;
                row["name"] = name;
                row["code"] = code;
                row["start_date"] = _this.today_string;
                row["end_date"] = '2100-12-31';

                _this.addNewRow(row);
            }

            addNewRow(data) {
                let cv = this.pest_grid.collectionView;
                cv.addNew(data);
                cv.commitNew();
            }

            deletePest() {
                let _this = this;
                _this.deleteRow(_this.pest_grid);
            }

            deleteRow(grid) {

                let _this = this;

                let cv = grid.collectionView;

                let selectedItems = grid.selectedItems; // 선택된 데이터 가져오기

                if (selectedItems.length > 0) {
                    selectedItems.forEach(item => {
                        console.log(item.id);
                        if(item.id !== null && item.id !== undefined){
                            _this.deletedRow.push(item)
                        }
                        cv.remove(item); // 데이터 삭제

                    });

                    cv.refresh(); // UI 업데이트
                }
            }

            savePest() {
                let _this = this;
                let url = _this.baseUrl + '/save_relation_data';

                let grid_list = _this.pest_grid.collectionView.items;



                let deleted = _this.deletedRow;
                let modified = [];

                //변경된 데이터 (추가 or 수정된 데이터) 있는지 체크
                grid_list.forEach((item) => {
                    console.log('eax', item)
                    if(item.id === null || item.id === undefined){
                        modified.push(item);
                    }else{
                        let defaultItem = _this.defaultList.find(d => d.id === item.id);
                        console.log('default', defaultItem);
                        if(defaultItem){
                            if(defaultItem.start_date !== item.start_date || defaultItem.end_date !== item.end_date){
                                modified.push(item);
                            }
                        }
                    }
                });

                console.log('modify', modified);
                //return;

                //let modified = _this.pest_grid.getList('modified');

                //let grid_data = JSON.stringify(_this.pest_grid.getList());
                let grid_data = {
                    deleted : deleted,
                    modified : modified,
                };
                grid_data = JSON.stringify(grid_data);
                console.log('grid_data', grid_data)
                let data = {
                    base_id: $('#detailForm').find('#id').val(),
                    table_name2: _this.table_name2,
                    relation_name: _this.relation_name,
                    Q: grid_data,
                };
                let fnSuccess = function (res) {
                    Notify.success('저장되었습니다'); // Notification
                    _this.showPestList();
                };
                AjaxUtil.postAsyncData(url, data, fnSuccess);
            }


            /*savePest() {
                let _this = this;
                let url = _this.baseUrl + '/save_relation_data';
                let deleted = _this.pest_grid.collectionView.items;
                let modified = _this.pest_grid.getList('modified');

                //let grid_data = JSON.stringify(_this.pest_grid.getList());
                let grid_data = {
                    deleted : deleted,
                    modified : modified,
                };
                grid_data = JSON.stringify(grid_data);

                let data = {
                    base_id: $('#detailForm').find('#id').val(),
                    table_name2: _this.table_name2,
                    relation_name: _this.relation_name,
                    Q: grid_data,
                };
                let fnSuccess = function (res) {
                    Notify.success('저장되었습니다'); // Notification
                    _this.showPestList();
                };
                AjaxUtil.postAsyncData(url, data, fnSuccess);
            }*/

            changeGridOrder(g, direction) {
                let _this = this;
                let cv = g.collectionView;
                let selectedRowIndex = g.selection.row;

                if (selectedRowIndex < 0) {
                    Alert.alert('', '순서를 변경할 제품을 선택하세요.');
                    return;
                }

                if (direction === "U") {


                    if (selectedRowIndex === 0) return;

                    let sourceList = cv.sourceCollection; // 데이터 리스트 가져오기

                    let temp = sourceList[selectedRowIndex - 1]; // 위의 행과 교환
                    sourceList[selectedRowIndex - 1] = sourceList[selectedRowIndex];
                    sourceList[selectedRowIndex] = temp;

                    cv.sourceCollection = [...sourceList];

                    cv.refresh();
                    g.select(selectedRowIndex - 1, 0);

                } else {
                    //console.log('select', g.selection)
                    let sourceList = cv.sourceCollection;

                    if (selectedRowIndex >= sourceList.length - 1) return;


                    let temp = sourceList[selectedRowIndex + 1];
                    sourceList[selectedRowIndex + 1] = sourceList[selectedRowIndex];
                    sourceList[selectedRowIndex] = temp;

                    cv.sourceCollection = [...sourceList];

                    cv.refresh();
                    g.select(selectedRowIndex + 1, 0);


                }

            }

        }

        let page = null;

        $(document).ready(function (e) {
            page = new CodePage();

            let today_string = CommonUtil.getYYYYMMDD();
            $('#txtBaseDate').val(today_string);
            $('#StartDate').val(today_string);
            page.today_string = today_string;

            // 검색버튼 클릭
            $('#btnSearch').click(function (e) { page.searchMainData(); });

            // 신규버튼
            $('#btnNew').click(function (e) {

                $('#detailForm')[0].reset();
                $('#detailForm').find('#id').val('');
                $('#detailForm').find('#StartDate').val(page.today_string);
                $('#detailForm').find('#EndDate').val('2100-12-31');

                $('#detail_box').find('input, select, textarea').each(function () {
                    if ($(this).is(':disabled')) {
                        $(this).removeAttr('disabled');
                    }
                });

                //page.setButtonDisable(true, false, true);
                page.setButtonState();
            });

            // 저장버튼
            $('#btnSave').click(function (e) {
                Alert.confirm('',
                    "저장하시겠습니까?",
                    function () {
                        page.saveInfo(false)
                    },
                    function () {
                    }
                );
            });
            $('#btnSaveAsNew').click(function (e) {
                Alert.confirm('',
                    '새 항목으로 저장하시겠습니까?',
                    function () {
                        page.saveInfo(true)
                    },
                    function () {
                    }
                )
            });

            // 삭제버튼
            $('#btnDel').click(function (e) {
                Alert.confirm('',
                    "삭제하시겠습니까?",
                    function () {
                        page.deleteData()
                    },
                    function () {
                    }
                );
            });

            $('#btnAddPest').click(function () {
                if (!$('#cboPest').val()) {
                    Alert.alert('', '해충을 선택해 주세요.');
                    return false;
                }
                page.addPest();
            });

            $('#btnDelPest').click(function () {
                page.deletePest();
            });

            $('#btnSavePest').click(function (e) {
                Alert.confirm('',
                    "저장하시겠습니까?",
                    function () { page.savePest() },
                    function () { }
                );
            });

            $("#btnUpPest").click(function (e) {
                page.changeGridOrder(page.pest_grid, "U");
            });

            $("#btnDownPest").click(function (e) {
                page.changeGridOrder(page.pest_grid, "D");
            });

            $('#btnPestOrderSave').click(function (e) {
                let code_list = page.pest_grid.collectionView.items;
                console.log('codelist2', code_list);
                Alert.confirm('확인', '순서를 저장하시겠습니까?', function () {
                    let items = [];
                    $.each(code_list, function (idx, item) {
                        items.push(item.id);
                    });

                    let data = {Q: items};
                    let url = page.baseUrl + '/rela_data_order_save';
                    let fnsuccess = function (res) {
                        Notify.success('저장했습니다.');
                        page.showPestList();
                    };
                    AjaxUtil.postAsyncData(url, data, fnsuccess);
                });
            });

            page.searchMainData();

        });
    </script>

</th:block>
</html>