<html layout:decorate="~{layout_page}">
<head>
    <style>
        .wj-header {
            text-align: center !important;
        }
    </style>
</head>
<th:block layout:fragment="content">
    <div class="layout-contents">

        <div class="page-title-wrap">
            <div class="left">
                <h2>공정 정보</h2>
                <a title="북마크" class="bookmark toggle">
                    내 메뉴
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
                <li>일지 및 데이터</li>
                <li>기준정보</li>
                <li>공정정보</li>
            </ul>
        </div>

        <section class="section">
            <div class="section-top">
                <div class="search-wrap">
                    <dl>
                        <dt>
                            <label>공정명</label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <input type="text" class="form-control2" id="txtProcess" name="txtProcess">
                            </div>
                        </dd>
                    </dl>

                    <dl>
                        <dt><span class="eq"></span></dt>
                        <dd>
                            <li>
                                <a class="btn btn-delete" title="검색" id="btnSearch">
                                    <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                    검색
                                </a>
                            </li>
                        </dd>
                    </dl>
                </div>
            </div>

            <div class="container-fluid">
                <p id="selectedItem"></p>
                <div id="theGrid" style="height: 520px; max-height: 520px;"></div>
            </div>
        </section>

        <div class="tab-wrap">
            <ul class="tab-links">
                <li><a href="#tab_basic">기본정보</a></li>
                <li><a href="#tab_defect_type">공장별부적합유형</a></li>
                <li><a href="#tab_stop_cause">공정별비가동유형</a></li>
            </ul>
            <div>
                <section class="tab-item" id="tab_basic" style="border-top-left-radius: 0;">
                    <div class="section-top">
                        <div class="button-wrap">
                            <ul>
                                <li>
                                    <a class="btn btn-edit" title="작업 지시 상세" id="">
                                        <img src="/images/icon/ico-edit.svg" alt="수정 아이콘">
                                        신규등록
                                    </a>
                                </li>

                                <li>
                                    <a class="btn btn-edit" title="작업 지시 상세" id="">
                                        <img src="/images/icon/ico-edit.svg" alt="수정 아이콘">
                                        삭제
                                    </a>
                                </li>

                                <li>
                                    <a class="btn btn-edit" title="작업 지시 상세" id="">
                                        <img src="/images/icon/ico-edit.svg" alt="수정 아이콘">
                                        저장
                                    </a>
                                </li>

                            </ul>
                        </div>

                        <div class="table-wrap" style=" overflow-x: auto;">
                            <form id="processForm">
                                <table class="write-table"
                                       style="width: 100%; border-collapse: collapse; table-layout: fixed;">
                                    <caption style="text-align: left; margin-bottom: 8px;">상세테이블</caption>
                                    <input type="hidden" id="id" name="id"/>
                                    <tbody>
                                    <tr>
                                        <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd;">
                                            <label for="factory_id">공장</label>
                                        </th>
                                        <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">
                                            <select type="text" id="factory_id" name="factory_id" style="width: 100%;"></select>
                                        </td>
                                        <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd;">
                                            <label for="process_type">공정구분</label>
                                        </th>
                                        <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">
                                            <input type="text" id="process_type" name="process_type" style="width: 100%;">
                                        </td>
                                        <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd;">
                                            <label for="process_code">공정코드</label>
                                        </th>
                                        <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">
                                            <input type="text" style="width: 100%;" id="process_code" name="process_code">
                                        </td>
                                        <th style="width: 7%; padding: 5px; border: 1px solid #ddd; text-align: center;">
                                            <label for="process_name">공정명</label>
                                        </th>
                                        <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">
                                            <input type="text" style="width: 100%;" id="process_name" name="process_name">
                                        </td>
                                    </tr>

                                    <tr>
                                        <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd;">
                                            <label for="description">설명</label>
                                        </th>
                                        <td style="width: 15%; padding: 5px; border: 1px solid #ddd;" colspan="7">
                                           <textarea id="description" name="description"></textarea>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </form>
                        </div>

                    </div>
                </section>

                <section class="tab-item" id="tab_defect_type" style="border-top-left-radius: 0;">
                    <div class="section-top">
                        <div class="button-wrap">
                            <ul>
                                <li>
                                    <select class="s-150" id="cboDefectType" name="cboDefectType" ></select>
                                </li>
                                <li>
                                    <button type="button" class="btn-default" id="btnAddDefectType" style="height: 36px; width:115px;"><i class="fas fa-plus"></i></button>
                                </li>
                                <li>
                                    <button type="button" class="btn-cancel y_write_auth" id="btnDelDefectType" style="float:none; height: 36px; width:115px;"><i class="fas fa-trash"></i></button>
                                </li>
                                <li>
                                    <button type="button" class="btn-default y_write_auth" id="btnSaveDefectType" style="float:none; height: 36px; width:115px;"><i class="fas fa-save"></i></button>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="container-fluid">
                        <p id="selectedItem"></p>
                        <div id="proc_defect_type_grid" style="height: 185px; max-height: 185px;"></div>
                    </div>
                </section>


                <section class="tab-item" id="tab_stop_cause" style="border-top-left-radius: 0;">
                    <div class="section-top">
                        <div class="button-wrap">
                            <ul>
                                <li>
                                    <select class="s-150" id="cboStopCause" name="cboStopCause" ></select>
                                </li>
                                <li>
                                    <button type="button" class="btn-default" id="btnAddStopCause" style="height: 36px; width:115px;"><i class="fas fa-plus"></i></button>
                                </li>
                                <li>
                                    <button type="button" class="btn-cancel y_write_auth" id="btnDelStopCause" style="float:none; height: 36px; width:115px;"><i class="fas fa-trash"></i></button>
                                </li>
                                <li>
                                    <button type="button" class="btn-default y_write_auth" id="btnSaveStopCause" style="float:none; height: 36px; width:115px;"><i class="fas fa-save"></i></button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="container-fluid">
                        <p id="selectedItem"></p>
                        <div id="proc_stop_cause_grid" style="height: 185px; max-height: 185px;"></div>
                    </div>
                </section>

            </div>
        </div>
    </div>


</th:block>

<th:block layout:fragment="scripts">
    <th:block th:replace="/common/approve_box :: approve_box"></th:block>
    <th:block th:replace="/common/ax5_uploader :: ax5_uploader"></th:block>
    <th:block th:replace="/common/upload_one_image_box :: upload_one_image_box"></th:block>
    <th:block th:replace="/common/popup_select_user_code :: popup_select_user_code"></th:block>
    <script type="text/javascript">


        var theGrid;
        var viewdata;

        let columns= [
            //{ binding: 'id', header: '번호', width: 80, align: 'center' },
            { binding: 'process_type', header: '공정구분', width: 150, align: 'left' },
            { binding: 'process_code', header: '공정코드', width: 150, align: 'left' },
            { binding: 'process_name', header: '공정명', width: 200, align: 'left' },
            { binding: 'factory_name', header: '공장', width: 150, align: 'left' },
            { binding: '', header: '', width: "*", align: 'left' },
        ];

        let columns2= [
            {  binding: 'id', header: '번호', width: 80, align: 'right', hidden: true },
            {  binding: 'defect_type_id', header: '부적합유형번호', width: 150, align: 'left' },
            {  binding: 'defect_type_code', header: '부적합유형코드', width: 150, align: 'left' },
            {  binding: 'defect_type_name', header: '부적합유형명', width: 200, align: 'left' },
        ];

        let columns3 = [
            {  binding: 'id',  header: '번호', width: 150, align: 'left', hidden:true },
            {  binding: 'stop_cause_id',  header: '비가동유형번호', width: 150, align: 'left' },
            {  binding: 'stop_cause_name',  header: '비가동유형명', width: 200, align: 'left' },
        ]

        document.readyState === 'complete' ? init() : window.onload = init;

        function init() {
            let data2 = [];
            let process_name = $('#txtProcess').val();

            $.ajax({
                url: '/api/definition/process/read',
                type: 'GET',
                data: {
                    'process_name': process_name,
                },
                async: false,
                success: function (data) {
                    data2 = data.data;
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error('Error fetching log_count data:', textStatus, errorThrown);
                }
            })

            viewdata = new wijmo.collections.CollectionView(data2);

            theGrid = new wijmo.grid.FlexGrid('#theGrid', {
                autoGenerateColumns: false,
                showMarquee: true,
                columns: columns,
                isReadOnly: true,
                itemsSource: viewdata
            });

            theGrid.hostElement.addEventListener('click', function (e) {
                let selectedItem = theGrid.selectedItems[0];
                console.log(selectedItem);

                /*
                document.getElementById('id').value = selectedItem.id;
                document.getElementById('material_type').value = selectedItem.material_type;
                 document.getElementById('material_group_code').value = selectedItem.material_group_code;
                 document.getElementById('material_group_name').value = selectedItem.material_group_name;*/

                /* setButtonState();*/
            });

            theGrid.rowHeaders.columns.splice(0, 1);
            /*  new FlexGridContextMenu(theGrid);*/
        }

        // 공정 목록 조회
       function searchMainData() {
            let _this = this;
            let param = {
                'action': 'read',
                'process_name': $('#txtProcess').val()
            }

            let result = AjaxUtil.getSyncData(this.url+'/read', param);

            if (result != null) {
                let count = result.data.length;
                _this.grid.setData({
                    list: result.data,
                    page: {
                        display: true,
                        totalElements: count,
                    }
                });
            }

            $('#processForm')[0].reset();
            $('#processForm').find('#id').val('');

            $('#processForm').find('input, select').each(function () {
                if (!$(this).is(':disabled')) {
                    $(this).attr('disabled', 'disabled');
                }
            });

            //_this.setButtonDisable(false, true, true);
            _this.setButtonState();
        }

        // 공정 상세정보 조회
        function  showDetailProcess(id) {
            let param = { 'process_id': id, 'action': 'detail' };
            let result = AjaxUtil.getSyncData(this.url+'/detail', param);

            if (result != null) {
                FormUtil.BindDataForm(result.data, $('#processForm'));
            }
            //page.setButtonDisable(false, false, false);
            page.setButtonState();
        }

        // 공정 정보 저장
        function saveProcess() {
            let _this = this;
            let validate = true;
            let $target = null;

            //let data = $('#processForm').serialize();
            let data = FormUtil.extractForm($('#processForm'));

            let fnSuccess = function (res) {
                if (res.success) {
                    Notify.success('저장되었습니다');
                    _this.searchMainData();
                    //_this.showDetailProcess(res.id);
                } else {
                    Alert.alert('', res.message);
                }
            }

            AjaxUtil.postAsyncData(this.url+"/save", data, fnSuccess);

            // 필수입력 check routine
            //$('#processForm').find('input, select').each(function () {
            //    if ($(this).is(':required')) {
            //        if (!$(this).val()) {
            //            validate = false;
            //            $target = $(this);
            //            return false;
            //        }
            //    }
            //});

            //if (validate) {
            //    AjaxUtil.postAsyncData(url, data, fnSuccess);
            //} else {
            //    Alert.alert('', '필수 항목을 입력해주세요.', function () {
            //        $target.focus();
            //    });
            //}
        }

        // 공정 정보 삭제
        function deleteProcess() {
            let _this = this;
            //let url = '/api/definition/process?action=delete';
            let id = $('#processForm').find('#id').val();

            let data = { 'id': id };
            let fnSuccess = function (res) {
                if (res.success) {
                    Notify.success('삭제되었습니다');
                    _this.searchMainData();
                } else {
                    Alert.alert('', res.message);
                }
            }
            AjaxUtil.postAsyncData(this.url+'/delete', data, fnSuccess);
        }

        // 공정별부적합유형
        function showProcDefectType() {
            let _this = this;
            let id = $('#processForm').find('#id').val();
            let param = {'proc_pk': id};
            let result = AjaxUtil.getSyncData(this.url+'/proc_defect_type_list', param);

            if (result != null) {
                let count = result.data.length;
                _this.proc_defect_type_grid.setData({
                    list: result.data,
                    page: {
                        display: true,
                        totalElements: count,
                    }
                });
            }
        }
        // 공정별비가동유형
        function showProcStopCause() {
            let _this = this;
            let id = $('#processForm').find('#id').val();
            let param = {'proc_pk': id};
            let result = AjaxUtil.getSyncData(this.url+'/proc_stop_cause_list', param);

            if (result != null) {
                let count = result.data.length;
                _this.proc_stop_cause_grid.setData({
                    list: result.data,
                    page: {
                        display: true,
                        totalElements: count,
                    }
                });
            }
        }

        function addDefectTypeRow() {
            let row = {};
            let defect_type_pk = $('#cboDefectType').val();
            let already = false;
            page.proc_defect_type_grid.getList().forEach(function (row) {
                if (row.defect_type_id == defect_type_pk)
                    already = true;
            });
            if (already)
                return;

            row["defect_type_id"] = defect_type_pk;
            row["defect_type_name"] = $("#cboDefectType option:selected").text();

            page.proc_defect_type_grid.addRow(
                row,
                'last',
                { __index: undefined }
            );
        }

        //공정별 부적합유형 저장
        function saveDefectType() {
            let _this = this;
            let grid_data = JSON.stringify(_this.proc_defect_type_grid.getList());
            let param = {
                'proc_pk': $('#id').val(),
                Q: grid_data
            };

            let fnSuccess = function (res) {
                Notify.success('저장되었습니다'); // Notification
                showProcDefectType();
            };
            AjaxUtil.postAsyncData(this.url+"/save_proc_defect_type", param, fnSuccess);
        }

        function addStopCauseRow() {
            let row = {};
            let stop_cause_pk = $('#cboStopCause').val();
            let already = false;
            page.proc_stop_cause_grid.getList().forEach(function (row) {
                if (row.stop_cause_id == stop_cause_pk)
                    already = true;
            });
            if (already)
                return;

            row["stop_cause_id"] = stop_cause_pk;
            row["stop_cause_name"] = $("#cboStopCause option:selected").text();

            page.proc_stop_cause_grid.addRow(
                row,
                'last',
                { __index: undefined }
            );
        }

        //공정별 비가동유형 저장
        function saveStopCause() {
            let _this = this;
            let grid_data = JSON.stringify(_this.proc_stop_cause_grid.getList());

            let param = {
                proc_pk : $('#id').val(),
                Q: grid_data
            };

            let fnSuccess = function (res) {
                Notify.success('저장되었습니다'); // Notification
                _this.showProcStopCause();
            };
            AjaxUtil.postAsyncData(this.url+"/save_proc_stop_cause", param, fnSuccess);
        }


        $(document.body).ready(function (e) {


            //yullinAuth.removeWriteButton();

            AjaxUtil.fillSelectOptions($('#factory_id'), 'factory', 'choose', false);
            AjaxUtil.fillSelectOptions($('#cboDefectType'), 'defect_type', '', false);
            AjaxUtil.fillSelectOptions($('#cboStopCause'), 'stop_cause', '', false);

            $('#txtProcess').on('keypress', function (e) {
                if (event.keyCode == 13) {
                    searchMainData();
                }
            });

            // 검색버튼
            $('#btnSearch').click(function (e) { searchMainData(); });

            // 신규버튼
            $('#btnNew').click(function (e) {

                $('#processForm')[0].reset();
                $('#processForm').find('#id').val('');

                $('#processForm').find('input, select').each(function () {
                    if ($(this).is(':disabled')) {
                        $(this).removeAttr('disabled');
                    }
                });

                //page.setButtonDisable(true, false, true);
                /*page.setButtonState();*/
            });

            // 저장버튼
            $('#btnSave').click(function (e) {
                let data = FormUtil.extractForm($('#processForm'));
                if (!data.factory_id) {
                    Alert.alert('', '공장을 선택해주세요.');
                    return false;
                }
                if (!data.process_code) {
                    Alert.alert('', '공정 코드를 입력해주세요.');
                    return false;
                }
                if (!data.process_name) {
                    Alert.alert('', '공정명을 입력해주세요.');
                    return false;
                }
                Alert.confirm('',
                    '저장하시겠습니까?',
                    function () { saveProcess() },
                    function () { }
                );
            });

            // 삭제버튼
            $('#btnDel').click(function (e) {
                Alert.confirm('',
                    '삭제하시겠습니까?',
                    function () { deleteProcess() },
                    function () { }
                );
            });

            $('#btnAddDefectType').click(function () {
                //page2.newRow();
                if (!$('#cboDefectType').val()) {
                    Alert.alert('', '부적합유형을 선택해주세요.');
                    return false;
                }
                page.addDefectTypeRow();
            });

            $('#btnDelDefectType').click(function (e) {
                proc_defect_type_grid.removeRow('selected');
            });

            $('#btnSaveDefectType').click(function () {
                saveDefectType();
            });

            $('#btnAddStopCause').click(function () {
                //page2.newRow();
                if (!$('#cboDefectType').val()) {
                    Alert.alert('', '부적합유형을 선택해주세요.');
                    return false;
                }
               addStopCauseRow();
            });

            $('#btnDelStopCause').click(function (e) {
               proc_stop_cause_grid.removeRow('selected');
            });

            $('#btnSaveStopCause').click(function () {
                saveStopCause();
            });

        });

    </script>
</th:block>
</html>
