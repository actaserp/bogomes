<html layout:decorate="~{layout_page}">
<th:block layout:fragment="content">
    <div class="content_wrap">
        <div class="layout-contents">
            <div class="page-title-wrap">
                <div class="left">
                    <h2>수주량 집계</h2>
                    <a title="북마크" class="bookmark toggle">
                        내 메뉴
                    </a>
                </div>
                <ul class="page-navi">
                    <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
                    <li>영업 관리</li>
                    <li>수주량집계</li>
                </ul>
            </div>

            <section class="section">
                <div class="section-top">
                    <div class="search-wrap">
                        <dl>
                            <dt>
                                <label for="srchStartDt">
                                    기간<span class="eq"></span>
                                </label>
                            </dt>
                            <dd>
                                <div class="srch-box">
                                    <input type="date" id="srchStartDt">&nbsp; ~&nbsp;
                                    <input type="date" id="srchEndDt">
                                </div>
                            </dd>
                        </dl>
                        <dl id="searchComArea">
                            <dt>
                                업체
                            </dt>
                            <dd>
                                <input type="text" id="cboCompany" name="cboCompany" readonly>
                                <input type="hidden" id="cboCompanyHidden">
                                &nbsp;
                                <a class="btn btn-delete" title="검색" id="btnCompanySearch">
                                    <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                    업체 검색
                                </a>
                            </dd>

                        </dl>
                        <dl>
                            <dt>
                                제품그룹
                            </dt>
                            <dd>
                                <select class="form-control2" id="cboMatGrp" name="cboMatGrp" ></select>
                            </dd>
                        </dl>

                        <dl>
                            <dt>&nbsp;</dt>
                            <dd>
                                <li>
                                    <a class="btn btn-delete" title="검색" id="btnSearch">
                                        <!--                                        class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                                        <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                        검색
                                    </a>
                                </li>
                            </dd>
                        </dl>
                        <dl>
                            <dt>&nbsp;</dt>
                            <dd>
                                <li>
                                    <a class="btn btn-delete" title="초기화" id="btnClear">
                                        <!--                                        class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                                        <img src="/images/icon/ico-edit.svg" alt="아이콘">
                                        초기화
                                    </a>
                                </li>
                            </dd>
                        </dl>
                    </div>
                    <!--                <div class="button-wrap">-->
                    <!--                    <ul>-->
                    <!--                        <li>-->
                    <!--                            <a class="btn btn-excell" title="등록" id="btnAddNew">-->
                    <!--                                <img src="/images/icon/ico-plus.svg" alt="등록 아이콘">-->
                    <!--                                등록-->
                    <!--                            </a>-->
                    <!--                        </li>-->
                    <!--                        <li>-->
                    <!--                            <a class="btn btn-delete" title="삭제" id="btnDelete">-->
                    <!--                                <img src="/images/icon/ico-delete.svg" alt="삭제 아이콘">-->
                    <!--                                삭제-->
                    <!--                            </a>-->
                    <!--                        </li>-->
                    <!--                        <li>-->
                    <!--                            <a class="btn btn-edit" title="수정" id="btnEdit">-->
                    <!--                                <img src="/images/icon/ico-edit.svg" alt="수정 아이콘">-->
                    <!--                                수정-->
                    <!--                            </a>-->
                    <!--                        </li>-->
                    <!--                    </ul>-->
                    <!--                </div>-->
                </div>
                <div class="container-fluid">
                    <div id="theGrid" style="height: 730px;"></div>
                </div>
                <!--        <div class="grid_box">-->

                <!--            <div class="h-640" data-ax5grid="sujuGrid" ></div>-->
                <!--        </div>-->
            </section>
        </div>
    </div>
</th:block>
<th:block layout:fragment="scripts">
<th:block th:replace="/common/columns_setting :: columns_setting" ></th:block>
    <th:block th:replace="/common/popup_company :: popup_company"></th:block>
<script type="text/javascript">
    class SujuSummaryPage {
        constructor() {
            this.url = '/api/summary/suju_summary';
            this.grid = null;
            this.$btnEdit = $('#btnEdit');
            this.$btnAddNew = $('#btnAddNew');
            this.viewData = new wijmo.collections.CollectionView();
            this.init();
        }

        init() {
            this.grid = new wijmo.grid.FlexGrid('#theGrid', {
                selectionMode: wijmo.grid.SelectionMode.Row,
                headersVisibility: wijmo.grid.HeadersVisibility.Column,
                autoGenerateColumns: false,
                showMarquee: true,
                isReadOnly: true,
                formatItem: (sender, e) => {
                    if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                        e.cell.style.textAlign = 'center';
                    }
                },
                columns: [
                    { binding: 'mat_grp_name', header: '제품그룹', width: 100 },
                    { binding: 'mat_code', header: '제품코드', width: 100 },
                    { binding: 'mat_name', header: '제품명', width: 250 },
                    { binding: 'unit_name', header: '단위', width: 70 },
                    { binding: 'tot_price_sum', header: '총수주액', width: 100, align: 'right', format: 'n0' },
                    { binding: 'tot_suju_sum', header: '총 수주량', width: 100, align: 'right', format: 'n0' },
                    { binding: 'company_name', header: '업체', width: 250 },
                    { binding: 'suju_sum', header: '수주량', width: 100, align: 'right', format: 'n0' },
                    { binding: 'price_sum', header: '수주액', width: 100, align: 'right', format: 'n0' },
                ],
                itemsSource: this.viewData,
            });

            // ✅ Footer 패널 사용 설정
            this.grid.columnFooters.rows.push(new wijmo.grid.Row());
            this.grid.bottomLeftCells.setCellData(0, 0, '총합');

            // ✅ Footer 합계 값 설정 (수동)
            this.grid.loadedRows.addHandler(() => {
                const rows = this.grid.rows;
                const footer = this.grid.columnFooters.rows[0];

                const getSum = (field) => rows.map(r => +r.dataItem[field] || 0).reduce((a, b) => a + b, 0);

                footer.dataItem = {
                    tot_price_sum: getSum('tot_price_sum'),
                    tot_suju_sum: getSum('tot_suju_sum'),
                    suju_sum: getSum('suju_sum'),
                    price_sum: getSum('price_sum'),
                };
            });

            new FlexGridContextMenu(this.grid);
            this.grid.downloadFileName = '수주량집계';
        }




        searchMainData() {
            const url = this.url + '/read';
            const data = {
                'srchStartDt' : $("#srchStartDt").val(),
                'srchEndDt' : $("#srchEndDt").val(),
                'cboCompany' : $("#cboCompanyHidden").val(),
                'cboMatGrp' : $("#cboMatGrp").val()
            };
            const result = AjaxUtil.getSyncData(url, data);
            console.log("result data : ", result.data);
            if (result) {
                this.grid.itemsSource = result.data;
            }
        }

        exportExcel() {
            const book = wijmo.grid.xlsx.FlexGridXlsxConverter.saveAsync(this.grid, {
                includeColumnHeaders: true,
                includeCellStyles: false,
            }, (blob) => {
                wijmo.saveFile(blob, '수주량.xlsx');
            });
        }
    }

    let page = null;

    $(document.body).ready(function (e) {
        page = new SujuSummaryPage();
        let content = document.getElementById('searchComArea');

        AjaxUtil.fillSelectOptions($('#cboMatGrp'), 'material_group', 'all', '', 'product,semi');
        AjaxUtil.fillSelectOptions($('#searchForm').find('#cboYear'), 'data_year', '', false);
        AjaxUtil.fillSelectOptions($('#cboCompany'), 'company', 'all', '');

        $('#btnSearch').click(() => page.searchMainData());
        $('#btnExcel').click(() => page.exportExcel());

        $('#btnCompanySearch').click(function () {
            let poppage = new PopCompComponent();
            let $poppage = $(poppage);
            let searchcallback = function (items) {
                // $content.find('#cboCompany').val(items.id);
                // $content.find('#CompanyName').val(items.compname);
                console.log('items : ',items);
                document.getElementById('cboCompany').value = items.compname;
                document.getElementById('cboCompanyHidden').value = items.id;
            };

            poppage.show(searchcallback);
        });
        // 초기화 버튼 클릭 이벤트
        $('#btnClear').click(function () {

                document.getElementById('cboCompany').value = '';
                document.getElementById('cboCompanyHidden').value = '';
        });
    });




</script>
</th:block>