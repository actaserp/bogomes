<html layout:decorate="~{layout_page}">

<th:block layout:fragment="content">
  <div class="layout-contents">
    <div class="page-title-wrap">
      <div class="left">
        <h2>ì‘ì—…ìê·¼ë¬´ê´€ë¦¬</h2>
        <a title="ë¶ë§ˆí¬" class="bookmark toggle">
          ë‚´ ë©”ë‰´
        </a>
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
        <li>ê²€ì‚¬ê´€ë¦¬</li>
        <li>ì‘ì—…ìê·¼ë¬´ê´€ë¦¬</li>
      </ul>
    </div>

    <section class="section">
      <div class="section-top">
        <div class="search-wrap">
          <dl>
            <dt>
              <label>ì¡°íšŒì›”</label>
            </dt>
            <dd>
              <div class="srch-box">
                <input type="month" class="form-control2" id="SearchDate" name="SearchDate">
              </div>
            </dd>
          </dl>

          <dl>
            <dt>
              <label>ì‚¬ì›ëª…</label>
            </dt>
            <dd>
              <div class="srch-box">
                <input id="depart" name="depart" />
              </div>
            </dd>
          </dl>

          <dl>
            <dt><span class="eq"></span></dt>
            <dd>
              <li>
                <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch">
                  <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                  ê²€ìƒ‰
                </a>
              </li>
            </dd>
          </dl>
        </div>
        <div class="button-wrap">
          <ul>

            <li>
              <button type="button" class="btn-default" id="btnAddNew" style="width: 115px; height: 36px;"><i
                  class="fas fa-save">ë“±ë¡</i>
              </button>
            </li>
            <!--<li>
              <button type="button" class="btn-delete btn-danger" id="btnDel" title="ì‚­ì œ" style="width: 115px; height: 36px;"><i class="fas fa-trash">ì‚­ì œ</i></button>
            </li>-->
            <li>
              <button type="button" class="btn-edit btn-default" id="btnEdit" title="ìˆ˜ì •"
                      style="width: 115px; height: 36px;"><i class="fas fa-edit"></i>ìˆ˜ì •
              </button>
            </li>
          </ul>
        </div>
      </div>
      <div class="container-fluid">
        <div id="theGrid" style=""></div>
      </div>
    </section>
  </div>

  <script type="text/x-tmpl" id="TestDailySaveTemplate">
    <style>
        input[readonly] {
          background-color: #EDEFF5 !important;
          cursor: not-allowed;
        }
    </style>
     <div class="content_wrap popup" id="div_excel_upload">
    <div class="table-wrap">
      <form id="TestDailyReportAddNewForm">
        <table class="write-table">
          <caption>ì‘ì—…ì ê·¼ë¬´ê´€ë¦¬ ë“±ë¡</caption>
          <tbody>
          <tr>
            <th style="text-align: center">
              <label for="InspectionDate">ê·¼ë¬´ì¼</label>
            </th>
            <td>
              <input type="date" id="InspectionDate" name="InspectionDate" style="width: 250px;">
            </td>
            <th style="text-align: center">
              <label for="person_id">ì‚¬ì›ëª…</label>
            </th>
            <td >
             <input type="hidden" id="person_id" name="person_id" style="width: 230px;"/>
             <input id="person_name" name="person_name" style="width: 230px;"/>
            </td>
          </tr>
         </table>
      </form>
    </div>
    <div class="container-fluid">
        <div id="defect-grid" style="height: 375px;"></div>
    </div>
    <div class="popup-button">
      <button type="button" class="btn-popup y_write_auth" id="btnPopTestDailySave">ì €ì¥</button>
      <button type="button" class="btn-popup" id="modal-close-button">ë‹«ê¸°</button>
    </div>
  </script>
</th:block>

<th:block layout:fragment="scripts">
  <script type="text/javascript">
    class WorkManagementPage {
      constructor() {
        this.grid = null;
        this.defectGrid = null;
        this.$btnEdit = $('#btnEdit');
        this.$btnAddNew = $('#btnAddNew');
        this.$spjangcd = sessionStorage.getItem('spjangcd');
        this.viewData = new wijmo.collections.CollectionView();
        this.url = '/api/clock/work_management';
        this.init();
      }

      init() {
        let _this = this;

        const yyyymm = $('#SearchDate').val(); // "2025-08"
        if (!yyyymm) return;

        const [year, month] = yyyymm.split('-').map(Number);

        const fixedColumns = [
          {binding: 'person_name', header: 'ì‚¬ì›ëª…', width: 120, align: 'left', allowMerging: true},
          {binding: 'work', header: 'ì—…ë¬´êµ¬ë¶„', width: 200, align: 'left'},
         // {binding: 'total', header: 'ê³„', width: 100, align: 'right', format: 'n0'},
          {binding: 'person_id', header: 'ì‚¬ì›id', visible: false},
        ];
        const dayColumns = getDayColumnsByMonth(year, month);
        const allColumns = [...fixedColumns, ...dayColumns];

        // âœ… ê¸°ì¡´ ê·¸ë¦¬ë“œê°€ ìˆìœ¼ë©´ dispose
        const oldGrid = wijmo.Control.getControl('#theGrid');
        if (oldGrid) oldGrid.dispose();

        // âœ… ìƒˆë¡œ ê·¸ë¦¬ë“œ ìƒì„±
        this.grid = new wijmo.grid.FlexGrid('#theGrid', {
          //selectionMode: wijmo.grid.SelectionMode.Row,
          selectionMode: wijmo.grid.SelectionMode.Cell,
          headersVisibility: wijmo.grid.HeadersVisibility.Column,
          allowMerging: wijmo.grid.AllowMerging.Cells,
          autoGenerateColumns: false,
          showMarquee: true,
          frozenColumns: 2,
          isReadOnly: false,
          formatItem: (sender, e) => {
            if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
              const col = sender.columns[e.col];
              const header = col.header;

              e.cell.style.textAlign = 'center';

              if (/^\d+$/.test(header)) {
                const day = parseInt(header);
                const yyyymm = $('#SearchDate').val(); // "2025-08"
                const [year, month] = yyyymm.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                const isoDate = formatDateToYYYYMMDD(date);

                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isHoliday = holidayList.includes(isoDate); // âœ… ì •í™•íˆ ë¹„êµ

                if (isHoliday || isWeekend) {
                  e.cell.style.color = 'red';
                  e.cell.style.backgroundColor = '#ffecec';
                } else {
                  e.cell.style.color = 'blue';
                  e.cell.style.backgroundColor = '#ecf5ff';
                }
              }
            }
          },
          itemFormatter: (panel, row, col, cell) => {
            if (panel.cellType === wijmo.grid.CellType.Cell) {
              cell.contentEditable = false; // ì§ì ‘ ì…ë ¥ ë°©ì§€
              const colName = panel.columns[col].binding;
              if (['person_name'].includes(colName)) {
                cell.style.textAlign = 'center';
                cell.style.verticalAlign = 'middle';
                cell.style.display = 'flex';
                cell.style.alignItems = 'center';
                cell.style.justifyContent = 'center';
              }
            }
          },

          columns: allColumns,
          itemsSource: this.viewData,
        });

        new FlexGridContextMenu(this.grid);
        this.grid.downloadFileName = 'ì‘ì—…ìê·¼ë¬´ê´€ë¦¬';

        this.grid.hostElement.addEventListener('dblclick', function (e) {
          let items = _this.grid.selectedItems;
          if (items.length === 0) {
            return false;
          }
          _this.$btnEdit.trigger('click');
        });

        // âœ… 1. Footer í–‰ ì´ˆê¸°í™” ë° ìƒì„±
        this.grid.columnFooters.rows.clear(); // ê¸°ì¡´ footer ì´ˆê¸°í™”
        this.grid.columnFooters.rows.push(new wijmo.grid.Row()); // ê¸°ë³¸ row
        this.grid.columnFooters.rows.push(new wijmo.grid.Row()); // Overtime(2Hr/4Hr)
        this.grid.columnFooters.rows.push(new wijmo.grid.Row()); // í•©ê³„ row

// âœ… 2. footer ë‚´ìš© ì„¤ì • (ë°ì´í„° ë¡œë”© ì´í›„ ì²˜ë¦¬)
        this.grid.loadedRows.addHandler(() => {
          const footerPanel = this.grid.columnFooters;

          const rowDefaultTime = footerPanel.rows[0];  // ê¸°ë³¸
          const rowOvertime    = footerPanel.rows[1];  // Overtime(2Hr/4Hr)
          const rowtotalSum    = footerPanel.rows[2];  // í•©ê³„

          const totalQtyData  = { work: 'ê¸°ë³¸' };
          const overtimeData  = { work: 'Overtime(2Hr/4Hr)' };
          const sumData       = { work: 'í•©ê³„' };

          const dayColumns = this.grid.columns.filter(col => /^\d+$/.test(col.header));

          dayColumns.forEach(col => {
            const field      = col.binding;
            const totalField = `total_${field}`;

            let itemSum = 0;
            (this.viewData.items || []).forEach(item => {
              itemSum += Number(item[field] || 0);
            });

            //  ê¸°ë³¸: 8 ì´ìƒì´ë©´ 8, ì•„ë‹ˆë©´ '-'
            totalQtyData[field]  = (itemSum >= 8 ? 8 : '-');

            //  ì´ˆê³¼ë¶„ë§Œ í‘œì‹œ
            const overtime = itemSum - 8;
            overtimeData[field]  = (overtime > 0) ? overtime : '-';

            //  í•©ê³„: ì‹¤ì œ item í•©
            sumData[field] = (itemSum > 0 ? itemSum : '-');
          });


          rowDefaultTime.dataItem = totalQtyData;
          rowOvertime.dataItem    = overtimeData;
          rowtotalSum.dataItem    = sumData;
        });

        this.$btnAddNew.click(function (e) {

          let nowDate = CommonUtil.getYYYYMMDD();

          let defaultData = {
            id: '',
            mode: 'new',
            InspectionDate: nowDate,
            spjangcd: _this.$spjangcd
          };

          if ($('.popup:visible').length > 0) {
            return; // ì´ë¯¸ ì—´ë ¤ìˆë‹¤ë©´ ì¤‘ë³µìœ¼ë¡œ ì—´ì§€ ì•ŠìŒ
          }

          _this.showTestAddNewForm(defaultData);
        });

        this.$btnEdit.click(() => {
          const selection = this.grid.selection;
          const row = selection?.row ?? -1;
          const col = selection?.col ?? -1;

          if (row < 0 || col < 0) return;                 // ìœ íš¨ì„± ì²´í¬
          if ($('.popup:visible').length > 0) return;

          // í˜„ì¬ í–‰ì˜ ì›ë³¸ ë°ì´í„°
          const item = this.grid.rows[row]?.dataItem;
          if (!item) return;

          // ê³ ì • ì»¬ëŸ¼ ê°’ ë½‘ê¸°
          const personId = item.person_id;                // â† fixedColumnsì— ìˆëŠ” í•„ë“œ
          const personName = item.person_name;

          const colObj = this.grid.columns[col];
          const headerText = colObj?.header ?? '';

          // ìˆ«ì í˜•íƒœì˜ ë‚ ì§œ ì—´ë§Œ í—ˆìš© (1~31 ë“±)
          if (!/^\d+$/.test(headerText)) {
            // Alert.alert('ì•Œë¦¼', 'ë‚ ì§œ ì…€ì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
          }

          const day = Number(headerText);
          const yyyymm = $('#SearchDate').val(); // ì˜ˆ: "2025-08"
          if (!yyyymm || !yyyymm.includes('-')) {
            Alert.alert('ì•Œë¦¼', 'ì¡°íšŒì›”ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
            return;
          }

          const [year, month] = yyyymm.split('-').map(Number);
          const picked = new Date(year, month - 1, day);
          const isoDate = formatDateToYYYYMMDD(picked); // YYYY-MM-DD

          // íŒì—… ë„ìš°ê¸° (ì‚¬ë²ˆ/ì´ë¦„ í•¨ê»˜ ì „ë‹¬)
          this.showTestAddNewForm({
            mode: 'edit',
            InspectionDate: isoDate,
            spjangcd: this.$spjangcd,
            person_id: personId,
            person_name: personName,
          });
        });


        $('#depart').off('change').on('change', function () {
          _this.searchMainData();
        });


        function getDayColumnsByMonth(year, month) {
          const lastDay = new Date(year, month, 0).getDate();
          return Array.from({length: lastDay}, (_, i) => ({
            binding: `day_${i + 1}`,
            header: `${i + 1}`,
            width: 50,
            align: 'right',
            allowSorting: false,
            format: 'n0',
          }));
        }
      }

      showTestAddNewForm(data) {
        let _this = this;
        let content = tmpl('TestDailySaveTemplate', data);
        let $content = $(content);
        let csrfToken = $("[name=_csrf]").val();
        let modalContainer = null;

        if (data.mode === 'new') {
          modalContainer = new PopupDraggable('ì‘ì—…ìê·¼ë¬´ê´€ë¦¬ ë“±ë¡');
        } else {
          modalContainer = new PopupDraggable('ì‘ì—…ìê·¼ë¬´ê´€ë¦¬ ìˆ˜ì •');
        }

        //ëª¨ë‹¬ í¬ê¸°
        modalContainer.open({width: 850, height: 590, $content});

        //íŒì—…íƒ€ì´í‹€ ì„¤ì •
        let $popTitle = $content.find('#popTitle');
        if (data.mode === 'new') {
          $popTitle.text('ì‘ì—…ìê·¼ë¬´ê´€ë¦¬ ë“±ë¡');
        } else {
          $popTitle.text('ì‘ì—…ìê·¼ë¬´ê´€ë¦¬ ìˆ˜ì •');
        }

        let $inspectionDate = $content.find('#InspectionDate');
        let $depart = $content.find('#depart');
        let $defectQty = $content.find('#defect_qty');
        let $inspectionQty = $content.find('#InspectionQty');
        let $defectType = $content.find('#DefectType');
        let $AddNewForm = $content.find('#TestDailyReportAddNewForm');
        let $btnPopSave = $content.find('#btnPopTestDailySave');
        let mainDepartVal = $('#depart').val();


        AjaxUtil.fillSelectOptions($defectType, 'defect_type', '', false);
        let nowDate = CommonUtil.getYYYYMMDD();
        $inspectionDate.val(nowDate);
        if (mainDepartVal) {
          mainDepartVal.val(mainDepartVal);
        }

        this.defectGrid = new wijmo.grid.FlexGrid('#defect-grid', {
          autoGenerateColumns: false,
          selectionMode: wijmo.grid.SelectionMode.Cell, // ë‹¤ì¤‘ ì„ íƒ ë¶ˆê°€
          headersVisibility: wijmo.grid.HeadersVisibility.Column,
          columns: [
            {binding: 'value', header: 'ì—…ë¬´êµ¬ë¶„', width: 300, align: 'center', isReadOnly: true},
            {binding: 'code', header: 'ID', width: 80, visible: false},
            {
              binding: 'defect_qty',
              header: 'ì‘ì—…ì‹œê°„',
              width: 200,
              align: 'center',
              format: 'n0',
              isReadOnly: false, // í¸ì§‘ ê°€ëŠ¥
            },
          ],
          itemsSource: new wijmo.collections.CollectionView([]), // ë¹ˆ ë°ì´í„°ë¡œ ì´ˆê¸°í™”
          itemFormatter: (panel, row, col, cell) => {
            const column = panel.columns[col];
            if (panel.cellType === wijmo.grid.CellType.Cell) {
              if (column.binding === 'defect_qty') {
                cell.style.textAlign = 'right';
              }
            }
            if (panel.cellType === wijmo.grid.CellType.ColumnHeader) {
              // ì»¬ëŸ¼ ìŠ¤íƒ€ì¼ ì ìš©
              if (column.binding === 'defect_qty') {
                cell.style.color = '#5567ff';
              }
            }
          }
        });

        const loadDefects = () => {
          AjaxUtil.getAsyncData('/api/clock/work_management/defects', {
            // InspectionDate: inspectionDate,   // ê·¼ë¬´ì¼
            // person_id: personId               // ì‚¬ì› ID
          }, (res) => {
            const list = (res.data || []).map(r => ({
              code: r.code,
              value: r.value,
              defect_qty: r.defect_qty || 0,
              inspection_qty: r.inspection_qty || 0
            }));

            _this.defectGrid.itemsSource.sourceCollection = list;
            _this.defectGrid.itemsSource.refresh();

            // ì„œë²„ì— ê¸°ì¡´ ê²€ì‚¬ìˆ˜(inspection_qty)ê°€ ìˆìœ¼ë©´ ì„¸íŒ…
            const first = (res.data || [])[0];
            if (first && typeof first.inspection_qty === 'number') {
              $inspectionQty.val(first.inspection_qty.toLocaleString());
            }
          });
        };


        // ì´ˆê¸° ë¡œë“œ ë° ë³€ê²½ ì‹œ ë‹¤ì‹œ ë¡œë“œ
        loadDefects();

        $inspectionDate.on('change', () => loadDefects());

        if (data && data.mode === 'edit') {
          const $form           = $('#TestDailyReportAddNewForm');
          const $inspectionDate = $form.find('#InspectionDate');
          const $personId       = $form.find('#person_id');
          const $personName     = $form.find('#person_name');

          // ê°’ ì„¸íŒ…
          $inspectionDate.val(data.InspectionDate);
          $personId.val(data.person_id || '');
          $personName.val(data.person_name || '');

          console.log('ğŸ“Œ ë°”ì¸ë”© ì™„ë£Œ:', {
            InspectionDate: $inspectionDate.val(),
            person_id: $personId.val(),
            person_name: $personName.val()
          });

          // ê²°í•¨ ë°ì´í„° ë¡œë“œ
          // loadDefects(data.InspectionDate, data.person_id);
          loadDefects();

          // UI ì œì–´
          setTimeout(() => {
            $inspectionDate.prop('readonly', true);
            $personName.prop('readonly', true);
          }, 0);
        }


        $btnPopSave.off('click').on('click', function () {
          // 1) ê·¸ë¦¬ë“œ ë°ì´í„° ìˆ˜ì§‘
          const gridItems = _this.defectGrid.itemsSource ? _this.defectGrid.itemsSource.items : [];
          // ìˆ«ì ì •ê·œí™”
          const toInt = (v) => {
            if (v == null || v === '') return 0;
            return Number(String(v).replaceAll(',', '').trim()) || 0;
          };

          // 2) í—¤ë” + ë¼ì¸ payload ë§Œë“¤ê¸°
          const payload = {
            header: {
              inspectionDate: $inspectionDate.val(),     // 'YYYY-MM-DD'
              workCenterId: $workCenter.val(),         // ìˆ«ì ë¬¸ìì—´ì´ë©´ ì„œë²„ì—ì„œ íŒŒì‹±
              inspectionQty: toInt($inspectionQty.val()),
              spjangcd: _this.$spjangcd
            },
            lines: (gridItems || []).map(r => ({
              defectTypeId: r.defect_type_id,
              defectQty: toInt(r.defect_qty)
            }))
          };

          // ìœ íš¨ì„±(ì„ íƒ): ê²€ì‚¬ìˆ˜ >= ë¶€ì í•©ëŸ‰ í•©
          const sumDefect = payload.lines.reduce((s, r) => s + r.defectQty, 0);
          if (payload.header.inspectionQty < sumDefect) {
            Alert.alert('ê²€ì‚¬ìˆ˜ í™•ì¸', 'ì´ ê²€ì‚¬ìˆ˜ë³´ë‹¤ ë¶€ì í•©ëŸ‰ í•©ê³„ê°€ í½ë‹ˆë‹¤.');
            return;
          }

          Alert.confirm('', 'ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
            $.ajax({
              type: 'POST',
              url: '/api/test/test_daily_report/save',
              data: JSON.stringify(payload),
              contentType: 'application/json; charset=UTF-8',
              headers: {'X-CSRF-TOKEN': csrfToken},
              success: function (res) {
                if (res.success) {
                  _this.searchMainData();

                  modalContainer.close(); // ì €ì¥ í›„ ë‹«ê¸° ë“±
                } else {
                  Alert.alert('ì‹¤íŒ¨', res.message || 'ì‘ì—…ìê·¼ë¬´ê´€ë¦¬ ì €ì¥ ì‹¤íŒ¨');
                }
              },
              error: function (xhr) {
                Alert.alert('ì„œë²„ ì˜¤ë¥˜', xhr.responseText || 'ì„œë²„ ì˜¤ë¥˜');
              }
            });
          });
        });

      }

      //ì‘ì—…ìê·¼ë¬´ê´€ë¦¬ ëª©ë¡ ì¡°íšŒ
      searchMainData() {
        let _this = this;
        let url = this.url + '/read';
        let data = {
          'depart': $('#depart').val(),
          'SearchDate': $('#SearchDate').val()
        };

        let fnsuccess = function (result) {
          if (!Array.isArray(result.data)) {
            _this.viewData.sourceCollection = [];
            if (_this.grid?.columnFooters) _this.grid.columnFooters.rows.clear();
            return;
          }

          const rows = result.data;
          const grouped = Object.create(null);

          rows.forEach(row => {
            if (!row.work_date) return;
            const day = new Date(row.work_date).getDate();

            // ì‚¬ì› + ì—…ë¬´ + id ê¸°ì¤€ìœ¼ë¡œ í•œ í–‰
            const key = `${row.person_name}__${row.work}__${row.person_id}`;
            if (!grouped[key]) {
              grouped[key] = {
                person_name: row.person_name,
                work: row.work,
                person_id: row.person_id
              };
            }

            const field = `day_${day}`;
            const hours = Number(row.total_hours ?? 0); // ì†Œìˆ˜ ì‹œê°„ í—ˆìš©
            grouped[key][field] = (Number(grouped[key][field]) || 0) + hours;
          });

          _this.viewData.sourceCollection = Object.values(grouped);

          // í’‹í„° 3ì¤„ ë³´ì¥ + ì§‘ê³„
          // ensureThreeFooterRows.call(_this);
          // updateFootersByWork.call(_this);
        };

        AjaxUtil.getAsyncData(url, data, fnsuccess);
      }
    }

    let holidayList = [];

    async function fetchHolidaysForYear(year) {
      return new Promise((resolve, reject) => {
        var xhr = new XMLHttpRequest();
        var url = 'http://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService/getRestDeInfo';
        var queryParams = '?' + encodeURIComponent('serviceKey') + '=' + 'R3P3syhq6qRP0cz8mbV2J5t%2B32WwaSN9sH8ZW4k59oKAU3Ze0WvcljMrN36OJqxs38%2F780hMD4QfhCiDZQNUyA%3D%3D';
        queryParams += '&' + encodeURIComponent('solYear') + '=' + encodeURIComponent(year);
        queryParams += '&' + encodeURIComponent('numOfRows') + '=' + encodeURIComponent('30');

        xhr.open('GET', url + queryParams);
        xhr.onreadystatechange = function () {
          if (this.readyState == 4) {
            if (this.status == 200) {
              var parser = new DOMParser();
              var xmlDoc = parser.parseFromString(this.responseText, "text/xml");

              // XMLì—ì„œ ì›í•˜ëŠ” ë°ì´í„° ì¶”ì¶œ
              var items = xmlDoc.getElementsByTagName("item");
              let holidays = [];
              for (var i = 0; i < items.length; i++) {
                var locdate = items[i].getElementsByTagName("locdate")[0].textContent;
                var dateName = items[i].getElementsByTagName("dateName")[0].textContent;

                holidays.push({date: locdate, name: dateName});
              }
              resolve(holidays);
            } else {
              console.error('ì˜¤ë¥˜ ë°œìƒ. HTTP ìƒíƒœ ì½”ë“œ:', this.status);
              reject(this.status);
            }
          }
        };

        xhr.send();
      });
    }

    async function initPage() {
      $('#SearchDate').val(CommonUtil.getYYYYMMDD().substring(0, 7));

      const yyyymm = $('#SearchDate').val();
      const [year] = yyyymm.split('-').map(Number);

      try {
        const holidaysRaw = await fetchHolidaysForYear(year);
        holidayList = holidaysRaw
          .filter(item => item.date && item.date.length === 8)
          .map(item => {
            const locdate = item.date;
            return `${locdate.substring(0, 4)}-${locdate.substring(4, 6)}-${locdate.substring(6, 8)}`;
          });

        //console.log('ğŸ“… ìµœì´ˆ ë¡œë”© holidayList:', holidayList);
      } catch (err) {
        console.error('âŒ ê³µíœ´ì¼ ë¡œë”© ì‹¤íŒ¨:', err);
        holidayList = [];
      }

      page = new WorkManagementPage();
      page.searchMainData();
    }

    function formatDateToYYYYMMDD(date) {
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }


    let page = null;

    $(document).ready(function () {
      initPage();
      $('#SearchDate').val(CommonUtil.getYYYYMMDD().substring(0, 7));
      AjaxUtil.fillSelectOptions($('#WorkCenter_id'), 'workcenter', '', false);

      page = new WorkManagementPage();

      $('#SearchDate').on('change', async function () {
        const yyyymm = $('#SearchDate').val(); // "2025-08"

        if (!yyyymm || !yyyymm.includes('-')) {
          console.warn('âš ï¸ ì¡°íšŒì›”ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:', yyyymm);
          return;
        }

        const [year] = yyyymm.split('-').map(Number);

        try {
          const holidaysRaw = await fetchHolidaysForYear(year);
          holidayList = holidaysRaw
            .filter(item => item.date && item.date.length === 8)
            .map(item => {
              const locdate = item.date;
              return `${locdate.substring(0, 4)}-${locdate.substring(4, 6)}-${locdate.substring(6, 8)}`;
            });

          //console.log('ğŸ“… holidayList:', holidayList);

          page.init();
          page.searchMainData();

        } catch (err) {
          console.error('âŒ ê³µíœ´ì¼ ë¡œë”© ì‹¤íŒ¨:', err);
          holidayList = [];
          page.init();
          page.searchMainData();
        }
      });

      //ê²€ìƒ‰
      $('#btnSearch').click(function (e) {
        page.searchMainData();
      });

      $('#keyword').on('keypress', function (e) {
        if (event.keyCode == 13) {
          page.searchMainData();
        }
      });

      // ì‚­ì œ
      $('#btnDel').click(function (e) {
        page.showEditPage('del');
      });
    });
  </script>
</th:block>
</html>