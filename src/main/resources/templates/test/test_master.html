<html layout:decorate="~{layout_page}">

<th:block layout:fragment="content">

    <div class="layout-contents">
        <div class="page-title-wrap">
            <div class="left">
                <h2>검사마스터</h2>
                <a title="북마크" class="bookmark toggle">
                    내메뉴
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
                <li>관리메뉴</li>
                <li>검사관리</li>
                <li>검사마스터</li>
            </ul>
        </div>

        <section class="section">
            <div class="section-top">
                <div class="search-wrap">
                    <dl>
                        <dt>
                            <label>마스터명</label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <input type="text" id="keyword" name="keyword" class="form-control2">
                            </div>
                        </dd>
                    </dl>

                    <dl>
                        <dt>
                            <label>검사종류</label>
                        </dt>
                        <dd>
                            <div class="srch-box">
                                <select class="form-control2" id="cboTestClass" name="cboTestClass"></select>
                            </div>
                        </dd>
                    </dl>


                    <dl>
                        <dt><span class="eq"></span></dt>
                        <dd>
                            <li>
                                <a class="btn btn-delete" title="검색" id="btnSearch">
                                    <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                    검색
                                </a>
                            </li>
                        </dd>
                    </dl>
                </div>
            </div> <!--//section-top end -->
            <div class="container-fluid">
                <p id="selectedItem"></p>
                <div id="theGrid" style="height: 350px; max-height: 350px;"></div>
            </div>
                   <!-- <div class="grid_box">

                        <div class="h-300" data-ax5grid="theGrid" ></div>
                    </div>-->
            <div class="btn-wrap">
            </div>
        </section>


        <div class="tab-wrap">
            <ul class="tab-links">
                <li><a href="#tab_basic">기본 정보</a></li>
                <li><a href="#tab_test_item">검사항목 지정</a></li>
                <li><a href="#tab_test_mat">해당 품목</a></li>
            </ul>

            <div>
                <section class="tab-item" id="tab_basic" style="border-top-left-radius: 0;">
                    <div class="section-top">
                        <div class="button-wrap">
                            <ul>
                                <li>
                                    <button type="button" class="btn-default" id="btnNew" title="검사마스터 등록" disabled><i
                                            class="fas fa-plus"></i></button>
                                </li>

                                <li>
                                    <button type="button" class="btn-default y_write_auth" id="btnSave" title="검사마스터 저장"
                                            disabled><i class="fas fa-save"></i></button>
                                </li>

                                <li>
                                    <button type="button" class="btn-danger y_write_auth" id="btnDel" title="검사마스터 삭제"
                                            disabled><i class="fas fa-trash"></i></button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div>
                        <form id="testMasterForm">
                            <table class="write-table"
                                   style="width: 100%; border-collapse: collapse; table-layout: fixed;">
                                <caption style="text-align: left; margin-bottom: 8px;">상세테이블</caption>
                                <input type="hidden" class="form-control2" id="id" name="id" readonly disabled/>
                                <tbody>
                                <tr>
                                    <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd;">
                                        <label for="master_grp">마스터 그룹</label>
                                    </th>
                                    <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">
                                        <select id="master_grp" name="master_grp"
                                                style="width: 100%;"></select>
                                    </td>
                                    <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd;">
                                        <label for="master_name">마스터명</label>
                                    </th>
                                    <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">
                                        <input type="text" id="master_name" name="master_name"
                                               style="width: 100%;">
                                    </td>
                                    <th style="text-align: center; width: 7%; padding: 5px; border: 1px solid #ddd;">
                                        <label for="test_type">검사항목 사용 여부</label>
                                    </th>
                                    <td style="width: 15%; padding: 5px; border: 1px solid #ddd;">
                                        <select style="width: 100%;" id="test_type"
                                                name="test_type"></select>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </form>
                    </div>
                </section>

                <section class="tab-item" id="tab_test_item" style="border-top-left-radius: 0;">
                    <div class="section-top">

                        <div class="button-wrap">
                            <ul>
                                <li>
                                    <select class="s-150" id="cboResultType" name="cboResultType"></select>
                                </li>
                                <li>
                                    <select class="s-150" id="cboTestItem" name="cboTestItem"></select>
                                </li>
                                <li>
                                    <button type="button" class="btn-default" id="btnAddItem" title="검사항목 추가" disabled>
                                        <i
                                                class="fas fa-plus"></i></button>
                                </li>
                                <li>
                                    <button type="button" class="btn-default" id="imgUp" title="순서변경" disabled><i
                                            class="fas fa-arrow-up"></i></button>
                                </li>
                                <li>
                                    <button type="button" class="btn-default" id="imgDown" title="순서변경" disabled><i
                                            class="fas fa-arrow-down"></i></button>
                                </li>
                                <li>
                                    <button type="button" class="btn-default y_write_auth" id="btnSaveItem"
                                            title="검사항목 저장"
                                            disabled><i class="fas fa-save"></i></button>
                                </li>

                                <li>
                                    <button type="button" class="btn-danger y_write_auth" id="btnDelItem"
                                            title="검사항목 삭제"
                                            disabled><i class="fas fa-trash"></i></button>
                                </li>

                            </ul>
                        </div>
                    </div>

                    <div class="container-fluid">
                        <p id="selectedItem"></p>
                        <div id="test-grid" style="height: 230px; max-height: 230px;"></div>
                                    <!--<div class="h-250" data-ax5grid="test-grid" ></div>-->
                    </div>
                </section>

                <section class="tab-item" id="tab_test_mat" style="border-top-left-radius: 0;">
                    <div class="container-fluid">
                        <p id="selectedItem"></p>
                      <!--   <div class="h-280" data-ax5grid="test-mat-grid"></div>-->
                        <div id="test-mat-grid" style="height: 250px; max-height: 250px;"></div>
                    </div>
                </section>
            </div>
        </div>

    </div>
</th:block>

<th:block layout:fragment="scripts">
    <th:block th:replace="/common/columns_setting :: columns_setting"></th:block>
    <script type="text/javascript">
        //const { Alert } = require("bootstrap");

        class TestMasterPage {
            constructor() {
                this.grid = null;
                this.test_item_grid = null;
                this.test_mat_grid = null;
                this.viewData = new wijmo.collections.CollectionView();

                this.baseUrl = '/api/test/test_master'
                this.testSpecMap = {};
                this.testSpecType = [];

                this.currentTab = null;

                // 일괄삭제 처리용도
                this.delRows = [];

                this.init();
            }

            init() {
                let _this = this;

                this.grid = new wijmo.grid.FlexGrid('#theGrid', {
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        //{ key: 'id', label: '번호', width: 150, align: 'center' },
                        {binding: 'test_master_grp', header: '그룹', width: 200, align: 'left'},
                        {binding: 'test_master_class', header: '검사종류', width: 200, align: 'left'},
                        {binding: 'test_master_name', header: '마스터명', width: 200, align: 'left'},
                        {
                            binding: 'use_test_item', header: '검사항목 사용', width: 120, align: 'center',
                            //editor: {
                            //    type: "checkbox",
                            //    config: { height: 17, trueValue: "Y", falseValue: "N" },
                            //},
                        },
                        {binding: '', header: '', width: "*", align: 'left'}
                    ],
                    itemsSource: this.viewData, // 데이터를 설정할 배열
                });

                /*let config = {
                    target: $('[data-ax5grid="theGrid"]'),
                    sortable: true,
                    frozenColumnIndex: 0, // 열 고정
                    frozenRowIndex: 0,    // 행 고정
                    showLineNumber: false, // 열의 번호 보이기 여부
                    showRowSelector: false,  // checkbox(선택) 보이기 여부
                    multipleSelect: false, // 여러행 선택 가능 여부 (false시 단독 선택)
                    sortable: true, // 모든 컬럼에 정렬 아이콘 표시 (columns에서 컬럼별 소팅여부 재설정 가능)
                    multiSort: true, // 다중 정렬 여부
                    header: {
                        align: 'center',  // 헤더의 기본 정렬
                        columnHeight: 38  // 헤더 높이
                    },
                    body: {
                        columnHeight: 25, // body의 기본 높이
                        onClick: function (e) {
                            _this.grid.select(this.dindex);
                            _this.showDetail(e.item.id);

                            if (_this.currentTab == 'tab_test_item') {
                                _this.showItemList(e.item.id);
                            } else if (_this.currentTab = 'tab_test_mat') {
                                _this.showMatList(e.item.id);
                            }
                        }
                    },
                    page: {
                        display: true,  // 페이징 보이기 여부
                        statusDisplay: true,
                    },
                    columns: [
                        //{ key: 'id', label: '번호', width: 150, align: 'center' },
                        {key: 'test_master_grp', label: '그룹', width: 200, align: 'left'},
                        {key: 'test_master_class', label: '검사종류', width: 200, align: 'left'},
                        {key: 'test_master_name', label: '마스터명', width: 200, align: 'left'},
                        {
                            key: 'use_test_item', label: '검사항목 사용', width: 120, align: 'center',
                            //editor: {
                            //    type: "checkbox",
                            //    config: { height: 17, trueValue: "Y", falseValue: "N" },
                            //},
                        },
                    ]
                };

                this.grid = new ax5.ui.grid(config);*/
                new FlexGridContextMenu(this.grid);
                this.grid.downloadFileName = '검사마스터';

                this.grid2 = new wijmo.grid.FlexGrid('#test-grid', {
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        {binding: 'id', header: '번호', width: 100, align: 'center',},
                        //{
                        //    binding: 'delete', header: '삭제', width: 100, align: 'center',
                        //    formatter: function () {
                        //        //return '<button type="button" class="btn-danger" data-custom-btn><i class="fas fa-trash"></i></button>'
                        //    },
                        //},
                        //{ binding: 'test_item_id', header: '검사항목 번호', width: 120, align: 'center' },
                        {binding: 'test_name', header: '검사항목명', width: 200, align: 'left'},
                        {binding: 'test_res_type', header: '결과값 유형', width: 100, align: 'center'},
                        {
                            binding: 'round_digit',
                            /*header: '<span class="editable_clr">소수점 자리수</span>',*/
                            header: '소수점 자리수',
                            width: 120,
                            align: 'right',
                           /* editor: {type: 'number'},
                            formatter: 'money'*/
                        },
                        {
                            binding: 'spec_type',
                            /*header: '<span class="editable_clr">규격유형</span>',*/
                            header: '규격유형',
                            width: 100,
                            align: 'center',
                            /*formatter: function () {
                                return _this.testSpecMap[this.value];
                            },*/
                           /* editor: {
                                type: 'select',
                                config: {
                                    columnKeys: {
                                        optionValue: 'value',
                                        optionText: 'text'
                                    },
                                    options: [],
                                }
                            },*/
                        },
                        {
                            binding: 'low_spec',
                            /*header: '<span class="editable_clr">하한값</span>',*/
                            header: '하한값',
                            width: 100, align: 'right',
                           /* editor: {
                                type: 'number',
                                disabled: function () {
                                    return (!this.item.spec_type || this.item.spec_type == 'x' || this.item.spec_type == 'just' || this.item.spec_type == 'upper')
                                }
                            },*/

                        },
                        {
                            binding: 'upper_spec',
                            /*header: '<span class="editable_clr">상한값</span>',*/
                            header: '상한값',
                            width: 100,
                            align: 'right',
                            /*editor: {
                                type: 'number',
                                disabled: function () {
                                    return (!this.item.spec_type || this.item.spec_type == 'x' || this.item.spec_type == 'just' || this.item.spec_type == 'low')
                                }
                            },*/

                        },
                        {binding: 'spec_text', header: '규격문자', width: 120, align: 'center'},
                        {binding: 'eng_spec_text', header: '규격문자(영)', width: 120, align: 'center'},
                        {binding: '', header: '', width: "*", align: 'left'}
                    ],
                    itemsSource: this.viewData, // 데이터를 설정할 배열
                });

                new FlexGridContextMenu(this.grid2);
                this.grid2.downloadFileName = '검사항목 지정';


                /*let test_item_grid_config = {
                    target: $('[data-ax5grid="test-grid"]'),
                    frozenColumnIndex: 0, // 열 고정
                    frozenRowIndex: 0,    // 행 고정
                    showLineNumber: false, // 열의 번호 보이기 여부
                    showRowSelector: false,  // checkbox(선택) 보이기 여부
                    multipleSelect: false, // 여러행 선택 가능 여부 (false시 단독 선택)
                    sortable: true, // 모든 컬럼에 정렬 아이콘 표시 (columns에서 컬럼별 소팅여부 재설정 가능)
                    multiSort: false, // 다중 정렬 여부
                    header: {
                        align: 'center',  // 헤더의 기본 정렬
                        columnHeight: 38  // 헤더 높이
                    },
                    body: {
                        columnHeight: 25, // body의 기본 높이
                        onClick: function (e) {
                            _this.test_item_grid.select(this.dindex);
                            if (e.column.key == 'spec_type') {
                                e.column.editor.config.options = _this.testSpecType;
                            }
                        },
                        onDataChanged: function () {
                            // 규격유형 변경 시 상하한, 규격문자 초기화
                            if (this.key == 'spec_type') {
                                _this.test_item_grid.setValue(this.dindex, 'low_spec', '');
                                _this.test_item_grid.setValue(this.dindex, 'upper_spec', '');
                                _this.test_item_grid.setValue(this.dindex, 'spec_text', '');
                                _this.test_item_grid.setValue(this.dindex, 'eng_spec_text', '');
                            }

                            if (this.key == 'low_spec') {
                                _this.makeSpecText(this);
                            }

                            if (this.key == 'upper_spec') {
                                _this.makeSpecText(this);
                            }
                        }
                    },
                    page: {
                        display: true,  // 페이징 보이기 여부
                        statusDisplay: true,
                    },
                    columns: [
                        {binding: 'id', header: '번호', width: 100, align: 'center',},
                        //{
                        //    binding: 'delete', header: '삭제', width: 100, align: 'center',
                        //    formatter: function () {
                        //        //return '<button type="button" class="btn-danger" data-custom-btn><i class="fas fa-trash"></i></button>'
                        //    },
                        //},
                        //{ binding: 'test_item_id', header: '검사항목 번호', width: 120, align: 'center' },
                        {binding: 'test_name', header: '검사항목명', width: 200, align: 'left'},
                        {binding: 'test_res_type', header: '결과값 유형', width: 100, align: 'center'},
                        {
                            binding: 'round_digit',
                            header: '<span class="editable_clr">소수점 자리수</span>',
                            width: 120,
                            align: 'right',
                            editor: {type: 'number'},
                            formatter: 'money'
                        },
                        {
                            binding: 'spec_type',
                            header: '<span class="editable_clr">규격유형</span>',
                            width: 100,
                            align: 'center',
                            formatter: function () {
                                return _this.testSpecMap[this.value];
                            },
                            editor: {
                                type: 'select',
                                config: {
                                    columnKeys: {
                                        optionValue: 'value',
                                        optionText: 'text'
                                    },
                                    options: [],
                                }
                            },
                        },
                        {
                            binding: 'low_spec', header: '<span class="editable_clr">하한값</span>', width: 100, align: 'right',
                            editor: {
                                type: 'number',
                                disabled: function () {
                                    return (!this.item.spec_type || this.item.spec_type == 'x' || this.item.spec_type == 'just' || this.item.spec_type == 'upper')
                                }
                            },
                            formatter: 'money'
                        },
                        {
                            binding: 'upper_spec',
                            header: '<span class="editable_clr">상한값</span>',
                            width: 100,
                            align: 'right',
                            editor: {
                                type: 'number',
                                disabled: function () {
                                    return (!this.item.spec_type || this.item.spec_type == 'x' || this.item.spec_type == 'just' || this.item.spec_type == 'low')
                                }
                            },
                            formatter: 'money'
                        },
                        {binding: 'spec_text', header: '규격문자', width: 100, align: 'center'},
                        {binding: 'eng_spec_text', header: '규격문자(영)', width: 100, align: 'center'},
                    ]
                };*/

               /* this.test_item_grid = new ax5.ui.grid(test_item_grid_config);*/

                this.grid3 = new wijmo.grid.FlexGrid('#test-mat-grid', {
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    headersVisibility: wijmo.grid.HeadersVisibility.Column,
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    formatItem: (sender, e) => {
                        if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                            e.cell.style.textAlign = 'center';
                        }
                    },
                    columns: [
                        //{ binding: 'id', header: '번호', width: 100, align: 'left'},
                        {binding: 'mat_type', header: '품목유형', width: 150, align: 'left'},
                        {binding: 'mat_grp', header: '품목그룹', width: 200, align: 'left'},
                        {binding: 'mat_code', header: '품목코드', width: 200, align: 'left'},
                        {binding: 'mat_name', header: '품목명', width: 200, align: 'left'},
                        {binding: '', header: '', width: "*", align: 'left'}
                    ],
                    itemsSource: this.viewData, // 데이터를 설정할 배열
                });
                new FlexGridContextMenu(this.grid3);
                this.grid3.downloadFileName = '해당 품목';

                /*let test_mat_config = {
                    target: $('[data-ax5grid="test-mat-grid"]'),
                    frozenColumnIndex: 0, // 열 고정
                    frozenRowIndex: 0,    // 행 고정
                    showLineNumber: false, // 열의 번호 보이기 여부
                    showRowSelector: false,  // checkbox(선택) 보이기 여부
                    multipleSelect: false, // 여러행 선택 가능 여부 (false시 단독 선택)
                    sortable: true, // 모든 컬럼에 정렬 아이콘 표시 (columns에서 컬럼별 소팅여부 재설정 가능)
                    multiSort: false, // 다중 정렬 여부
                    header: {
                        align: 'center',  // 헤더의 기본 정렬
                        columnHeight: 38  // 헤더 높이
                    },
                    body: {
                        columnHeight: 25, // body의 기본 높이
                        onClick: function (e) {
                            _this.test_mat_grid.select(this.dindex);

                        }
                    },
                    page: {
                        display: true,  // 페이징 보이기 여부
                        statusDisplay: true,
                    },
                    columns: [
                        //{ binding: 'id', header: '번호', width: 100, align: 'left'},
                        {binding: 'mat_type', header: '품목유형', width: 150, align: 'left'},
                        {binding: 'mat_grp', header: '품목그룹', width: 200, align: 'left'},
                        {binding: 'mat_code', header: '품목코드', width: 200, align: 'left'},
                        {binding: 'mat_name', header: '품목명', width: 200, align: 'left'},
                    ]
                };*/

             /*   this.test_mat_grid = new ax5.ui.grid(test_mat_config);*/

                // 필터
                AjaxUtil.fillSelectOptions($('#cboTestClass'), 'system_code', 'all', false, 'test_class'); // 검사종류

                // form내부
                AjaxUtil.fillSelectOptions($('#cboResultType'), 'system_code', 'choose', false, 'result_type'); // 결과값유형
                AjaxUtil.fillSelectOptions($('#test_type'), 'system_code', 'choose', false, 'test_type'); // 검사유형
                AjaxUtil.fillSelectOptions($('#master_grp'), 'test_master_group', 'choose', false); // 검사유형

                this.testSpecType = AjaxUtil.getSelectData('system_code', 'spec_type');
            }

            // 버튼 활성화
            setButtonState() {
                let id = $('#testMasterForm').find('#id').val();
                let $buttons = $('.tab-content').find('button');
                let $testItemBtns = $('#tab_test_item').find('button');

                $buttons.each(function () {
                    if (!$(this).is(':disabled')) {
                        $(this).attr('disabled', 'disabled');
                    }
                });

                $('#btnNew').removeAttr('disabled');
                $('#btnSave').removeAttr('disabled');

                if (id) {
                    $('#btnDel').removeAttr('disabled');

                    if ($('#test_type').val() == 'use_item_master') {
                        $testItemBtns.each(function () {
                            $(this).removeAttr('disabled');
                        });
                    } else {
                        $testItemBtns.each(function () {
                            if (!$(this).is(':disabled')) {
                                $(this).attr('disabled', 'disabled');
                            }
                        });
                    }
                }
            }

            // 공정 목록 조회
            searchMainData() {
                let _this = this;
                let param = {
                    'name': $('#keyword').val(),
                    'test_class': $('#cboTestClass').val()
                };

                let result = AjaxUtil.getSyncData(this.baseUrl + "/read", param);
                if (result != null) {
                    _this.viewData.sourceCollection = result.data;
                }

                $('#testMasterForm')[0].reset();
                $('#testMasterForm').find('#id').val('');

                $('#testMasterForm').find('input, select, textarea').each(function () {
                    if (!$(this).is(':disabled')) {
                        $(this).attr('disabled', 'disabled');
                    }
                });

             /*   this.test_item_grid.setData([]);
                this.test_mat_grid.setData([]);
                this.delRows = [];*/

                this.setButtonState();
            }

            //상세정보 조회
            showDetail(id) {
                let _this = this;
                let param = {
                    'id': id
                };

                let result = AjaxUtil.getSyncData(this.baseUrl + "/detail", param);
                if (result.data) {
                    FormUtil.BindDataForm(result.data, $('#testMasterForm'))
                    this.setButtonState();
                }
            }

            // 정보 저장
            saveInfo() {
                let _this = this;
                let url = '/api/test/test_master/save';
                let data = FormUtil.extractForm($('#testMasterForm'));
                let fnSuccess = function (res) {
                    if (!res.success) {
                        Alert.alert('', res.message);
                    } else {
                        Notify.success('저장되었습니다.');
                        _this.searchMainData();
                        _this.showDetail(res.data.id);
                    }
                }

                if (!data.master_grp) {
                    Alert.alert('', '마스터 그룹을 선택해주세요.');
                    return;
                } else if (!data.master_name) {
                    Alert.alert('', '마스터명을 입력해주세요.');
                    return;
                } else if (!data.test_type) {
                    Alert.alert('', '검사유형을 선택해주세요.');
                    return;
                }

                AjaxUtil.postAsyncData(url, data, fnSuccess);
            }

            // 정보 삭제
            deleteInfo() {
                let _this = this;
                let id = $('#testMasterForm').find('#id').val();
                let url = '/api/test/test_master/delete';
                let data = {
                    'id': id,
                }
                let fnSuccess = function (res) {
                    if (res.success) {
                        Notify.success("삭제되었습니다.");
                        _this.searchMainData();
                    } else {
                        Alert.alert('', res.message);
                    }
                }

                AjaxUtil.postAsyncData(url, data, fnSuccess);
            }

            // 검사항목조회
            showItemList(masterId) {
                let _this = this;
                let option = $('<option>', {value: '', text: '선택'});

                $('#cboResultType').val('');
                $('#cboTestItem').empty();
                $('#cboTestItem').append(option);

                this.test_item_grid.setData([]);
                this.delRows = [];

                if (masterId) {
                    let param = {
                        'master_id': masterId,
                    };

                    let result = AjaxUtil.getSyncData(this.baseUrl + '/item_list', param);
                    if (result != null) {
                        let count = result.data.length;
                        this.test_item_grid.setData({
                            list: result.data,
                            page: {
                                display: true,
                                totalElements: count,
                            }
                        });
                    }
                }
            }

            // 검사항목추가
            addItem() {
                let _this = this;
                let valid = true;
                let resultType = $('#cboResultType').val();
                let testItemId = $('#cboTestItem').val();
                let testItemList = this.test_item_grid.getList();

                if (!resultType) {
                    Alert.alert('', '결과값 유형을 선택해주세요.');
                    return;
                } else if (!testItemId) {
                    Alert.alert('', '테스트 항목을 선택해주세요.');
                    return;
                }

                if (testItemList.length > 0) {
                    testItemList.forEach(function (item) {
                        if (item.test_item_id == testItemId) {
                            valid = false;
                        }
                    });
                }

                if (valid) {
                    let param = {
                        'item_id': testItemId
                    };

                    let result = AjaxUtil.getSyncData(this.baseUrl + '/get_item_info', param);

                    if (result.data) {
                        this.test_item_grid.addRow(
                            {
                                'test_item_id': result.data.test_item_id,
                                'test_name': result.data.test_item_name,
                                'test_res_type': result.data.result_type,
                                'round_digit': result.data.round_digit,
                                'spec_type': 'x',
                            },
                            'last',
                            {focus: "END"}
                        );
                    }
                } else {
                    Alert.alert('', '동일한 검사항목이 이미 존재합니다.');
                    return;
                }
            }

            // 검사항목저장
            saveItem() {
                let _this = this;

                let url = '/api/test/test_master/save_item';
                let masterId = $('#testMasterForm').find('#id').val();

                let valid = true;
                let valid_message = '';

                let testItemList = [];
                let dataDefault = {
                    'id': '',
                    'test_item_id': '',
                    'round_digit': '',
                    'spec_type': '',
                    'low_spec': '',
                    'upper_spec': '',
                    'spec_text': '',
                    'eng_spec_text': '',
                }

                this.test_item_grid.getList().forEach(function (item) {
                    if (!item['spec_type']) {
                        valid = false;
                        valid_message = '규격유형을 선택해주세요.';
                    }

                    let testItem = {};
                    $.each(dataDefault, function (key) {
                        if (item[key]) {
                            testItem[key] = item[key];
                        } else {
                            testItem[key] = '';
                        }
                    });

                    testItemList.push(testItem);
                });

                if (valid) {
                    let data = {
                        'master_id': masterId,
                        'item_list': testItemList,
                        'del_ids': this.delRows,
                    }

                    let Q = {
                        value: JSON.stringify(data)
                    }

                    let fnSuccess = function (res) {
                        Notify.success('저장되었습니다');
                        _this.showItemList(masterId);
                    }

                    AjaxUtil.postAsyncData(url, Q, fnSuccess);
                } else {
                    Alert.alert('', valid_message);
                }
            }

            // 검사항목삭제
            delItem() {
                let _this = this;
                let selectedRow = this.test_item_grid.getList('selected')[0];
                //let url = '/api/test/test_master?action=delete_item';

                //if (selectedRow.id) {
                //    let data = {
                //        'item_id': selectedRow.id,
                //    }

                //    let fnSuccess = function () { };

                //    AjaxUtil.postAsyncData(url, data, fnSuccess);
                //}
                if (selectedRow.id) {
                    this.delRows.push(selectedRow.id);
                }
                this.test_item_grid.removeRow(selectedRow.__index);
                //Alert.alert('', '삭제되었습니다.');
            }

            // 검사항목 순서변경
            changeOrder(val) {
                let _this = this;

                if (this.test_item_grid.getList('selected').length == 0) {
                    Alert.alert('', '순서를 변경할 항목을 선택하세요.');
                    return;
                }

                if (val == 'U') {
                    let selected = this.test_item_grid.getList('selected');

                    $.each(selected, function (index, self_item) {
                        let self_index = self_item.__index;
                        let upper_index = self_index - 1;

                        if (upper_index == -1) {
                            Alert.alert('', '첫번째 항목이 선택되었습니다.');
                            return;
                        }

                        let upper_item = _this.test_item_grid.list[upper_index];
                        upper_item.__index = self_index;
                        self_item.__index = upper_index;

                        _this.test_item_grid.updateRow(self_item, upper_index);
                        _this.test_item_grid.updateRow(upper_item, self_index);

                        _this.test_item_grid.select(self_item, {__selected__: true});
                        _this.test_item_grid.select(upper_item, {__selected__: false});

                        _this.test_item_grid.repaint();
                    });
                } else {
                    let selected = this.test_item_grid.getList('selected');
                    selected.reverse(); // 아래로 내릴 때는 역순으로 루프를 돌려야 한다.

                    $.each(selected, function (index, self_item) {
                        let self_index = self_item.__index;
                        let under_index = self_index + 1;

                        if (_this.test_item_grid.list.length <= under_index) {
                            Alert.alert('', '마지막 항목이 선택되었습니다.');
                            return;
                        }

                        let under_item = _this.test_item_grid.list[under_index];
                        under_item.__index = self_index;
                        self_item.__index = under_index;

                        _this.test_item_grid.updateRow(self_item, under_index);
                        _this.test_item_grid.updateRow(under_item, self_index);

                        _this.test_item_grid.select(self_item, {__selected__: true});
                        _this.test_item_grid.select(under_item, {__selected__: false});

                        _this.test_item_grid.repaint();
                    });
                }
            }

            // 한/영 규격문자 생성
            makeSpecText(row) {
                let _this = this;
                let specText = '';
                let engSpecText = '';
                let specType = row.item.spec_type;

                if (specType == 'low') {
                    if (row.item.low_spec) {
                        specText = row.item.low_spec + ' 이상';
                        engSpecText = 'Min ' + row.item.low_spec;
                    }
                } else if (specType == 'upper') {
                    if (row.item.upper_spec) {
                        specText = row.item.upper_spec + ' 이하';
                        engSpecText = 'Max ' + row.item.upper_spec;
                    }
                } else if (specType == 'range') {
                    if (row.item.low_spec && row.item.upper_spec) {
                        if (row.item.upper_spec < row.item.low_spec) {
                            Alert.alert('', '상하한 범위를 확인해주세요.');
                        }

                        specText = row.item.low_spec + ' ~ ' + row.item.upper_spec;
                        engSpecText = row.item.low_spec + ' ~ ' + row.item.upper_spec;
                    }
                }

                this.test_item_grid.setValue(row.dindex, 'spec_text', specText);
                this.test_item_grid.setValue(row.dindex, 'eng_spec_text', engSpecText);
            }

            // 검사항목삭제
            deleteItem() {
                if (this.test_item_grid.getList('selected').length == 0) {
                    Alert.alert('', '삭제할 항목을 선택하세요.');
                    return;
                }

                let selectedRow = this.test_item_grid.getList('selected')[0];
                if (selectedRow.id) {
                    this.delRows.push(selectedRow.id);
                }
                this.test_item_grid.removeRow(selectedRow.__index);

            }

            // 해당품목조회
            showMatList(masterId) {
                let _this = this;

                this.test_mat_grid.setData([]);

                if (masterId) {
                    let param = {
                        'master_id': masterId,
                    };

                    let result = AjaxUtil.getSyncData(this.baseUrl + "/get_applied_mat", param);
                    if (result.data != null) {
                        let count = result.data.length;
                        this.test_mat_grid.setData({
                            list: result.data,
                            page: {
                                display: true,
                                totalElements: count,
                            }
                        });
                    }
                }
            }
        }

        let page = null;

        $(document.body).ready(function (e) {
            page = new TestMasterPage();

            $.each(page.testSpecType, function (index, item) {
                page.testSpecMap[item.value] = item.text;
            });

            page.searchMainData();

            // 검색버튼
            $('#btnMainSearch').click(function (e) {
                page.searchMainData();
            });

            // tab클릭
            $('.tab_links .tab').click(function (e) {
                let target = e.currentTarget.name;
                let masterId = $('#testMasterForm').find('#id').val();

                page.currentTab = target;

                if (target == 'tab_test_item') {
                    page.showItemList(masterId);
                } else if (target == 'tab_test_mat') {
                    page.showMatList(masterId);
                }
            });

            // 기본정보> 신규버튼
            $('#btnNew').click(function (e) {

                $('#testMasterForm')[0].reset();
                $('#testMasterForm').find('#id').val('');
             /*   page.test_item_grid.setData([]);
                page.test_mat_grid.setData([]);*/

                $('#testMasterForm').find('input, select').each(function () {
                    if ($(this).is(':disabled')) {
                        $(this).removeAttr('disabled');
                    }
                });

                page.setButtonState();
            });

            // 기본정보> 저장버튼
            $('#btnSave').click(function (e) {
                page.saveInfo();
            });

            // 기본정보> 삭제버튼
            $('#btnDel').click(function (e) {
                Alert.confirm('', '삭제하시겠습니까?',
                    function () {
                        page.deleteInfo();
                    },
                    function () {
                    }
                );
            });

            // 검사항목지정> 추가
            $('#btnAddItem').click(function () {
                page.addItem();
            });

            // 검사항목지정> 저장
            $('#btnSaveItem').click(function () {
                page.saveItem();
            });

            let option = $('<option>', {value: '', text: '선택'});
            $('#cboTestItem').append(option);

            // 결과값 유형에 따른 검사항목 세팅
            $('#cboResultType').change(function (e) {
                if ($('#cboResultType').val()) {
                    AjaxUtil.fillSelectOptions($('#cboTestItem'), 'test_item', 'choose', false, $('#cboResultType').val());
                } else {
                    $('#cboTestItem').empty();
                    $('#cboTestItem').append(option);
                }
            });
            // 검사항목지정> 삭제
            $('#btnDelItem').click(function (e) {
                Alert.confirm('', '검사항목을 삭제하시겠습니까?',
                    function () {
                        page.deleteItem();
                    },
                    function () {
                    }
                );
            });
            //// 검사항목지정> 삭제
            //$('[data-ax5grid="test-grid"]').on('click', '[data-custom-btn]', function (e) {
            //    if ($('#test_type').val() == 'use_item_master') {
            //        page.delItem();
            //    } else {
            //        Alert.alert('', '검사항목 미사용 마스터는 \n 검사항목을 수정 할 수 없습니다.')
            //    }
            //});

            // 검사항목지정> 순서변경
            $("#imgUp").click(function (e) {
                page.changeOrder("U");
            });

            $("#imgDown").click(function (e) {
                page.changeOrder("D");
            });

        });


    </script>
</th:block>

</html>