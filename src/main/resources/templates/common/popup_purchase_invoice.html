<th:block th:fragment="popup_purchase_invoice">
<th:block th:replace="/common/popup_totalAmount :: popup_totalAmount"></th:block>
<th:block th:replace="/common/popup_account_subject :: popup_account_subject"></th:block>
<th:block th:replace="/common/popup_project :: popup_project"></th:block>
<th:block th:replace="/common/popup_depart :: popup_depart"></th:block>
<th:block th:replace="/common/popup_deduction :: popup_deduction"></th:block>
<th:block th:replace="/common/popup_expense :: popup_expense"></th:block>
<th:block th:replace="/common/popup_card :: popup_card"></th:block>
    <head>
        <style id="invoice_css">

            #InvoicerCorpName::placeholder {
                font-size: 13px;
                text-align: left;
            }

            #PaymentCorpName::placeholder {
                font-size: 13px;
            }

            #tax_code::placeholder {
                font-size: 13px;
            }

            #project::placeholder {
                font-size: 13px;
            }

            #att_depart::placeholder {
                font-size: 13px;
            }

            #account_code::placeholder {
                font-size: 13px;
            }

            textarea[name^="detailList"][name$=".ItemName"]::placeholder {
                font-size: 13px;
            }

            textarea[name^="detailList"][name$=".ExpenseNm"]::placeholder {
                font-size: 13px;
            }

            textarea[name^="detailList"][name$=".AccountNm"]::placeholder {
                font-size: 13px;
            }

            textarea[name^="detailList"][name$=".ProjectNm"]::placeholder {
                font-size: 13px;
            }

            .content_wrap.popup {
                overflow-y: auto;
            }

            #taxForm {
                display: flex;
            }

            .border_blue {
                border: 2px solid #276cc7;
            }

            table {
                border: none;
            }

            #taxtype_area {
                width: 100%;
                border-top: 2px solid #a5a5a5;
                background-color: #fafafa;
            }

            #taxtype_area .taxtype .taxtype_radio p {
                float: left;
                padding: 8px 25px 12px 25px;
                color: #555;
            }

            #taxtype_area .taxtype .taxtype_radio span {
                float: left;
                padding: 7px 0 12px 0;
            }

            #taxtype_area .taxtype .taxtype_radio span label {
                color: #555;
            }

            #taxtype_area .taxtype .taxtype_radio label.for {
                curosr: pointer;
                padding-left: 3px;
            }

            #taxtype_area .taxtype .client_radio {
                float: left;
                margin: 0 0 0 31px;
            }

            #taxtype_area .taxtype .client_radio p {
                float: left;
                padding: 8px 19px 12px 19px;
                color: #555;
            }

            #taxtype_area .taxtype .client_radio span {
                float: left;
                padding: 7px 0 12px 0;
            }

            #taxtype_area .taxtype .client_radio span label {
                color: #555;
            }

            #taxtype_area .taxtype .client_radio label.for {
                curosr: pointer;
                padding-left: 3px;
            }

            #taxTotalList .PT label.for {
                curosr: pointer;
                padding-left: 3px;
            }

            #WriteTypeList .for {
                margin-left: 5px;
            }

            .rad {
                width: 13px;
                height: 13px;
                margin-bottom: 1px;
                vertical-align: middle;
                cursor: pointer;
            }

            .PT .pt1 {
                float: left;
                margin: 16px 0 0 19%;
            }

            .PT .pt2 {
                float: left;
                margin: 16px 0 0 12px;
            }

            .PT .pt_s {
                float: left;
                margin: 0 0 0 12px;
            }

            #area_form textArea {
                overflow: hidden;
            }

            #area_form {
                float: left;
            }

            table th {
                background-color: white;
            }

            #area_form #etax_area_form .etax_table {
                width: 100%;
                border-spacing: 0px 0px;
                table-layout: fixed;
            }

            .etax_table input,
            .etax_table button {
                max-width: 99%;
                box-sizing: border-box;
                font-weight: 500;
            }

            .etax_table button {
                font-size: 13px;
            }

            #taxList .in_txt {
                height: 35px !important;
            }

            table td {
                border: none;
            }

            #area_form #etax_area_form .etax_table th {
                font-weight: normal;
                padding-top: 2px;
                padding-bottom: 2px;
                line-height: 15px;
                height: 30px;
                border-bottom: none;
            }

            #area_form #etax_area_form .etax_table th, x:-moz-any-link, x:default {
                height: 25px;
                *height: 20px;
            }

            #area_form #etax_area_form .etax_table td {
                color: #333333;
                padding-top: 1px;
                padding-bottom: 3px;
                height: 20px;
                text-align: left;
            }

            #area_form #etax_area_form .etax_table td input.in_txt {
                margin: 2px 0px 0px 0px;
            }

            #area_form #etax_area_form .etax_table td textarea {
                float: left;
                margin: 2px 0px 0px 0px;
                resize: none;
                height: 35px;
            }

            #area_form #etax_area_form .etax_table td, x:-moz-any-link, x:default {
                height: 25px;
                *height: 20px;
            }

            #area_form #etax_area_form .table_border_red th {
                color: #e62324;
            }

            #area_form #etax_area_form .table_border_blue th {
                color: #3070ad;
            }

            #etax_area_form .table_border_red tbody th {
                border-top: 1px solid #f58c8c;
                border-left: 1px solid #f58c8c;
            }

            #etax_area_form .table_border_red tbody th.invoicer_bg {
                background-color: #fff6f6;
            }

            #etax_area_form .table_border_red tbody td {
                border-top: 1px solid #f58c8c;
                border-left: 1px solid #f58c8c;
            }


            #etax_area_form .table_border_red tbody th.splitline {
                padding: 0 0 0 0 !important;
                height: 0 !important;
            }

            #etax_area_form .table_border_blue tbody th {
                border-top: 1px solid #5b9adf;
                border-left: 1px solid #5b9adf;
            }

            #etax_area_form .table_border_blue tbody th.invoicer_bg {
                background-color: #f0f6fd;
            }

            #etax_area_form .table_border_blue tbody td {
                border-top: 1px solid #5b9adf;
                border-left: 1px solid #5b9adf;
            }

            #etax_area_form .table_border_blue tbody th.splitline {
                padding: 0 0 0 0 !important;
                height: 0 !important;
            }


            #area_form #etax_area_form .etax_table .item_border {
                border-top: 1px solid #dfdfdf;
                border-left: 1px solid #dfdfdf;
            }

            #area_form #etax_area_form .etax_table .item_l_border {
                border-left: 1px solid #dfdfdf;
            }

            #area_form #etax_area_form .etax_table .item_t_border {
                border-top: 1px solid #dfdfdf;
            }

            .gray_bg {
                background-color: #f1f3f6;
            }

            .invoicee_blue {
                color: #0071c9;
            }

            input[type="radio"]:checked::after {
                content: "";
                position: absolute;
                top: 3px;
                left: 3px;
                width: 8px;
                height: 8px;
                background: rgb(255, 255, 255);
                border-width: 6px;
                border-style: solid;
                border-color: rgb(36, 124, 255);
                border-image: initial;
                border-radius: 100%;
                margin-right: 5px;
            }


            .in_txt, .txt_ar {
                height: 28px;
                padding: 0 6px;
                border-radius: 0;
                font-size: 14px;
                width: 100%;
            }

            .mgl {
                margin-left: 20px;
            }

            .border_collapse {
                border-collapse: separate;
            }

            .placeholder {
                color: #aaa !important;
            }

            .n_linethrough {
                text-decoration: none !important;
            }

            .linethrough {
                text-decoration: line-through;
            }

            .default {
                cursor: default;
            }

            .hand {
                cursor: pointer;
                cursor: hand;
            }

            .block {
                display: block !important;
            }

            .none {
                display: none !important;
            }

            .show {
                visibility: visible !important;
            }

            .hide {
                visibility: hidden !important;
            }

            .t_hide {
                display: none;
            }

            /* Layout */
            .val_t {
                vertical-align: top;
            }

            .val_m {
                vertical-align: middle;
            }

            .val_b {
                vertical-align: bottom;
            }

            .position_s {
                position: static !important;
            }

            .position_a {
                position: absolute !important;
            }

            .position_r {
                position: relative !important;
            }

            .fl_l {
                float: left !important;
            }

            .fl_r {
                float: right !important;
            }

            .fl_n {
                float: none !important;
            }

            .cr_l {
                clear: left;
            }

            .cr_r {
                clear: right;
            }

            .cr_b {
                clear: both;
            }

            .inline {
                display: inline !important;
            }

            .inline_b {
                display: inline-block !important;
            }

            .t_inline {
                display: inline
            }

            /* Color */
            .red {
                color: #FF0000 !important;
            }

            .red2 {
                color: #ff4b4b !important;
            }

            .leeRed {
                color: #e13a40 !important;
            }

            .blue {
                color: #0071c9 !important;
            }

            .blue2 {
                color: #0071c9 !important;
            }

            .blue3 {
                color: #0071c9 !important;
            }

            .white {
                color: #FFFFFF !important;
            }

            .green {
                color: #00817b !important;
            }

            .green2 {
                color: #299296 !important;
            }

            .gray {
                color: #999999 !important;
            }

            .gray_deep {
                color: #777 !important;
            }

            .gray2 {
                color: #666666 !important;
            }

            .darkgray {
                color: #444444 !important;
            }

            .lgray {
                color: #BBBBBB !important;
            }

            .black {
                color: #000000 !important;
            }

            .orange {
                color: #F8700D !important;
            }

            .purple {
                color: #A566FF !important;
            }

            .redclay {
                color: #fd8316 !important;
            }

            .highlight {
                color: #FF0000 !important;
            }

            .h_blue {
                color: #2881c6 !important;
            }

            .c_333 {
                color: #333 !important;
            }

            .c_555 {
                color: #555 !important;
            }

            .c_777 {
                color: #777 !important;
            }

            .c_999 {
                color: #999 !important;
            }


            /* Table no border */
            .noborder_l {
                border-left: 0px !important;
            }

            .noborder_r {
                border-right: 0px !important;
            }

            .noborder_t {
                border-top: 0px !important;
            }

            .noborder_b {
                border-bottom: 0px !important;
            }

            .bg_none {
                background: none !important;
            }

            .wbr { /*word-break;break-all;*/
                word-wrap: break-word;
            }

            .over_y_h {
                overflow-y: hidden;
                margin: 0 0 0 0;
            }

            .over_x_h {
                overflow-x: hidden;
            }

            .over_y_nh {
                overflow-y: scroll;
                padding: 0;
            }

            /* box-sizing */
            .border_box {
                box-sizing: border-box;
            }

            .btn_white_gradient {
                height: 28px;
                padding: 4px 6px;
                border-radius: 1px;
            }

            .ft_24 {
                font-size: 24px;
            }

            .al_r {
                text-align: right !important;
            }

            .al_l {
                text-align: left !important;
                padding: 3px;
            }

            .pdl_3 {
                padding-right: 3px !important;
            }

            .al_c {
                text-align: center;
            }

            .in_btn {
                height: 28px;
                width: 28px;
                padding: 4px 6px;
                line-height: 36px;
                border-radius: 1px;
            }

            .in_btn img {
                margin-right: 0;
                width: 14px;
                height: 14px;
            }

            .plus img {
                margin-right: 0;
                width: 10px;
                height: 10px;
            }

            .align-center-wrap {
                display: flex;
                align-items: center; /* 세로 가운데 정렬 */
            }

            .align-center-wrap textarea {
                flex: 1;
            }

            .align-center-wrap .btn {
                margin-left: 4px;
            }

        </style>
    </head>
    <script type="text/x-tmpl" id="popup_purchase_invoiceTemplate">

        <div class="content_wrap popup">

                <form id="taxForm">
                    <div class="section-top">
                        <input type="hidden" id="misnum" name="misnum" >
                        <div id="taxtype_area" style="display:none;">
                            <div class="taxtype">
                                <div class="taxtype_radio">
                                    <p class="taxtype_icon bold">과세형태</p><span class="fl_l bold pdt_8 c_555">:</span>
                                    <span class="mgl"><input checked="checked" class="rad" type="radio" value="과세" id="TaxType1" name="TaxType"><label class="for" for="TaxType1">과세(10%)</label></span>
                                    <span class="mgl"><input class="rad" type="radio" value="영세" id="TaxType2" name="TaxType"><label class="for" for="TaxType2">영세(0%)</label></span>
                                    <span class="mgl"><input class="rad" type="radio" value="면세" id="TaxType3" name="TaxType"><label class="for" for="TaxType3">면세(세액없음)</label></span>
                                </div>
                                <div class="taxtype_radio"> <p style="margin-left: 40px;">|</p> </div>
                                <div class="client_radio">
                                    <p class="taxtype_icon bold">거래처유형</p><span class="fl_l bold c_555 mg_0 pdt_8">:</span>
                                    <span class="mgl"><input checked="checked" class="rad" type="radio" value="사업자" id="InvoiceeType1" name="InvoiceeType"><label class="for" for="InvoiceeType1">사업자</label></span>
                                    <span class="mgl"><input class="rad" type="radio" value="개인" id="InvoiceeType2" name="InvoiceeType"><label class="for" for="InvoiceeType2">개인</label></span>
                                    <span class="mgl"><input class="rad" type="radio" value="외국인" id="InvoiceeType3" name="InvoiceeType"><label class="for" for="InvoiceeType3">외국인</label></span>
                                </div>
                            </div>
                        </div>

                        <div class="container-fluid">
                            <div id="area_form">
                                <div id="etax_area_form" class="border_blue">
                                    <table class="etax_table table_border_blue" summary="계산서">
                                        <tbody id="InvoiceList">
                                            <colgroup>
                                                <col span="50" style="width: 1%;">
                                                <col span="50" style="width: 1%;">
                                            </colgroup>
                                            <tr>
                                                <input type="hidden" id="InvoicerID" name="InvoicerID">
                                                <input type="hidden" id="cltflag" name="cltflag">
                                                <th class="al_c noborder_l bold" colspan="8">매입 거래처</th>
                                                <td class="al_l pdl_3" colspan="38"><textarea class="txt_ar kr" style="width: 90%; margin-right: 5px;" maxlength="200" type="text" id="InvoicerCorpName" name="InvoicerCorpName" placeholder="입력 후 엔터" autocomplete="off"></textarea>
                                                <button class="btn_white_gradient mgl_2" id="btnSelectInvoicer" type="button" style="height:35px; margin-top:2px;">검색</button>
                                                </td>

                                                <th class="al_c bold" colspan="8">매입일자</th>
                                                <td class="al_l pdl_3" colspan="20">
                                                    <input type="date" id="writeDate" name="writeDate" class="in_txt numeric al_c dp-applied" maxlength="10" style="width: 190px; padding: 0 14px 0 5px;">
                                                </td>

                                                <th class="al_c" colspan="8">작성 방법</th>
                                                <td class="al_l pdl_3" colspan="20">
                                                    <select class="in_txt" id="WriteTypeSelect" name="WriteTypeSelect" style="width:190px; line-height:1;">
                                                        <option value="부가세 별도">부가세 별도</option>
                                                        <option value="부가세 포함">부가세 포함</option>
                                                        <option value="합계금액">합계금액</option>
                                                    </select>
                                                    <button id="totalAmountAct" type="button" class="btn_white_gradient" style="display: none;">계산 창 열기</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <input type="hidden" id="PaymentCorpID" name="PaymentCorpID">
                                                <input type="hidden" id="paycltflag" name="paycltflag">
                                                <th class="al_c noborder_l bold" colspan="8">지급 거래처</th>
                                                <td class="al_l pdl_3" colspan="38"><textarea class="txt_ar kr" style="width: 90%; margin-right: 5px;" maxlength="200" type="text" id="PaymentCorpName" name="PaymentCorpName" placeholder="입력 후 엔터" autocomplete="off"></textarea>
                                                <button class="btn_white_gradient mgl_2" id="btnSelectPaymentCorp" type="button" style="height:35px; margin-top:2px;">검색</button>
                                                </td>


                                                <th class="al_c bold" colspan="8"><span>증빙 구분</span></th>
                                                <td class="al_l pdl_3" colspan="20">
                                                    <select class="in_txt" id="purchase_type" name="purchase_type" style="width:190px; line-height:1;"></select>
                                                </td>
                                                <th class="al_c bold lh_14" colspan="8">세액 공제</th>
                                                <td class="al_l pdl_3" colspan="20">
                                                    <input style="width: 74%; margin-right: 5px;" class="in_txt numeric letspc_0" maxlength="12" type="text" id="tax_code" name="tax_code" placeholder="입력 후 엔터">
                                                    <input type="hidden" id="tax_codeHidden" name="tax_codeHidden">
                                                    <button class="btn_white_gradient mgl_2" id="btnSelecttax_code" type="button">검색</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th class="al_c noborder_l lh_14" colspan="8"><p><span>제목</span></p></th>
                                                <td class="al_l pdl_3" colspan="38"><textarea type="text" class="txt_ar kr" maxlength="300" id="title" name="title"></textarea></td>

                                                <th class="al_c bold" colspan="8"><span>귀속부서</span></th>
                                                <td class="al_l pdl_3" colspan="20">
                                                    <input style="width: 74%; margin-right: 5px;" class="in_txt numeric letspc_0" maxlength="12" type="text" id="att_depart" name="att_depart" placeholder="입력 후 엔터">
                                                    <input type="hidden" id="att_departHidden" name="att_departHidden">
                                                    <button class="btn_white_gradient mgl_2" id="btnSelectatt_depart" type="button">검색</button>
                                                </td>

                                                <th class="al_c bold" colspan="8"><span>카드번호</span></th>
                                                <td class="al_l pdl_3" colspan="20">
                                                    <input style="width: 74%; margin-right: 5px;" class="in_txt numeric letspc_0" maxlength="12" type="text" id="card_code" name="card_code" placeholder="입력 후 엔터">
                                                    <input type="hidden" id="card_codeHidden" name="card_codeHidden">
                                                    <button class="btn_white_gradient mgl_2" id="btnSelectcard_code" type="button">검색</button>
                                                </td>
                                            </tr>
                                        </tbody>

                                        <tbody id="remarkList">
                                            <tr>
                                                <th class="splitline noborder_t" colspan="50"></th>
                                                <th class="splitline noborder_t" colspan="50"></th>
                                            </tr>
                                            <tr>
                                                <th class="al_c noborder_l" colspan="8"><span class="bold">비고1</span></th>
                                                <td class="al_l pdl_3 gray_border_l" colspan="88"><input class="in_txt kr" maxlength="150" type="text" id="Remark1" name="Remark1" ></td>
                                                <td class="al_c item_l_border gray_border_l" colspan="4">
                                                    <a class="btn in_btn plus" title="추가" id="addRemark">
                                                        <img src="/images/icon/ico-plus.svg" alt="등록 아이콘">
                                                    </a>
                                                </td>
                                            </tr>
                                            <tr id="remark2" class="none">
                                                <th class="al_c noborder_l gray_border_t" colspan="8"><span class="bold">비고2</span></th>
                                                <td class="al_l pdl_3 gray_border_l gray_border_t" colspan="88"><input class="in_txt kr" maxlength="150" type="text" id="Remark2" name="Remark2" ></td>
                                                <td class="al_c item_l_border gray_border_l gray_border_t" colspan="4">
                                                    <a class="btn in_btn plus" title="삭제" id="removeRemark2">
                                                        <img src="/images/icon/ico-delete.svg" alt="삭제 아이콘">
                                                    </a>
                                                </td>
                                            </tr>
                                            <tr id="remark3" class="none">
                                                <th class="al_c noborder_l gray_border_t" colspan="8"><span class="bold">비고3</span></th>
                                                <td class="al_l pdl_3 gray_border_l gray_border_t" colspan="88"><input class="in_txt kr" maxlength="150" type="text" id="Remark3" name="Remark3" ></td>
                                                <td class="al_c item_l_border gray_border_l gray_border_t" colspan="4">
                                                    <a class="btn in_btn plus" title="삭제" id="removeRemark3">
                                                        <img src="/images/icon/ico-delete.svg" alt="삭제 아이콘">
                                                    </a>
                                                </td>
                                            </tr>
                                        </tbody>

                                        <tbody id="taxList">
                                            <tr>
                                                <th class="al_c noborder_l pet0 gray_border_l" colspan="8"><span class="bold">공급가액</span></th>
                                                <td class="al_l pet0 pdl_3 gray_border_t gray_border_l" colspan="25"><input class="in_txt readonly al_r" maxlength="22" readonly="readonly" type="text" id="SupplyCostTotal" name="SupplyCostTotal" ></td>
                                                <th class="al_c pet1 gray_border_l tax-related" colspan="8"><span class="bold">세액</span></th>
                                                <td class="al_l pet1 pdl_3 gray_border_t gray_border_l tax-related" colspan="25"><input class="in_txt readonly al_r" maxlength="22" readonly="readonly" type="text" id="TaxTotal" name="TaxTotal" ></td>
                                                <th class="al_c" colspan="8"><span class="bold">합계금액</span></th>
                                                <td class="al_l pdl_3" colspan="26"><input class="in_txt readonly al_r" maxlength="22" readonly="readonly" type="text" id="TotalAmount" name="TotalAmount" ></td>
                                            </tr>
                                            <tr>
                                                <th class="al_c noborder_l" colspan="4"><span class="bold">월</span></th>
                                                <th class="al_c item_l_border" colspan="4"><span class="bold">일</span></th>
                                                <th class="al_c item_l_border" colspan="18"><span class="bold">품목</span></th>
                                                <th class="al_c item_l_border" colspan="10"><span class="bold">규격</span></th>
                                                <th class="al_c pet2 item_l_border" colspan="6"><span class="bold">수량</span></th>
                                                <th class="al_c pet3 item_l_border" colspan="6"><span class="bold">단가</span></th>
                                                <th class="al_c pet4 item_l_border" colspan="9"><span class="bold">공급가액</span></th>
                                                <th class="al_c pet5 item_l_border tax-related" colspan="8"><span class="bold">세액</span></th>
                                                <th class="al_c item_l_border" colspan="7"><span class="bold">비용항목</span></th>
                                                <th class="al_c item_l_border" colspan="7"><span class="bold">계정과목</span></th>
                                                <th class="al_c item_l_border" colspan="7"><span class="bold">프로젝트</span></th>
                                                <th class="al_c item_l_border" colspan="10"><span class="bold">비고</span></th>
                                                <th class="al_c item_l_border" colspan="4">
                                                    <a class="btn in_btn plus" title="추가" id="btnAddFiveDetails">
                                                        <img src="/images/icon/ico-plus.svg" alt="등록 아이콘">
                                                    </a>
                                                </th>
                                            </tr>
                                            <tr id="item_0">
                                                <td class="al_l pdl_3 noborder_l item_t_border" colspan="4">
                                                    <input type="hidden" id="detailList0.SerialNum" name="detailList[0].SerialNum" >
                                                    <input type="hidden" id="detailList0.PurchaseDT" name="detailList[0].PurchaseDT" >
                                                    <input class="in_txt numeric al_c in_detail" maxlength="2" type="text" id="detailList0.PurchaseDT1" name="detailList[0].PurchaseDT1">
                                                </td>
                                                <td class="al_l pdl_3 item_border" colspan="4">
                                                    <input class="in_txt numeric al_c in_detail" maxlength="2" type="text" id="detailList0.PurchaseDT2" name="detailList[0].PurchaseDT2">
                                                </td>
                                                <td class="al_l pdl_3 item_border" colspan="18">
                                                    <div class="align-center-wrap">
                                                        <input type="hidden" id="detailList0.ItemId" name="detailList[0].ItemId">
                                                        <textarea class="txt_ar" style="width: 88%; margin-right: 3px;" maxlength="100" id="detailList0.ItemName" name="detailList[0].ItemName" placeholder="입력 후 엔터"></textarea>
                                                        <a class="btn in_btn" title="검색" id="btnViewItem_0">
                                                            <img src="/images/icon/btn-srch-black.svg" alt="검색 아이콘">
                                                        </a>
                                                    </div>
                                                </td>
                                                <td class="al_l pdl_3 item_border" colspan="10"><textarea class="txt_ar" maxlength="60" id="detailList0.Spec" name="detailList[0].Spec"></textarea></td>
                                                <td class="al_l pdl_3 item_border pet2" colspan="6"><input class="in_txt numeric number al_r in_detail" maxlength="16" type="text" id="detailList0.Qty" name="detailList[0].Qty" ></td>
                                                <td class="al_l pdl_3 item_border pet3" colspan="6"><input class="in_txt numeric number al_r in_detail" maxlength="22" type="text" id="detailList0.UnitCost" name="detailList[0].UnitCost" ></td>
                                                <td class="al_l pdl_3 item_border pet4" colspan="9"><input class="in_txt numeric money al_r in_detail" maxlength="22" type="text" id="detailList0.SupplyCost" name="detailList[0].SupplyCost" ></td>
                                                <td class="al_l pdl_3 item_border pet5 tax-related" colspan="8"><input class="in_txt numeric money al_r in_detail" maxlength="22" type="text" id="detailList0.Tax" name="detailList[0].Tax" ></td>
                                                <input type="hidden" id="detailList0.ExpenseId" name="detailList[0].ExpenseId">
                                                <td class="al_l pdl_3 item_border" colspan="7"><textarea class="txt_ar" maxlength="60" id="detailList0.ExpenseNm" name="detailList[0].ExpenseNm" placeholder="입력 후 엔터"></textarea></td>
                                                <input type="hidden" id="detailList0.AccountId" name="detailList[0].AccountId">
                                                <td class="al_l pdl_3 item_border" colspan="7"><textarea class="txt_ar" maxlength="60" id="detailList0.AccountNm" name="detailList[0].AccountNm" placeholder="입력 후 엔터"></textarea></td>
                                                <input type="hidden" id="detailList0.ProjectId" name="detailList[0].ProjectId">
                                                <td class="al_l pdl_3 item_border" colspan="7"><textarea class="txt_ar" maxlength="60" id="detailList0.ProjectNm" name="detailList[0].ProjectNm" placeholder="입력 후 엔터"></textarea></td>
                                                <td class="al_l pdl_3 item_border" colspan="10"><textarea class="txt_ar" maxlength="100" id="detailList0.Remark" name="detailList[0].Remark"></textarea></td>
                                                <td class="al_c item_border" colspan="4">
                                                    <a class="btn in_btn" title="삭제" id="btnDelItem_0">
                                                        <img src="/images/icon/ico-delete.svg" alt="삭제 아이콘">
                                                    </a>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>


            <div class="popup-button">
                <button type="button" class="btn-popup" id="btnInvoiceNew" ><span data-commonCd="신규">신규</span></button>
                <button type="button" class="btn-popup" id="btnInvoiceSave" ><span data-commonCd="저장(ctrl+s)">저장</span></button>
                <button type="button" class="btn-popup" id="btnDelete" style="display:none;"><span data-commonCd="삭제(shift+del)">삭제</span></button>
                <button type="button" class="btn-popup" id="modal-close-button"><span data-commonCd="닫기">닫기</span></button>
                <!-- 포커스 받을 숨겨진 div (탭 가능) -->
                <div id="keyboardFocusCatcher" tabindex="0" style="position:absolute; opacity:0; pointer-events:none;"></div>

            </div>


        </div>
    </script>

    <script type="text/javascript">

        class PopPurchaseInvoiceComponent {
            constructor() {

            }

        }

        function clearInvoiceeFields() {
            if (!window.__skipInvoiceeFieldReset) {
                const fields = [
                    'InvoiceeID', 'InvoiceeCorpNum', 'InvoiceeTaxRegID',
                    'InvoiceeCorpName', 'InvoiceeCEOName', 'InvoiceeAddr',
                    'InvoiceeBizType', 'InvoiceeBizClass', 'InvoiceeContactName1',
                    'InvoiceeTEL1', 'InvoiceeEmail1'
                ];
                fields.forEach(id => $('#' + id).val(''));
                $('#InvoiceeCorpNum').removeAttr('readonly');
            }


        }

        $('#WriteTypeSelect').on('change', function () {
            const taxType = $(this).val();

            if (taxType === '부가세 별도') {
                $('#taxList').find('input[id$="SupplyCost"], input[id$="Tax"]').prop('readonly', false);
            } else if (taxType === '부가세 포함') {
                $('#taxList').find('input[id$="SupplyCost"], input[id$="Tax"]').prop('readonly', true);
            } else if (taxType === '합계금액') {
                $('#taxList').find('input[id$="SupplyCost"], input[id$="Tax"]').prop('readonly', false);
            }

            updateTaxLayout(taxType);
        });

        function updateTaxLayout(taxType) {
            const showTax = taxType !== '합계금액'; // 세액 감추는 조건

            if (!showTax) {
                $('.tax-related').hide();
                $('td.pet0').attr('colspan', 42);
                $('th[colspan="12"].pet4, td[colspan="12"].pet4').attr('colspan', 22);
            } else {
                $('.tax-related').show();
                $('th.pet4, td.pet4').attr('colspan', 12);
                $('th.pet0').attr('colspan', 8);
                $('td.pet0').attr('colspan', 17);
            }
        }


        $(document).on('click', '#addRemark', function () {
            if ($('#remark2').is(':hidden')) {
                $('#remark2').removeClass('none');
            } else if ($('#remark3').is(':hidden')) {
                $('#remark3').removeClass('none');
            } else {
                Alert.alert('', '비고는 3개까지 추가할 수 있습니다.');
            }
        });

        $(document).on('click', '#removeRemark2', function () {
            if (!$('#remark3').hasClass('none')) {
                $('#remark3').addClass('none');
                $('#Remark3').val('');
            } else if (!$('#remark2').hasClass('none')) {
                $('#remark2').addClass('none');
                $('#Remark2').val('');
            }
        });

        $(document).on('click', '#removeRemark3', function () {
            $('#remark3').addClass('none');
            $('#Remark3').val('');
        });

        let detailRowCount = 0; // 현재 detail 행의 개수 (전역)

        // 품목 행 디폴트
        function initializeDetailRows(data = []) {
            const $originRow = $('#item_0');
            const rowCount = Math.max(data.length, 4);

            for (let i = 0; i < rowCount; i++) {
                let $newRow = $originRow.clone();
                $newRow.attr('id', 'item_' + i);

                $newRow.find('input, textarea, a').each(function () {
                    const $this = $(this);
                    const oldId = $this.attr('id');
                    const oldName = $this.attr('name');

                    if (oldId) {
                        let newId = oldId.replace(/detailList\d+/g, 'detailList' + i)
                            .replace(/btnViewItem_\d+/g, 'btnViewItem_' + i)
                            .replace(/btnDelItem_\d+/g, 'btnDelItem_' + i);
                        $this.attr('id', newId);
                    }

                    if (oldName) {
                        const newName = oldName.replace(/detailList\[\d+\]/g, 'detailList[' + i + ']');
                        $this.attr('name', newName);
                    }

                    if ($this.is('input[type="text"], input[type="hidden"], textarea') && data[i]) {
                        const match = $this.attr('name')?.match(/detailList\[\d+\]\.(\w+)/);
                        const field = match?.[1];
                        if (field && data[i]?.[field] !== undefined) {
                            $this.val(data[i][field]);
                        } else {
                            $this.val('');
                        }
                    }
                });

                $newRow.find('input[id$=".SerialNum"]').val(i + 1);

                if (i === 0) {
                    $originRow.replaceWith($newRow);
                } else {
                    $('#item_' + (i - 1)).after($newRow);
                }
            }
            updateTotals();
            detailRowCount = rowCount;
        }

        // 품목행 추가 버튼
        $(document).on('click', '#btnAddFiveDetails', function () {
            addFiveDetails();
            $('#writeDate').trigger('change');
        });

        // 품목행 삭제 버튼
        $(document).on('click', 'a[id^="btnDelItem_"]', function () {
            const $row = $(this).closest('tr');

            // 현재 남아있는 줄 개수
            const currentRowCount = $('tr[id^="item_"]').length;

            if (currentRowCount <= 4) {
                $row.find('input, textarea').each(function () {
                    $(this).val('');
                });
                updateTotals();
                return;
            }

            // 삭제하고
            $row.remove();

            // 삭제 후 재정렬
            reindexDetailRows();

            // 계산 다시
            updateTotals();
        });

        // 품목 5번째 행부터 추가
        function addFiveDetails() {
            let currentRowCount = $('tr[id^="item_"]').length;

            for (let i = 0; i < 5; i++) {
                const $originRow = $('#item_0');
                let $newRow = $originRow.clone();

                let newIndex = currentRowCount + i;

                $newRow.attr('id', 'item_' + newIndex);

                $newRow.find('input, textarea, a').each(function () {
                    const $this = $(this);
                    const oldId = $this.attr('id');
                    const oldName = $this.attr('name');

                    if (oldId) {
                        let newId = oldId.replace(/detailList\d+/g, 'detailList' + newIndex)
                            .replace(/btnViewItem_\d+/g, 'btnViewItem_' + newIndex)
                            .replace(/btnDelItem_\d+/g, 'btnDelItem_' + newIndex);
                        $this.attr('id', newId);
                    }
                    if (oldName) {
                        const newName = oldName.replace(/detailList\[\d+\]/g, 'detailList[' + newIndex + ']');
                        $this.attr('name', newName);
                    }
                    if ($this.is('input[type="text"], input[type="hidden"], textarea')) {
                        $this.val('');
                    }
                });

                $('tr[id^="item_"]').last().after($newRow);
            }

            reindexDetailRows(); // 추가 후 항상 정렬
        }


        // 품목행 인덱스 재정렬
        function reindexDetailRows() {
            $('tr[id^="item_"]').each(function (index) {
                const $row = $(this);

                // 행 id 수정
                $row.attr('id', 'item_' + index);

                $row.find('input, textarea, a').each(function () {
                    const $this = $(this);
                    const oldId = $this.attr('id');
                    const oldName = $this.attr('name');

                    if (oldId) {
                        let newId = oldId.replace(/detailList\d+/g, 'detailList' + index)
                            .replace(/btnViewItem_\d+/g, 'btnViewItem_' + index)
                            .replace(/btnDelItem_\d+/g, 'btnDelItem_' + index);
                        $this.attr('id', newId);
                    }
                    if (oldName) {
                        const newName = oldName.replace(/detailList\[\d+\]/g, 'detailList[' + index + ']');
                        $this.attr('name', newName);
                    }
                });

                // **SerialNum은 tr 순서대로 index + 1**
                $row.find('input[id$=".SerialNum"]').val(index + 1);
            });

            detailRowCount = $('tr[id^="item_"]').length;
        }


        // 총합계 계산 (공급가액 + 세액)
        function updateTotals() {
            let supplyCostSum = 0;
            let taxSum = 0;

            $('input[id$=".SupplyCost"]').each(function () {
                const val = parseFloat($(this).val().replace(/,/g, '')) || 0;
                supplyCostSum += val;
            });

            $('input[id$=".Tax"]').each(function () {
                const val = parseFloat($(this).val().replace(/,/g, '')) || 0;
                taxSum += val;
            });

            $('#SupplyCostTotal').val(supplyCostSum.toLocaleString());
            $('#TaxTotal').val(taxSum.toLocaleString());
            $('#TotalAmount').val((supplyCostSum + taxSum).toLocaleString());
        }


        function recalculateTaxesForRow($row) {
            const taxMode = $('input[name="TaxType"]:checked').val();       // 과세 / 영세 / 면세
            const writeType = $('#WriteTypeSelect').val();   // 단가 유형

            const $qty = $row.find('input[id$="Qty"]');
            const $unitCost = $row.find('input[id$="UnitCost"]');
            const $supplyCost = $row.find('input[id$="SupplyCost"]');
            const $tax = $row.find('input[id$="Tax"]');

            let qty = parseFloat($qty.val().replace(/,/g, '').trim()) || 0;
            let unitCost = parseFloat($unitCost.val().replace(/,/g, '').trim()) || 0;

            if (qty && unitCost) {
                let supplyCost = 0;
                let tax = 0;

                if (writeType === '부가세 포함' && taxMode === '과세') {
                    const total = qty * unitCost;
                    const supply = total / 1.1;
                    supplyCost = Math.floor(supply);
                    tax = total - supplyCost;
                } else {
                    supplyCost = qty * unitCost;
                    tax = (taxMode === '과세') ? Math.floor(supplyCost * 0.1) : 0;
                }

                $supplyCost.val(supplyCost.toLocaleString());
                $tax.val(tax.toLocaleString());
            }
        }


        function recalculateTaxesIfNeeded() {
            const taxType = $('input[name="TaxType"]:checked').val();

            let index = 0;
            while (true) {
                const $supplyCost = $('#detailList' + index + '\\.SupplyCost');
                const $tax = $('#detailList' + index + '\\.Tax');

                if ($supplyCost.length === 0 || $tax.length === 0) break;

                let supplyCostVal = $supplyCost.val().replace(/,/g, '').trim();
                let supplyCost = parseFloat(supplyCostVal) || 0;

                if (supplyCost > 0) {
                    if (taxType === '영세' || taxType === '면세') {
                        $tax.val('0');
                    } else if (taxType === '과세') {
                        let tax = Math.round(supplyCost * 0.1);
                        $tax.val(tax.toLocaleString());
                    }
                }

                index++;
            }

            updateTotals();
        }

        function updateWriteTypeBehavior(writeType) {
            const $supplyCostInputs = $('#taxList').find('input[id$="SupplyCost"]');
            const $taxInputs = $('#taxList').find('input[id$="Tax"]');

            if (writeType === '부가세 포함') {
                $supplyCostInputs.prop('readonly', true);
                $taxInputs.prop('readonly', true);
            } else if (writeType === '수량단가') {
                $supplyCostInputs.prop('readonly', true);
                $taxInputs.prop('readonly', true);
            } else if (writeType === '직접입력') {
                $supplyCostInputs.prop('readonly', false);
                $taxInputs.prop('readonly', true); // 영세, 면세 기준
            } else {
                $supplyCostInputs.prop('readonly', false);
                $taxInputs.prop('readonly', false);
            }
        }

        // "합계금액" 선택
        $(document).on('change', '#WriteTypeSelect', function () {
            const writeType = $(this).val();
            updateWriteTypeBehavior(writeType);

            if (writeType === '합계금액') {
                openPopup(); // 기존에 사용하던 모달 여는 함수
            }
        });

        // "계산 창 열기" 버튼 클릭
        $(document).on('click', '#totalAmountAct', function (event) {
            event.stopPropagation(); // 이벤트 버블링 막기
            openPopup();
        });

        function openPopup() {
            let poppage = new PopTotalAmountComponent();
            let searchcallback = function (items) {
                let index = 0;
                while (true) {
                    let $supplyCost = $(document).find('#detailList' + index + '\\.SupplyCost');
                    let $tax = $(document).find('#detailList' + index + '\\.Tax');

                    // 없으면 반복 종료
                    if ($supplyCost.length === 0 || $tax.length === 0) {
                        break;
                    }

                    // 비어있는 행 찾기
                    if ($supplyCost.val().trim() === '' && $tax.val().trim() === '') {
                        $supplyCost.val(items.supplyCost.toLocaleString());
                        $tax.val(items.tax.toLocaleString());

                        const $row = $supplyCost.closest('tr');
                        recalculateTaxesForRow($row);
                        updateTotals();

                        break; // 입력했으면 멈춘다
                    }


                    index++;
                }

            };

            poppage.show(searchcallback);
        }


        // 수량 또는 단가 입력 → 공급가 + 세액 계산
        $(document).on('input', '#taxList input[id$="Qty"], #taxList input[id$="UnitCost"]', function () {
            const $row = $(this).closest('tr');
            const $qty = $row.find('input[id$="Qty"]');
            const $unitCost = $row.find('input[id$="UnitCost"]');

            const qtyVal = $qty.val().replace(/,/g, '').trim();
            const unitCostVal = $unitCost.val().replace(/,/g, '').trim();

            if (qtyVal !== '' && unitCostVal !== '') {
                recalculateTaxesForRow($row);
                updateTotals();
            }
        });

        // 공급가 입력 → 세액 계산
        $(document).on('input', '#taxList input[id$="SupplyCost"]', function () {
            const $row = $(this).closest('tr');
            const taxMode = $('input[name="TaxType"]:checked').val();
            const $supplyCost = $row.find('input[id$="SupplyCost"]');
            const $tax = $row.find('input[id$="Tax"]');

            let supplyCost = parseFloat($supplyCost.val().replace(/,/g, '').trim()) || 0;
            let tax = taxMode === '과세' ? Math.floor(supplyCost * 0.1) : 0;

            $tax.val(tax.toLocaleString());
            updateTotals();
        });

        // 세액 직접 입력 시 → 합계 업데이트
        $(document).on('input', '#taxList input[id$="Tax"]', function () {
            updateTotals();
        });

        // 수량, 단가, 공급가액, 세액 필드 입력 시 숫자형으로 포맷팅 (천단위 콤마)
        $(document).on('input', '#taxList input[id$="Qty"], #taxList input[id$="UnitCost"], #taxList input[id$="SupplyCost"], #taxList input[id$="Tax"]', function () {
            let raw = $(this).val().replace(/,/g, ''); // 기존 콤마 제거
            if (raw.length > 0 && !isNaN(raw)) {
                $(this).val(Number(raw).toLocaleString()); // 숫자면 콤마 다시 붙이기
            }
        });

        // 사업자번호 또는 주민등록번호 입력 시 자동 포맷 적용
        $(document).on('input', '#InvoicerCorpNum, #InvoiceeCorpNum', function () {
            const isInvoicee = $(this).attr('id') === 'InvoiceeCorpNum';
            const invoiceeType = $('input[name="InvoiceeType"]:checked').val(); // 라디오 버튼일 경우

            let rawValue = $(this).val();

            if (isInvoicee && (invoiceeType === '개인' || invoiceeType === '외국인')) {
                $(this).attr('maxlength', 14); // 주민등록번호는 총 14자리 (하이픈 포함)
                $(this).val(formatRRN(rawValue));
            } else {
                $(this).attr('maxlength', 12); // 사업자번호 최대 길이 (하이픈 포함)
                $(this).val(formatBizNum(rawValue));
            }
        });

        // 사업자등록번호 포맷팅 (###-##-#####)
        function formatBizNum(value) {
            value = value.replace(/[^0-9]/g, '').slice(0, 10);
            if (value.length > 3 && value.length <= 5) {
                return value.slice(0, 3) + '-' + value.slice(3);
            } else if (value.length > 5) {
                return value.slice(0, 3) + '-' + value.slice(3, 5) + '-' + value.slice(5);
            }
            return value;
        }

        function formatMaskedRRN(value) {
            value = value.replace(/[^0-9*]/g, '');

            if (value.length >= 7) {
                return value.replace(/^(\d{6})(\d+)/, '$1-$2');
            }

            return value;
        }

        // 주민등록번호 포맷팅 (######-#######)
        function formatRRN(value) {
            value = value.replace(/[^0-9]/g, '').slice(0, 13);
            if (value.length > 6) {
                return value.slice(0, 6) + '-' + value.slice(6);
            }
            return value;
        }


        // 전화번호 포맷팅 (지역번호 감지)
        function formatPhoneNumber(value) {
            value = value.replace(/[^0-9]/g, '');

            // 서울 지역번호 (02)
            if (value.startsWith('02')) {
                if (value.length > 2 && value.length <= 5) {
                    return value.slice(0, 2) + '-' + value.slice(2);
                } else if (value.length > 5 && value.length <= 9) {
                    return value.slice(0, 2) + '-' + value.slice(2, 5) + '-' + value.slice(5);
                } else if (value.length > 9) {
                    return value.slice(0, 2) + '-' + value.slice(2, 6) + '-' + value.slice(6, 10);
                }
            }

            // 나머지 지역번호 (031, 051, 010 등)
            if (value.length > 3 && value.length <= 6) {
                return value.slice(0, 3) + '-' + value.slice(3);
            } else if (value.length > 6 && value.length <= 10) {
                return value.slice(0, 3) + '-' + value.slice(3, 6) + '-' + value.slice(6);
            } else if (value.length > 10) {
                return value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
            }

            return value;
        }

        // 전화번호 입력 시 자동 포맷 적용
        $(document).on('input', '#InvoicerTEL, #InvoiceeTEL1', function () {
            $(this).val(formatPhoneNumber($(this).val()));
        });

        // 금액 입력 시 숫자만 허용 + 천단위 콤마 포맷 적용
        $(document).on('input', '#Cash, #ChkBill, #Note, #Credit', function () {
            let inputVal = $(this).val().replace(/[^0-9]/g, ''); // 숫자만 남김
            if (inputVal === '') {
                $(this).val('');
                return;
            }
            let formatted = Number(inputVal).toLocaleString('en-US'); // 천 단위 , 추가
            $(this).val(formatted);
        });

        // 세액 공제
        $(document).on('keydown', '#tax_code', function (e) {
            if (e.type === 'keydown' && e.key !== 'Enter' && e.keyCode !== 13) return;

            e.preventDefault();

            const keyword = $('#tax_code').val().trim();
            const poppage = new PopDeductionComponent();

            const searchcallback = function (item) {
                $('#tax_code').val(item.name);
                $('#tax_codeHidden').val(item.code);
                setTimeout(() => {
                    $('#title').focus(); // 필요에 따라 포커스 위치 조정
                }, 0);
            };

            if (!keyword) {
                poppage.focusAfterClose = document.getElementById('tax_code');
                poppage.show(searchcallback);
                return;
            }

            // 검색 조건
            const data = {
                srchCode: '',
                srchName: keyword,
                spjangcd: sessionStorage.getItem('spjangcd')
            };

            const result = AjaxUtil.getSyncData('/api/popup/search_deduction', data);
            const rows = result?.data || [];

            if (rows.length === 1) {
                searchcallback(rows[0]);
            } else {
                poppage.show(searchcallback);
                setTimeout(() => {
                    poppage.$srchName.val(keyword);
                    poppage.$btnSearch.trigger('click');
                }, 50);
            }
        });

        // 세액 공제 선택
        $(document).on('click', '#btnSelecttax_code', function () {
            let poppage = new PopDeductionComponent();
            let searchcallback = function (items) {
                $(document).find('#tax_code').val(items.name);
                $(document).find('#tax_codeHidden').val(items.code);
                setTimeout(() => {
                    $('#title').focus(); // 필요에 따라 포커스 위치 조정
                }, 0);
            };

            poppage.show(searchcallback);
        });

        // 귀속부서
        $(document).on('keydown', '#att_depart', function (e) {
            if (e.type === 'keydown' && e.key !== 'Enter' && e.keyCode !== 13) return;

            e.preventDefault();

            const keyword = $('#att_depart').val().trim();
            const poppage = new PopDepartComponent();

            const searchcallback = function (item) {
                $('#att_depart').val(item.Name);
                $('#att_departHidden').val(item.Code);
                setTimeout(() => {
                    $('#card_code').focus(); // 필요에 따라 포커스 위치 조정
                }, 0);
            };

            if (!keyword) {
                poppage.focusAfterClose = document.getElementById('att_depart');
                poppage.show(searchcallback);
                return;
            }

            // 검색 조건
            const data = {
                srchCode: '',
                srchName: keyword,
                spjangcd: sessionStorage.getItem('spjangcd')
            };

            const result = AjaxUtil.getSyncData('/api/popup/search_depart', data);
            const rows = result?.data || [];

            if (rows.length === 1) {
                searchcallback(rows[0]);
            } else {
                poppage.show(searchcallback);
                setTimeout(() => {
                    poppage.$srchName.val(keyword);
                    poppage.$btnSearch.trigger('click');
                }, 50);
            }
        });


        // 귀속부서 선택
        $(document).on('click', '#btnSelectatt_depart', function () {
            let poppage = new PopDepartComponent();
            let searchcallback = function (items) {
                $(document).find('#att_depart').val(items.Name);
                $(document).find('#att_departHidden').val(items.Code);
                setTimeout(() => {
                    $('#card_code').focus(); // 필요에 따라 포커스 위치 조정
                }, 0);
            };

            poppage.show(searchcallback);
        });

        // 카드번호
        $(document).on('keydown', '#card_code', function (e) {
            if (e.type === 'keydown' && e.key !== 'Enter' && e.keyCode !== 13) return;

            e.preventDefault();

            const keyword = $('#card_code').val().trim();
            const poppage = new PopCardComponent();

            const searchcallback = function (item) {
                console.log('items.cardnum', item.cardnum);
                $('#card_code').val(item.cardnum).trigger('input');
                $('#card_codeHidden').val(item.id);
                setTimeout(() => {
                    $('#Remark1').focus(); // 필요에 따라 포커스 위치 조정
                }, 0);
            };

            if (!keyword) {
                poppage.focusAfterClose = document.getElementById('card_code');
                poppage.show(searchcallback);
                return;
            }

            // 검색 조건
            const data = {
                txtcardnum: keyword,
                txtcardnm: '',
                spjangcd: sessionStorage.getItem('spjangcd')
            };

            const result = AjaxUtil.getSyncData('/api/transaction/manageCreditCard/read', data);
            const rows = result?.data || [];
            if (rows.length === 1) {
                searchcallback(rows[0]);
            } else {
                poppage.show(searchcallback);
                setTimeout(() => {
                    poppage.$srchCode.val(keyword);
                    poppage.$btnSearch.trigger('click');
                }, 50);
            }
        });


        // 카드번호 선택
        $(document).on('click', '#btnSelectcard_code', function () {
            let poppage = new PopCardComponent();
            let searchcallback = function (items) {
                console.log('items.cardnum', items.cardnum);
                $(document).find('#card_code').val(items.cardnum).trigger('input');
                $(document).find('#card_codeHidden').val(items.id);
                setTimeout(() => {
                    $('#Remark1').focus(); // 필요에 따라 포커스 위치 조정
                }, 0);
            };

            poppage.show(searchcallback);

        });

        // 카드번호 자동 하이픈 처리
        $(document).on('input', '#card_code', function (e) {
            let value = e.target.value.replace(/\D/g, '');
            console.log('value', value);  // 여기에 숫자만 출력됨
            let formatted = '';

            if (value.length === 15) {
                formatted = value.replace(/^(\d{0,4})(\d{0,6})(\d{0,5})/, function(_, a, b, c) {
                    return [a, b, c].filter(Boolean).join('-');
                });
            } else {
                formatted = value.match(/.{1,4}/g)?.join('-') ?? value;
            }

            e.target.value = formatted;
        });

        // Enter 키로 품목 선택 팝업 열기
        $(document).on('keydown', 'textarea[id$=".ItemName"]', function (e) {
            if (e.key !== 'Enter' && e.keyCode !== 13) return;

            e.preventDefault();

            const $field = $(this);
            const $row = $field.closest('tr');

            const keyword = $field.val().trim();
            const pop = new PopMatComponent();
            pop.material_type = 'product,sangpum';

            const callback = function (item) {
                $row.find('input[id$=".ItemId"]').val(item.id || '');
                $row.find('textarea[id$=".ItemName"]').val(item.Name || '');
                $row.find('textarea[id$=".Spec"]').val(item.Spec || '');
            };

            if (!keyword) {
                pop.focusAfterClose = $field[0];
                pop.show(callback);
                return;
            }

            const data = {
                keyword: keyword,
                spjangcd: sessionStorage.getItem('spjangcd')
            };

            const result = AjaxUtil.getSyncData('/api/popup/search_material', data);
            const rows = result?.data || [];

            if (rows.length === 1) {
                callback(rows[0]);
            } else {
                pop.show(callback);
                setTimeout(() => {
                    pop.$keyword.val(keyword);
                    pop.$btnMaterialSearch.trigger('click');
                }, 50);
            }
        });

        // 비용 항목 팝업 열기
        $(document).on('keydown', 'textarea[id$=".ExpenseNm"]', function (e) {
            if (e.key !== 'Enter' && e.keyCode !== 13) return;

            e.preventDefault();

            const $field = $(this);
            const $row = $field.closest('tr');

            const keyword = $field.val().trim();
            const pop = new PopExpenseComponent();

            const callback = function (item) {
                $row.find('input[id$=".ExpenseId"]').val(item.artcd || '');
                $row.find('textarea[id$=".ExpenseNm"]').val(item.artnm || '');
            };

            if (!keyword) {
                pop.focusAfterClose = $field[0];
                pop.show(callback);
                return;
            }

            const data = {
                srchName: keyword,
                spjangcd: sessionStorage.getItem('spjangcd')
            };

            const result = AjaxUtil.getSyncData('/api/popup/search_expense', data);
            const rows = result?.data || [];

            if (rows.length === 1) {
                callback(rows[0]);
            } else {
                pop.show(callback);
                setTimeout(() => {
                    pop.$srchName.val(keyword);
                    pop.$btnSearch.trigger('click');
                }, 50);
            }
        });

        // 계정 코드 팝업 열기
        $(document).on('keydown', 'textarea[id$=".AccountNm"]', function (e) {
            if (e.key !== 'Enter' && e.keyCode !== 13) return;

            e.preventDefault();

            const $field = $(this);
            const $row = $field.closest('tr');

            const keyword = $field.val().trim();
            const pop = new PopAccSubComponent();

            const callback = function (item) {
                $row.find('input[id$=".AccountId"]').val(item.acccd || '');
                $row.find('textarea[id$=".AccountNm"]').val(item.accnm || '');
            };

            if (!keyword) {
                pop.focusAfterClose = $field[0];
                pop.show(callback);
                return;
            }

            const data = {
                srchName: keyword,
                spjangcd: sessionStorage.getItem('spjangcd')
            };

            const result = AjaxUtil.getSyncData('/api/popup/search_acc_sub', data);
            const rows = result?.data || [];

            if (rows.length === 1) {
                callback(rows[0]);
            } else {
                pop.show(callback);
                setTimeout(() => {
                    pop.$srchName.val(keyword);
                    pop.$btnSearch.trigger('click');
                }, 50);
            }
        });

        // 프로젝트 팝업 열기
        $(document).on('keydown', 'textarea[id$=".ProjectNm"]', function (e) {
            if (e.key !== 'Enter' && e.keyCode !== 13) return;

            e.preventDefault();

            const $field = $(this);
            const $row = $field.closest('tr');

            const keyword = $field.val().trim();
            const pop = new PopProjectComponent();

            const callback = function (item) {
                $row.find('input[id$=".ProjectId"]').val(item.projno || '');
                $row.find('textarea[id$=".ProjectNm"]').val(item.projnm || '');
            };

            if (!keyword) {
                pop.focusAfterClose = $field[0];
                pop.show(callback);
                return;
            }

            const data = {
                srchName: keyword,
                spjangcd: sessionStorage.getItem('spjangcd')
            };

            const result = AjaxUtil.getSyncData('/api/popup/search_project', data);
            const rows = result?.data || [];

            if (rows.length === 1) {
                callback(rows[0]);
            } else {
                pop.show(callback);
                setTimeout(() => {
                    pop.$srchName.val(keyword);
                    pop.$btnSearch.trigger('click');
                }, 50);
            }
        });

        // 이름 다 지우면 id 값도 빠짐
        $(document).on('input', '#tax_code', function () {
            if ($(this).val().trim() === '') {
                $('#tax_codeHidden').val('');
            }
        });

        $(document).on('input', '#card_code', function () {
            if ($(this).val().trim() === '') {
                $('#card_codeHidden').val('');
            }
        });

        $(document).on('input', '#tax_code', function () {
            if ($(this).val().trim() === '') {
                $('#projectHidden').val('');
            }
        });

        $(document).on('input', 'textarea[id^="detailList"][id$=".ItemName"]', function () {
            const id = $(this).attr('id'); // ex: detailList0.ItemName
            const match = id.match(/^detailList(\d+)\.ItemName$/);

            if (match !== null) {
                const index = match[1];
                const itemIdSelector = 'input[id="detailList' + index + '.ItemId"]'; // 속성 선택자 방식

                if ($(this).val().trim() === '') {
                    $(itemIdSelector).val('');
                }
            }
        });

        $(document).on('input', 'textarea[id^="detailList"][id$=".ExpenseNm"]', function () {
            const id = $(this).attr('id'); // ex: detailList0.ItemName
            const match = id.match(/^detailList(\d+)\.ExpenseNm$/);

            if (match !== null) {
                const index = match[1];
                const itemIdSelector = 'input[id="detailList' + index + '.ExpenseId"]'; // 속성 선택자 방식

                if ($(this).val().trim() === '') {
                    $(itemIdSelector).val('');
                }
            }
        });

        $(document).on('input', 'textarea[id^="detailList"][id$=".AccountNm"]', function () {
            const id = $(this).attr('id'); // ex: detailList0.ItemName
            const match = id.match(/^detailList(\d+)\.AccountNm$/);

            if (match !== null) {
                const index = match[1];
                const itemIdSelector = 'input[id="detailList' + index + '.AccountId"]'; // 속성 선택자 방식

                if ($(this).val().trim() === '') {
                    $(itemIdSelector).val('');
                }
            }
        });

        $(document).on('input', 'textarea[id^="detailList"][id$=".ProjectNm"]', function () {
            const id = $(this).attr('id'); // ex: detailList0.ItemName
            const match = id.match(/^detailList(\d+)\.ProjectNm$/);

            if (match !== null) {
                const index = match[1];
                const itemIdSelector = 'input[id="detailList' + index + '.ProjectId"]'; // 속성 선택자 방식

                if ($(this).val().trim() === '') {
                    $(itemIdSelector).val('');
                }
            }
        });

        $(document).on('keydown', function (e) {
            // Ctrl + S 저장
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
                e.preventDefault();
                $('#btnInvoiceSave').click();
            }

            // Shift + Delete 삭제
            if (e.shiftKey && (e.key === 'Delete' || e.key === 'Del')) {
                e.preventDefault();
                $('#btnDelete').click();
            }
        });

        $(document).on('keydown', 'input, textarea', function (e) {
            const key = e.key;

            if (!['Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(key)) return;
            e.preventDefault();

            const $input = $(this);
            const $row = $input.closest('tr');
            const nameAttr = $input.attr('name') || '';

            const focusOrder = [
                'ItemName',
                'Spec',
                'Qty',
                'UnitCost',
                'SupplyCost',
                'Tax',
                'ExpenseNm',
                'AccountNm',
                'ProjectNm',
                'Remark'
            ];

            const currentIndex = focusOrder.findIndex(key => nameAttr.includes(key));
            if (currentIndex === -1) return;

            let $nextInput = null;

            // ↔️ 좌우 이동
            if (key === 'ArrowRight' && currentIndex < focusOrder.length - 1) {
                const nextKey = focusOrder[currentIndex + 1];
                $nextInput = $row.find(`[name*="${nextKey}"]`);
            } else if (key === 'ArrowLeft' && currentIndex > 0) {
                const prevKey = focusOrder[currentIndex - 1];
                $nextInput = $row.find(`[name*="${prevKey}"]`);
            }

            // ↕️ 상하 이동
            if (key === 'ArrowDown' || key === 'ArrowUp') {
                const $targetRow = key === 'ArrowDown'
                    ? $row.nextAll('tr:visible').first()
                    : $row.prevAll('tr:visible').first();

                const targetKey = focusOrder[currentIndex];

                if (key === 'ArrowDown' && !$targetRow.length) {
                    // 마지막 줄에서 ↓ 누른 경우 행 추가
                    $('#btnAddFiveDetails').trigger('click');

                    setTimeout(() => {
                        const $rows = $('.item-table tbody tr:visible').not('.item-template-row');
                        const $newRow = $rows.last();
                        const $newInput = $newRow.find(`[name*="ItemName"]`);
                        if ($newInput.length) $newInput.focus().select();
                    }, 50);
                    return;
                }

                $nextInput = $targetRow.find(`[name*="${targetKey}"]`);
            }

            // ↵ Enter: 현재 줄에서 다음 필드
            if (key === 'Enter' && currentIndex < focusOrder.length - 1) {
                const nextKey = focusOrder[currentIndex + 1];
                $nextInput = $row.find(`[name*="${nextKey}"]`);
            } else if (key === 'Enter' && nameAttr.includes('Remark')) {
                const $nextRow = $row.nextAll('tr:visible').first();

                if (!$nextRow.length) {
                    $('#btnAddFiveDetails').trigger('click');

                    setTimeout(() => {
                        const $rows = $('.item-table tbody tr:visible').not('.item-template-row');
                        const $newRow = $rows.last();
                        const $newInput = $newRow.find(`[name*="ItemName"]`);
                        if ($newInput.length) $newInput.focus().select();
                    }, 50);
                    return;
                } else {
                    $nextInput = $nextRow.find(`[name*="ItemName"]`);
                }
            }

            if ($nextInput && $nextInput.length) {
                $nextInput.focus().select();
            }
        });


    </script>