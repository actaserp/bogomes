<html layout:decorate="~{layout_page}">
<head>
  <style>
      .wj-header {
          text-align: center !important;
      }
  </style>
</head>
<th:block layout:fragment="content">
  <div class="layout-contents">
    <div class="page-title-wrap">
      <div class="left">
        <h2>프로젝트 현황</h2>
        <a title="북마크" class="bookmark toggle">
          내 메뉴
        </a>
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
        <li>프로젝트관리</li>
        <li>프로젝트 현황</li>
      </ul>
    </div>

    <section class="section">
      <div class="section-top">
        <div class="search-wrap">
          <input type="hidden" id="spjangcdHidden">
          <dl>
            <dt>
              <label>프로젝트명</label>
            </dt>
            <dd>
              <div class="srch-box">
                <input type="text" class="form-control2" id="txtProjectName" name="txtProjectName" placeholder="프로젝트명">
              </div>
            </dd>
          </dl>

          <dl>
            <dt><span class="eq"></span></dt>
            <dd>
              <li>
                <a class="btn btn-delete" title="검색" id="btnSearch">
                  <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                  검색
                </a>
              </li>
            </dd>
          </dl>
        </div>
        <div class="button-wrap" style="border-top:none; text-align: right; !important;">
          <ul>
            <li>
              <a class="btn btn-excell" title="신규등록" id="Newbtn">
                <img src="/images/icon/ico-plus.svg" alt="등록 아이콘">
                신규등록
              </a>
            </li>
            <li>
              <a class="btn btn-edit" id="btnSave" title="저장">
                <img src="/images/icon/ico-save.svg" alt="저장 아이콘">
                저장
              </a>
            </li>
            <li>
              <a class="btn btn-delete" title="삭제" id="btnDelete">
                <img src="/images/icon/ico-delete.svg" alt="엑셀 아이콘">
                삭제
              </a>
            </li>
          </ul>
        </div>
      </div>
      <div class="container-fluid">
        <p id="ProjectStatus"></p>
        <div id="theGrid" style="height: 300px"></div>
      </div>
    </section>

    <div class="tab-wrap">
      <ul class="tab-links">
        <li><a href="#tabs_ExpenseHistory">경비사용내역</a></li>
        <li><a href="#tabs_SalesHistory">매출내역</a></li>
        <li><a href="#tabs_TransactionHistory">입출금내역</a></li>
      </ul>

      <div>
        <!--경비사용내역-->
        <section class="tab-item" id="tabs_ExpenseHistory" style="border-top-left-radius: 0;">
          <div class="container-fluid">
            <p id="ExpenseHistory"></p>
            <div id="ExpenseHistoryGrid" style="height: 300px; "></div>
          </div>
        </section>
        <!-- 매출내역 -->
        <section class="tab-item" id="tabs_SalesHistory" style="border-top-left-radius: 0;">
          <div class="container-fluid">
            <p id="SalesHistory"></p>
            <div id="SalesHistoryGrid" style="height: 300px; "></div>
          </div>
        </section>
        <!--입출금 내역-->
        <section class="tab-item" id="tabs_TransactionHistory" style="border-top-left-radius: 0;">
          <div class="container-fluid">
            <p id="TransactionHistory"></p>
            <div id="TransactionHistoryGrid" style="height: 300px; "></div>
          </div>
        </section>
      </div>
    </div>
  </div>


</th:block>

<th:block layout:fragment="scripts">
  <th:block th:replace="/common/approve_box :: approve_box"></th:block>
  <th:block th:replace="/common/ax5_uploader :: ax5_uploader"></th:block>
  <th:block th:replace="/common/upload_one_image_box :: upload_one_image_box"></th:block>
  <script type="text/javascript">
    class ProjectStatusPage {
      constructor() {
        this.grid = null;
        this.grid2 = null;
        this.grid3 = null;
        this.grid4 = null;
        this.viewData = new wijmo.collections.CollectionView();
        this.spjangcd = $('#spjangcdHidden');
        this.init();
      }//constructor

      init() {
        let _this = this;
        let userClicked = false;
        this.grid = new wijmo.grid.FlexGrid('#theGrid', {
          autoGenerateColumns: false,
          selectionMode: wijmo.grid.SelectionMode.Row,
          headersVisibility: wijmo.grid.HeadersVisibility.Column,
          isReadOnly: true,
          showMarquee: true,
          formatItem: (sender, e) => {
            if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
              e.cell.style.textAlign = 'center';
            }
          },
          columns: [
            {binding: 'projno', header: '번호', width: 100},
            {binding: 'projnm', header: '프로젝트명', width: 200},
            {binding: 'contdate', header: '계약일자', width: 110,align: 'center'},
            {binding: 'suju_totalamt', header: '수주금액', width: '*'},
            {binding: 'sales_totalamt', header: '매출금액', width: '*'},
            {binding: 'total_accin', header: '수금액', width: '*'},
            {binding: '', header: '소요경비', width: '*'},
            {binding: 'total_accout', header: '지급액', width: '*'},
            {binding: '', header: '수금여부', width: '*'},
            {binding: '', header: '손익액', width: '*'},
          ],
          itemsSource: this.viewData, // 데이터를 설정할 배열
        });

        new FlexGridContextMenu(this.grid);
        this.grid.downloadFileName = '프로젝트 현황';
        this.grid.hostElement.addEventListener('click', function (e) {
          let ht = _this.grid.hitTest(e); // 클릭된 위치 확인
          if (ht.cellType === wijmo.grid.CellType.Cell || ht.cellType === wijmo.grid.CellType.RowHeader) {
            userClicked = true;
          }
        });
        this.grid.selectionChanged.addHandler(function (s, e) {
          if (userClicked) {
            const selectedItem = s.selectedItems[0];
            if (selectedItem) {
              _this.loadTabData(selectedItem);
            }
            userClicked = false; // 클릭 처리 후 초기화
          }
        });

        // 엔터키 검색
        $('#txtProjectName').on('keypress', function (e) {
          if (e.keyCode === 13) {
            _this.searchMainData();
          }
        });

        //경비 사용내역
        this.grid2 = new wijmo.grid.FlexGrid('#ExpenseHistoryGrid', {
          autoGenerateColumns: false,
          selectionMode: wijmo.grid.SelectionMode.Row,
          headersVisibility: wijmo.grid.HeadersVisibility.Column,
          isReadOnly: true,
          showMarquee: true,
          formatItem: (sender, e) => {
            if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
              e.cell.style.textAlign = 'center';
            }
          },
          columns: [
            {binding: '', header: '매입일자', width: 110, align: 'center'},
            {binding: '', header: '번호', width: 100},
            {binding: '', header: '순번', width: 70, align: 'center'},
            {binding: '', header: '계정과목', width: '*'},
            {binding: '', header: '품목명', width: '*'},
            {binding: '', header: '규격', width: '*'},
            {binding: '', header: '수량', width: '*'},
            {binding: '', header: '단가', width: '*'},
            {binding: '', header: '공급가액', width: '*'},
            {binding: '', header: '세액', width: '*'},
            {binding: '', header: '비고', width: '*'},
          ],
          itemsSource: this.viewData, // 데이터를 설정할 배열
        });

        new FlexGridContextMenu(this.grid2);
        this.grid2.downloadFileName = '경비사용내역';

        //매출내역
        this.grid3 = new wijmo.grid.FlexGrid('#SalesHistoryGrid', {
          autoGenerateColumns: false,
          selectionMode: wijmo.grid.SelectionMode.Row,
          headersVisibility: wijmo.grid.HeadersVisibility.Column,
          isReadOnly: true,
          showMarquee: true,
          formatItem: (sender, e) => {
            if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
              e.cell.style.textAlign = 'center';
            }
          },
          columns: [
            {binding: 'misgubun', header: '매출구분', width: 100, align: 'center'},
            {binding: 'icerdeptnm', header: '부서', width: '*'},
            {binding: 'misdate', header: '일자', width: 110, align: 'center'},
            {binding: 'itemnm', header: '품목', width: '*'},
            {binding: 'spec', header: '규격', width: 80, align: 'center'},
            {binding: 'qty', header: '수량', width: 70, align: 'center'},
            {binding: 'unitcost', header: '단가', width: '*'},
            {binding: 'supplycost', header: '공급가액', width: '*'},
            {binding: 'taxtotal', header: '세액', width: '*'},
            {binding: 'remark', header: '비고', width: '*'},
          ],
          itemsSource: this.viewData, // 데이터를 설정할 배열
        });

        new FlexGridContextMenu(this.grid3);
        this.grid3.downloadFileName = '매출내역';
        //Footer 패널 사용 설정
        this.grid3.columnFooters.rows.push(new wijmo.grid.Row());
        //Footer 합계 설정
        this.grid3.loadedRows.addHandler(() => {
          const rows = this.grid3.rows;
          const footer = this.grid3.columnFooters.rows[0];

          const getSum = (field) => rows.map(r => +r.dataItem[field] || 0).reduce((a, b) => a + b, 0);

          footer.dataItem = {
            misgubun: "합계",
            unitcost: getSum('unitcost'),
            supplycost: getSum('supplycost'),
            taxtotal: getSum('taxtotal'),
            qty: getSum('qty'),
          };
        });

        //입출금 내역
        this.grid4 = new wijmo.grid.FlexGrid('#TransactionHistoryGrid', {
          autoGenerateColumns: false,
          selectionMode: wijmo.grid.SelectionMode.Row,
          headersVisibility: wijmo.grid.HeadersVisibility.Column,
          isReadOnly: true,
          showMarquee: true,
          formatItem: (sender, e) => {
            if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
              e.cell.style.textAlign = 'center';
            }
          },
          columns: [
            {binding: 'trdate', header: '일자', width: 110},
            {binding: 'comp_name', header: '거래처', width: 100 },
            {binding: 'io_type', header: '입출금 구분', width: 100,align: 'center'},
            {binding: 'amount', header: '금액', width: 130},
            {binding: 'memo', header: '메모', width: 250},
          ],
          itemsSource: this.viewData, // 데이터를 설정할 배열
        });

        new FlexGridContextMenu(this.grid4);
        this.grid4.downloadFileName = '입출금 내역';

        /*//Footer 패널 사용 설정
        this.grid4.columnFooters.rows.push(new wijmo.grid.Row());
        this.grid4.loadedRows.addHandler(() => {
          const rows = this.grid4.rows;
          const footer = this.grid4.columnFooters.rows[0];

          const getSum = (field) => rows.map(r => +r.dataItem[field] || 0).reduce((a, b) => a + b, 0);

          footer.dataItem = {
            trdate: "합계",
            amount:getSum('amount')
          };
        });
*/
      }//init

      searchMainData() {
        let _this = this;
        let url = '/api/transaction/ProjectStatus'

        let data = {
          'txtProjectName': $("#txtProjectName").val(),
          spjangcd: this.spjangcd.val()  //사업장 코드
        }
        let fnsuccess = function (result) {
          if (result != null) {
            _this.viewData = new wijmo.collections.CollectionView(result.data);
            _this.grid.itemsSource = _this.viewData;
          }
        };
        AjaxUtil.getAsyncData(url + '/allRead', data, fnsuccess);
      }

      //탭 요청
      loadTabData(selectedItem) {
        let _this = this;
        const projno = selectedItem.projno;
        const url = '/api/transaction/ProjectStatus';
        const data = {
          projno: projno ,
          spjangcd: this.spjangcd.val()
        };

        // 1. 경비사용내역
        AjaxUtil.getAsyncData(url + '/ExpenseHistory', data, function(result) {
          if (result != null) {
            _this.grid2.itemsSource = result.data;
          }
        });

        // 2. 매출내역
        AjaxUtil.getAsyncData(url + '/SalesHistory', data, function(result) {
          if (result != null) {
            _this.grid3.itemsSource = result.data;
          }
        });

        // 3. 입출금내역
        AjaxUtil.getAsyncData(url + '/TransactionHistory', data, function(result) {
          if (result != null) {
            _this.grid4.itemsSource = result.data;
          }
        });

        // 탭 자동 전환: 첫 번째 탭 열기
        document.querySelector('.tab-links li:first-child a').click();
      }



    }

    $(document).ready(function (e) {

      const spjangcd = sessionStorage.getItem('spjangcd');
      if (spjangcd) {
        $('#spjangcdHidden').val(spjangcd);  // hidden input이 있어야 함
      }

      page = new ProjectStatusPage();

      AjaxUtil.fillSelectOptions($('#cboYear'), 'data_year', '', false);
      AjaxUtil.fillSelectOptions($('#cboDepositType'), 'system_code', 'all', false, 'deposit_type', '');

      let today = new Date();
      let monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
      //let monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);// 이번 달 마지막 날

      $('#srchStartDt').val(CommonUtil.formatYYYYMMDD(monthStart));
      $('#srchEndDt').val(CommonUtil.formatYYYYMMDD(today));

      //공사일자 및 계약일자도 오늘 날짜로 설정
      function formatToDashYMD(date) {
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
      }

      const todayStr = formatToDashYMD(today);
      $('#stdate').val(todayStr);
      $('#eddate').val(todayStr);
      $('#contdate').val(todayStr);

      page.searchMainData();

      // 검색
      $('#btnSearch').click(function (e) {
        e.preventDefault();
        page.searchMainData();
      });

      //저장
      $('#btnSave').click(function (e) {
        e.preventDefault();
        page.saveMainData();
      });

      //삭제
      $('#btnDelete').click(function (e) {
        e.preventDefault();
        page.DeleteMainData();
      });

      $('#Newbtn').click(function (e) {
        e.preventDefault();
        $('#CategoryForm')[0].reset();
        $('#balcltcd').val('');

        const today = new Date();
        const todayStr = formatToDashYMD(today);

        $('#stdate').val(todayStr);
        $('#eddate').val(todayStr);
        $('#contdate').val(todayStr);
      });

      // 값이 사라지면 hidden도 비움
      $('#btnCompanySearch').on('input', function () {
        const val = $(this).val();
        if (val === '') {
          $('#cboCompanyHidden').val('');
        }
      });
      $('#balcltnm').click(function () {
        const poppage = new PopCompComponent();
        const $poppage = $(poppage);
        const searchcallback = function (items) {
          $('#balcltnm').val(items.compname);
          $('#balcltcd').val(items.id);
        };
        poppage.show(searchcallback);
      });

      $('#balcltnm').on('input', function () {
        if ($(this).val().trim() === '') {
          $('#balcltcd').val('');
        }
      });
    })

  </script>
</th:block>
</html>
